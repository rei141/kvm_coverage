<doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
<style>
    code{
        font-family:Monaco, Menlo, Consolas, 'Courier New', Courier, monospace, sans-serif;
        font-size: 14px;
        line-height: 18px;
        overflow: auto;
        resize: horizontal;
    }
    code_line{
        font-family: Monaco, Menlo, Consolas, 'Courier New', Courier, monospace, sans-serif;;
        font-size: 14px;
        line-height: 18px;
        overflow: auto;
        resize: horizontal;
        color:#303134;
    }
    blue{
        background-color:#BEEDE8;
    }
    yellow{
        background-color:#FFFF99;
    }
    red{
        background-color:#FF99AC;
    }
</style>

</head>
<body>
<table summary='blob content' class='blob' cellspacing="15">
<tr><td align="right"><pre><code_line>1.<br>2.<br>3.<br>4.<br>5.<br>6.<br>7.<br>8.<br>9.<br>10.<br>11.<br>12.<br>13.<br>14.<br>15.<br>16.<br>17.<br>18.<br>19.<br>20.<br>21.<br>22.<br>23.<br>24.<br>25.<br>26.<br>27.<br>28.<br>29.<br>30.<br>31.<br>32.<br>33.<br>34.<br>35.<br>36.<br>37.<br>38.<br>39.<br>40.<br>41.<br>42.<br>43.<br>44.<br>45.<br>46.<br>47.<br>48.<br>49.<br>50.<br>51.<br>52.<br>53.<br>54.<br>55.<br>56.<br>57.<br>58.<br>59.<br>60.<br>61.<br>62.<br>63.<br>64.<br>65.<br>66.<br>67.<br>68.<br>69.<br>70.<br>71.<br>72.<br>73.<br>74.<br>75.<br>76.<br>77.<br>78.<br>79.<br>80.<br>81.<br>82.<br>83.<br>84.<br>85.<br>86.<br>87.<br>88.<br>89.<br>90.<br>91.<br>92.<br>93.<br>94.<br>95.<br>96.<br>97.<br>98.<br>99.<br>100.<br>101.<br>102.<br>103.<br>104.<br>105.<br>106.<br>107.<br>108.<br>109.<br>110.<br>111.<br>112.<br>113.<br>114.<br>115.<br>116.<br>117.<br>118.<br>119.<br>120.<br>121.<br>122.<br>123.<br>124.<br>125.<br>126.<br>127.<br>128.<br>129.<br>130.<br>131.<br>132.<br>133.<br>134.<br>135.<br>136.<br>137.<br>138.<br>139.<br>140.<br>141.<br>142.<br>143.<br>144.<br>145.<br>146.<br>147.<br>148.<br>149.<br>150.<br>151.<br>152.<br>153.<br>154.<br>155.<br>156.<br>157.<br>158.<br>159.<br>160.<br>161.<br>162.<br>163.<br>164.<br>165.<br>166.<br>167.<br>168.<br>169.<br>170.<br>171.<br>172.<br>173.<br>174.<br>175.<br>176.<br>177.<br>178.<br>179.<br>180.<br>181.<br>182.<br>183.<br>184.<br>185.<br>186.<br>187.<br>188.<br>189.<br>190.<br>191.<br>192.<br>193.<br>194.<br>195.<br>196.<br>197.<br>198.<br>199.<br>200.<br>201.<br>202.<br>203.<br>204.<br>205.<br>206.<br>207.<br>208.<br>209.<br>210.<br>211.<br>212.<br>213.<br>214.<br>215.<br>216.<br>217.<br>218.<br>219.<br>220.<br>221.<br>222.<br>223.<br>224.<br>225.<br>226.<br>227.<br>228.<br>229.<br>230.<br>231.<br>232.<br>233.<br>234.<br>235.<br>236.<br>237.<br>238.<br>239.<br>240.<br>241.<br>242.<br>243.<br>244.<br>245.<br>246.<br>247.<br>248.<br>249.<br>250.<br>251.<br>252.<br>253.<br>254.<br>255.<br>256.<br>257.<br>258.<br>259.<br>260.<br>261.<br>262.<br>263.<br>264.<br>265.<br>266.<br>267.<br>268.<br>269.<br>270.<br>271.<br>272.<br>273.<br>274.<br>275.<br>276.<br>277.<br>278.<br>279.<br>280.<br>281.<br>282.<br>283.<br>284.<br>285.<br>286.<br>287.<br>288.<br>289.<br>290.<br>291.<br>292.<br>293.<br>294.<br>295.<br>296.<br>297.<br>298.<br>299.<br>300.<br>301.<br>302.<br>303.<br>304.<br>305.<br>306.<br>307.<br>308.<br>309.<br>310.<br>311.<br>312.<br>313.<br>314.<br>315.<br>316.<br>317.<br>318.<br>319.<br>320.<br>321.<br>322.<br>323.<br>324.<br>325.<br>326.<br>327.<br>328.<br>329.<br>330.<br>331.<br>332.<br>333.<br>334.<br>335.<br>336.<br>337.<br>338.<br>339.<br>340.<br>341.<br>342.<br>343.<br>344.<br>345.<br>346.<br>347.<br>348.<br>349.<br>350.<br>351.<br>352.<br>353.<br>354.<br>355.<br>356.<br>357.<br>358.<br>359.<br>360.<br>361.<br>362.<br>363.<br>364.<br>365.<br>366.<br>367.<br>368.<br>369.<br>370.<br>371.<br>372.<br>373.<br>374.<br>375.<br>376.<br>377.<br>378.<br>379.<br>380.<br>381.<br>382.<br>383.<br>384.<br>385.<br>386.<br>387.<br>388.<br>389.<br>390.<br>391.<br>392.<br>393.<br>394.<br>395.<br>396.<br>397.<br>398.<br>399.<br>400.<br>401.<br>402.<br>403.<br>404.<br>405.<br>406.<br>407.<br>408.<br>409.<br>410.<br>411.<br>412.<br>413.<br>414.<br>415.<br>416.<br>417.<br>418.<br>419.<br>420.<br>421.<br>422.<br>423.<br>424.<br>425.<br>426.<br>427.<br>428.<br>429.<br>430.<br>431.<br>432.<br>433.<br>434.<br>435.<br>436.<br>437.<br>438.<br>439.<br>440.<br>441.<br>442.<br>443.<br>444.<br>445.<br>446.<br>447.<br>448.<br>449.<br>450.<br>451.<br>452.<br></code_line></pre></td>
<td class='lines'><pre><code class="prettyprint">/* SPDX-License-Identifier: GPL-2.0 */
#if !defined(_TRACE_KVMMMU_H) || defined(TRACE_HEADER_MULTI_READ)
#define _TRACE_KVMMMU_H

#include &lt;linux/tracepoint.h&gt;
#include &lt;linux/trace_events.h&gt;

#undef TRACE_SYSTEM
#define TRACE_SYSTEM kvmmmu

#define KVM_MMU_PAGE_FIELDS		\
	__field(__u8, mmu_valid_gen)	\
	__field(__u64, gfn)		\
	__field(__u32, role)		\
	__field(__u32, root_count)	\
	__field(bool, unsync)

#define KVM_MMU_PAGE_ASSIGN(sp)				\
	__entry-&gt;mmu_valid_gen = sp-&gt;mmu_valid_gen;	\
	__entry-&gt;gfn = sp-&gt;gfn;				\
	__entry-&gt;role = sp-&gt;role.word;			\
	__entry-&gt;root_count = sp-&gt;root_count;		\
	__entry-&gt;unsync = sp-&gt;unsync;

#define KVM_MMU_PAGE_PRINTK() ({				        \
	const char *saved_ptr = trace_seq_buffer_ptr(p);		\
	static const char *access_str[] = {			        \
		&quot;---&quot;, &quot;--x&quot;, &quot;w--&quot;, &quot;w-x&quot;, &quot;-u-&quot;, &quot;-ux&quot;, &quot;wu-&quot;, &quot;wux&quot;  \
	};							        \
	union kvm_mmu_page_role role;				        \
								        \
	role.word = __entry-&gt;role;					\
									\
	trace_seq_printf(p, &quot;sp gen %u gfn %llx l%u %u-byte q%u%s %s%s&quot;	\
			 &quot; %snxe %sad root %u %s%c&quot;,			\
			 __entry-&gt;mmu_valid_gen,			\
			 __entry-&gt;gfn, role.level,			\
			 role.has_4_byte_gpte ? 4 : 8,			\
			 role.quadrant,					\
			 role.direct ? &quot; direct&quot; : &quot;&quot;,			\
			 access_str[role.access],			\
			 role.invalid ? &quot; invalid&quot; : &quot;&quot;,		\
			 role.efer_nx ? &quot;&quot; : &quot;!&quot;,			\
			 role.ad_disabled ? &quot;!&quot; : &quot;&quot;,			\
			 __entry-&gt;root_count,				\
			 __entry-&gt;unsync ? &quot;unsync&quot; : &quot;sync&quot;, 0);	\
	saved_ptr;							\
		})

#define kvm_mmu_trace_pferr_flags       \
	{ PFERR_PRESENT_MASK, &quot;P&quot; },	\
	{ PFERR_WRITE_MASK, &quot;W&quot; },	\
	{ PFERR_USER_MASK, &quot;U&quot; },	\
	{ PFERR_RSVD_MASK, &quot;RSVD&quot; },	\
	{ PFERR_FETCH_MASK, &quot;F&quot; }

TRACE_DEFINE_ENUM(RET_PF_CONTINUE);
TRACE_DEFINE_ENUM(RET_PF_RETRY);
TRACE_DEFINE_ENUM(RET_PF_EMULATE);
TRACE_DEFINE_ENUM(RET_PF_INVALID);
TRACE_DEFINE_ENUM(RET_PF_FIXED);
TRACE_DEFINE_ENUM(RET_PF_SPURIOUS);

/*
 * A pagetable walk has started
 */
<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_pagetable_walk,
	TP_PROTO(u64 addr, u32 pferr),
	TP_ARGS(addr, pferr),

	TP_STRUCT__entry(
		__field(__u64, addr)
		__field(__u32, pferr)
	),

	TP_fast_assign(
		__entry-&gt;addr = addr;
		__entry-&gt;pferr = pferr;
	),

	TP_printk(&quot;addr %llx pferr %x %s&quot;, __entry-&gt;addr, __entry-&gt;pferr,
		  __print_flags(__entry-&gt;pferr, &quot;|&quot;, kvm_mmu_trace_pferr_flags))
);


/* We just walked a paging element */
<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_paging_element,
	TP_PROTO(u64 pte, int level),
	TP_ARGS(pte, level),

	TP_STRUCT__entry(
		__field(__u64, pte)
		__field(__u32, level)
		),

	TP_fast_assign(
		__entry-&gt;pte = pte;
		__entry-&gt;level = level;
		),

	TP_printk(&quot;pte %llx level %u&quot;, __entry-&gt;pte, __entry-&gt;level)
);

<yellow>DECLARE_EVENT_CLASS(kvm_mmu_set_bit_class,</yellow>

	TP_PROTO(unsigned long table_gfn, unsigned index, unsigned size),

	TP_ARGS(table_gfn, index, size),

	TP_STRUCT__entry(
		__field(__u64, gpa)
	),

	TP_fast_assign(
		__entry-&gt;gpa = ((u64)table_gfn &lt;&lt; PAGE_SHIFT)
				+ index * size;
		),

	TP_printk(&quot;gpa %llx&quot;, __entry-&gt;gpa)
);

/* We set a pte accessed bit */
<blue>DEFINE_EVENT(kvm_mmu_set_bit_class, kvm_mmu_set_accessed_bit,</blue>

	TP_PROTO(unsigned long table_gfn, unsigned index, unsigned size),

	TP_ARGS(table_gfn, index, size)
);

/* We set a pte dirty bit */
<blue>DEFINE_EVENT(kvm_mmu_set_bit_class, kvm_mmu_set_dirty_bit,</blue>

	TP_PROTO(unsigned long table_gfn, unsigned index, unsigned size),

	TP_ARGS(table_gfn, index, size)
);

<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_walker_error,
	TP_PROTO(u32 pferr),
	TP_ARGS(pferr),

	TP_STRUCT__entry(
		__field(__u32, pferr)
		),

	TP_fast_assign(
		__entry-&gt;pferr = pferr;
		),

	TP_printk(&quot;pferr %x %s&quot;, __entry-&gt;pferr,
		  __print_flags(__entry-&gt;pferr, &quot;|&quot;, kvm_mmu_trace_pferr_flags))
);

<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_get_page,
	TP_PROTO(struct kvm_mmu_page *sp, bool created),
	TP_ARGS(sp, created),

	TP_STRUCT__entry(
		KVM_MMU_PAGE_FIELDS
		__field(bool, created)
		),

	TP_fast_assign(
		KVM_MMU_PAGE_ASSIGN(sp)
		__entry-&gt;created = created;
		),

	TP_printk(&quot;%s %s&quot;, KVM_MMU_PAGE_PRINTK(),
		  __entry-&gt;created ? &quot;new&quot; : &quot;existing&quot;)
);

<yellow>DECLARE_EVENT_CLASS(kvm_mmu_page_class,</yellow>

	TP_PROTO(struct kvm_mmu_page *sp),
	TP_ARGS(sp),

	TP_STRUCT__entry(
		KVM_MMU_PAGE_FIELDS
	),

	TP_fast_assign(
		KVM_MMU_PAGE_ASSIGN(sp)
	),

	TP_printk(&quot;%s&quot;, KVM_MMU_PAGE_PRINTK())
);

<yellow>DEFINE_EVENT(kvm_mmu_page_class, kvm_mmu_sync_page,</yellow>
	TP_PROTO(struct kvm_mmu_page *sp),

	TP_ARGS(sp)
);

<yellow>DEFINE_EVENT(kvm_mmu_page_class, kvm_mmu_unsync_page,</yellow>
	TP_PROTO(struct kvm_mmu_page *sp),

	TP_ARGS(sp)
);

<yellow>DEFINE_EVENT(kvm_mmu_page_class, kvm_mmu_prepare_zap_page,</yellow>
	TP_PROTO(struct kvm_mmu_page *sp),

	TP_ARGS(sp)
);

<yellow>TRACE_EVENT(</yellow>
	mark_mmio_spte,
	TP_PROTO(u64 *sptep, gfn_t gfn, u64 spte),
	TP_ARGS(sptep, gfn, spte),

	TP_STRUCT__entry(
		__field(void *, sptep)
		__field(gfn_t, gfn)
		__field(unsigned, access)
		__field(unsigned int, gen)
	),

	TP_fast_assign(
		__entry-&gt;sptep = sptep;
		__entry-&gt;gfn = gfn;
		__entry-&gt;access = spte &amp; ACC_ALL;
		__entry-&gt;gen = get_mmio_spte_generation(spte);
	),

	TP_printk(&quot;sptep:%p gfn %llx access %x gen %x&quot;, __entry-&gt;sptep,
		  __entry-&gt;gfn, __entry-&gt;access, __entry-&gt;gen)
);

<yellow>TRACE_EVENT(</yellow>
	handle_mmio_page_fault,
	TP_PROTO(u64 addr, gfn_t gfn, unsigned access),
	TP_ARGS(addr, gfn, access),

	TP_STRUCT__entry(
		__field(u64, addr)
		__field(gfn_t, gfn)
		__field(unsigned, access)
	),

	TP_fast_assign(
		__entry-&gt;addr = addr;
		__entry-&gt;gfn = gfn;
		__entry-&gt;access = access;
	),

	TP_printk(&quot;addr:%llx gfn %llx access %x&quot;, __entry-&gt;addr, __entry-&gt;gfn,
		  __entry-&gt;access)
);

<blue>TRACE_EVENT(</blue>
	fast_page_fault,
	TP_PROTO(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault,
		 u64 *sptep, u64 old_spte, int ret),
	TP_ARGS(vcpu, fault, sptep, old_spte, ret),

	TP_STRUCT__entry(
		__field(int, vcpu_id)
		__field(gpa_t, cr2_or_gpa)
		__field(u32, error_code)
		__field(u64 *, sptep)
		__field(u64, old_spte)
		__field(u64, new_spte)
		__field(int, ret)
	),

	TP_fast_assign(
		__entry-&gt;vcpu_id = vcpu-&gt;vcpu_id;
		__entry-&gt;cr2_or_gpa = fault-&gt;addr;
		__entry-&gt;error_code = fault-&gt;error_code;
		__entry-&gt;sptep = sptep;
		__entry-&gt;old_spte = old_spte;
		__entry-&gt;new_spte = *sptep;
		__entry-&gt;ret = ret;
	),

	TP_printk(&quot;vcpu %d gva %llx error_code %s sptep %p old %#llx&quot;
		  &quot; new %llx spurious %d fixed %d&quot;, __entry-&gt;vcpu_id,
		  __entry-&gt;cr2_or_gpa, __print_flags(__entry-&gt;error_code, &quot;|&quot;,
		  kvm_mmu_trace_pferr_flags), __entry-&gt;sptep,
		  __entry-&gt;old_spte, __entry-&gt;new_spte,
		  __entry-&gt;ret == RET_PF_SPURIOUS, __entry-&gt;ret == RET_PF_FIXED
	)
);

<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_zap_all_fast,
	TP_PROTO(struct kvm *kvm),
	TP_ARGS(kvm),

	TP_STRUCT__entry(
		__field(__u8, mmu_valid_gen)
		__field(unsigned int, mmu_used_pages)
	),

	TP_fast_assign(
		__entry-&gt;mmu_valid_gen = kvm-&gt;arch.mmu_valid_gen;
		__entry-&gt;mmu_used_pages = kvm-&gt;arch.n_used_mmu_pages;
	),

	TP_printk(&quot;kvm-mmu-valid-gen %u used_pages %x&quot;,
		  __entry-&gt;mmu_valid_gen, __entry-&gt;mmu_used_pages
	)
);


<yellow>TRACE_EVENT(</yellow>
	check_mmio_spte,
	TP_PROTO(u64 spte, unsigned int kvm_gen, unsigned int spte_gen),
	TP_ARGS(spte, kvm_gen, spte_gen),

	TP_STRUCT__entry(
		__field(unsigned int, kvm_gen)
		__field(unsigned int, spte_gen)
		__field(u64, spte)
	),

	TP_fast_assign(
		__entry-&gt;kvm_gen = kvm_gen;
		__entry-&gt;spte_gen = spte_gen;
		__entry-&gt;spte = spte;
	),

	TP_printk(&quot;spte %llx kvm_gen %x spte-gen %x valid %d&quot;, __entry-&gt;spte,
		  __entry-&gt;kvm_gen, __entry-&gt;spte_gen,
		  __entry-&gt;kvm_gen == __entry-&gt;spte_gen
	)
);

<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_set_spte,
	TP_PROTO(int level, gfn_t gfn, u64 *sptep),
	TP_ARGS(level, gfn, sptep),

	TP_STRUCT__entry(
		__field(u64, gfn)
		__field(u64, spte)
		__field(u64, sptep)
		__field(u8, level)
		/* These depend on page entry type, so compute them now.  */
		__field(bool, r)
		__field(bool, x)
		__field(signed char, u)
	),

	TP_fast_assign(
		__entry-&gt;gfn = gfn;
		__entry-&gt;spte = *sptep;
		__entry-&gt;sptep = virt_to_phys(sptep);
		__entry-&gt;level = level;
		__entry-&gt;r = shadow_present_mask || (__entry-&gt;spte &amp; PT_PRESENT_MASK);
		__entry-&gt;x = is_executable_pte(__entry-&gt;spte);
		__entry-&gt;u = shadow_user_mask ? !!(__entry-&gt;spte &amp; shadow_user_mask) : -1;
	),

	TP_printk(&quot;gfn %llx spte %llx (%s%s%s%s) level %d at %llx&quot;,
		  __entry-&gt;gfn, __entry-&gt;spte,
		  __entry-&gt;r ? &quot;r&quot; : &quot;-&quot;,
		  __entry-&gt;spte &amp; PT_WRITABLE_MASK ? &quot;w&quot; : &quot;-&quot;,
		  __entry-&gt;x ? &quot;x&quot; : &quot;-&quot;,
		  __entry-&gt;u == -1 ? &quot;&quot; : (__entry-&gt;u ? &quot;u&quot; : &quot;-&quot;),
		  __entry-&gt;level, __entry-&gt;sptep
	)
);

<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_spte_requested,
	TP_PROTO(struct kvm_page_fault *fault),
	TP_ARGS(fault),

	TP_STRUCT__entry(
		__field(u64, gfn)
		__field(u64, pfn)
		__field(u8, level)
	),

	TP_fast_assign(
		__entry-&gt;gfn = fault-&gt;gfn;
		__entry-&gt;pfn = fault-&gt;pfn | (fault-&gt;gfn &amp; (KVM_PAGES_PER_HPAGE(fault-&gt;goal_level) - 1));
		__entry-&gt;level = fault-&gt;goal_level;
	),

	TP_printk(&quot;gfn %llx pfn %llx level %d&quot;,
		  __entry-&gt;gfn, __entry-&gt;pfn, __entry-&gt;level
	)
);

<blue>TRACE_EVENT(</blue>
	kvm_tdp_mmu_spte_changed,
	TP_PROTO(int as_id, gfn_t gfn, int level, u64 old_spte, u64 new_spte),
	TP_ARGS(as_id, gfn, level, old_spte, new_spte),

	TP_STRUCT__entry(
		__field(u64, gfn)
		__field(u64, old_spte)
		__field(u64, new_spte)
		/* Level cannot be larger than 5 on x86, so it fits in a u8. */
		__field(u8, level)
		/* as_id can only be 0 or 1 x86, so it fits in a u8. */
		__field(u8, as_id)
	),

	TP_fast_assign(
		__entry-&gt;gfn = gfn;
		__entry-&gt;old_spte = old_spte;
		__entry-&gt;new_spte = new_spte;
		__entry-&gt;level = level;
		__entry-&gt;as_id = as_id;
	),

	TP_printk(&quot;as id %d gfn %llx level %d old_spte %llx new_spte %llx&quot;,
		  __entry-&gt;as_id, __entry-&gt;gfn, __entry-&gt;level,
		  __entry-&gt;old_spte, __entry-&gt;new_spte
	)
);

<yellow>TRACE_EVENT(</yellow>
	kvm_mmu_split_huge_page,
	TP_PROTO(u64 gfn, u64 spte, int level, int errno),
	TP_ARGS(gfn, spte, level, errno),

	TP_STRUCT__entry(
		__field(u64, gfn)
		__field(u64, spte)
		__field(int, level)
		__field(int, errno)
	),

	TP_fast_assign(
		__entry-&gt;gfn = gfn;
		__entry-&gt;spte = spte;
		__entry-&gt;level = level;
		__entry-&gt;errno = errno;
	),

	TP_printk(&quot;gfn %llx spte %llx level %d errno %d&quot;,
		  __entry-&gt;gfn, __entry-&gt;spte, __entry-&gt;level, __entry-&gt;errno)
);

#endif /* _TRACE_KVMMMU_H */

#undef TRACE_INCLUDE_PATH
#define TRACE_INCLUDE_PATH mmu
#undef TRACE_INCLUDE_FILE
#define TRACE_INCLUDE_FILE mmutrace

/* This part must be outside protection */
#include &lt;trace/define_trace.h&gt;


</code></pre></td></tr></table>
</body>
</html>
