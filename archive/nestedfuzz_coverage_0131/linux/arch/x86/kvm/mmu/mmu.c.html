<doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
<style>
    code{
        font-family:Monaco, Menlo, Consolas, 'Courier New', Courier, monospace, sans-serif;
        font-size: 14px;
        line-height: 18px;
        overflow: auto;
        resize: horizontal;
    }
    code_line{
        font-family: Monaco, Menlo, Consolas, 'Courier New', Courier, monospace, sans-serif;;
        font-size: 14px;
        line-height: 18px;
        overflow: auto;
        resize: horizontal;
        color:#303134;
    }
    blue{
        background-color:#BEEDE8;
    }
    yellow{
        background-color:#FFFF99;
    }
    red{
        background-color:#FF99AC;
    }
</style>

</head>
<body>
<table summary='blob content' class='blob' cellspacing="15">
<tr><td align="right"><pre><code_line>1.
2.
3.
4.
5.
6.
7.
8.
9.
10.
11.
12.
13.
14.
15.
16.
17.
18.
19.
20.
21.
22.
23.
24.
25.
26.
27.
28.
29.
30.
31.
32.
33.
34.
35.
36.
37.
38.
39.
40.
41.
42.
43.
44.
45.
46.
47.
48.
49.
50.
51.
52.
53.
54.
55.
56.
57.
58.
59.
60.
61.
62.
63.
64.
65.
66.
67.
68.
69.
70.
71.
72.
73.
74.
75.
76.
77.
78.
79.
80.
81.
82.
83.
84.
85.
86.
87.
88.
89.
90.
91.
92.
93.
94.
95.
96.
97.
98.
99.
100.
101.
102.
103.
104.
105.
106.
107.
108.
109.
110.
111.
112.
113.
114.
115.
116.
117.
118.
119.
120.
121.
122.
123.
124.
125.
126.
127.
128.
129.
130.
131.
132.
133.
134.
135.
136.
137.
138.
139.
140.
141.
142.
143.
144.
145.
146.
147.
148.
149.
150.
151.
152.
153.
154.
155.
156.
157.
158.
159.
160.
161.
162.
163.
164.
165.
166.
167.
168.
169.
170.
171.
172.
173.
174.
175.
176.
177.
178.
179.
180.
181.
182.
183.
184.
185.
186.
187.
188.
189.
190.
191.
192.
193.
194.
195.
196.
197.
198.
199.
200.
201.
202.
203.
204.
205.
206.
207.
208.
209.
210.
211.
212.
213.
214.
215.
216.
217.
218.
219.
220.
221.
222.
223.
224.
225.
226.
227.
228.
229.
230.
231.
232.
233.
234.
235.
236.
237.
238.
239.
240.
241.
242.
243.
244.
245.
246.
247.
248.
249.
250.
251.
252.
253.
254.
255.
256.
257.
258.
259.
260.
261.
262.
263.
264.
265.
266.
267.
268.
269.
270.
271.
272.
273.
274.
275.
276.
277.
278.
279.
280.
281.
282.
283.
284.
285.
286.
287.
288.
289.
290.
291.
292.
293.
294.
295.
296.
297.
298.
299.
300.
301.
302.
303.
304.
305.
306.
307.
308.
309.
310.
311.
312.
313.
314.
315.
316.
317.
318.
319.
320.
321.
322.
323.
324.
325.
326.
327.
328.
329.
330.
331.
332.
333.
334.
335.
336.
337.
338.
339.
340.
341.
342.
343.
344.
345.
346.
347.
348.
349.
350.
351.
352.
353.
354.
355.
356.
357.
358.
359.
360.
361.
362.
363.
364.
365.
366.
367.
368.
369.
370.
371.
372.
373.
374.
375.
376.
377.
378.
379.
380.
381.
382.
383.
384.
385.
386.
387.
388.
389.
390.
391.
392.
393.
394.
395.
396.
397.
398.
399.
400.
401.
402.
403.
404.
405.
406.
407.
408.
409.
410.
411.
412.
413.
414.
415.
416.
417.
418.
419.
420.
421.
422.
423.
424.
425.
426.
427.
428.
429.
430.
431.
432.
433.
434.
435.
436.
437.
438.
439.
440.
441.
442.
443.
444.
445.
446.
447.
448.
449.
450.
451.
452.
453.
454.
455.
456.
457.
458.
459.
460.
461.
462.
463.
464.
465.
466.
467.
468.
469.
470.
471.
472.
473.
474.
475.
476.
477.
478.
479.
480.
481.
482.
483.
484.
485.
486.
487.
488.
489.
490.
491.
492.
493.
494.
495.
496.
497.
498.
499.
500.
501.
502.
503.
504.
505.
506.
507.
508.
509.
510.
511.
512.
513.
514.
515.
516.
517.
518.
519.
520.
521.
522.
523.
524.
525.
526.
527.
528.
529.
530.
531.
532.
533.
534.
535.
536.
537.
538.
539.
540.
541.
542.
543.
544.
545.
546.
547.
548.
549.
550.
551.
552.
553.
554.
555.
556.
557.
558.
559.
560.
561.
562.
563.
564.
565.
566.
567.
568.
569.
570.
571.
572.
573.
574.
575.
576.
577.
578.
579.
580.
581.
582.
583.
584.
585.
586.
587.
588.
589.
590.
591.
592.
593.
594.
595.
596.
597.
598.
599.
600.
601.
602.
603.
604.
605.
606.
607.
608.
609.
610.
611.
612.
613.
614.
615.
616.
617.
618.
619.
620.
621.
622.
623.
624.
625.
626.
627.
628.
629.
630.
631.
632.
633.
634.
635.
636.
637.
638.
639.
640.
641.
642.
643.
644.
645.
646.
647.
648.
649.
650.
651.
652.
653.
654.
655.
656.
657.
658.
659.
660.
661.
662.
663.
664.
665.
666.
667.
668.
669.
670.
671.
672.
673.
674.
675.
676.
677.
678.
679.
680.
681.
682.
683.
684.
685.
686.
687.
688.
689.
690.
691.
692.
693.
694.
695.
696.
697.
698.
699.
700.
701.
702.
703.
704.
705.
706.
707.
708.
709.
710.
711.
712.
713.
714.
715.
716.
717.
718.
719.
720.
721.
722.
723.
724.
725.
726.
727.
728.
729.
730.
731.
732.
733.
734.
735.
736.
737.
738.
739.
740.
741.
742.
743.
744.
745.
746.
747.
748.
749.
750.
751.
752.
753.
754.
755.
756.
757.
758.
759.
760.
761.
762.
763.
764.
765.
766.
767.
768.
769.
770.
771.
772.
773.
774.
775.
776.
777.
778.
779.
780.
781.
782.
783.
784.
785.
786.
787.
788.
789.
790.
791.
792.
793.
794.
795.
796.
797.
798.
799.
800.
801.
802.
803.
804.
805.
806.
807.
808.
809.
810.
811.
812.
813.
814.
815.
816.
817.
818.
819.
820.
821.
822.
823.
824.
825.
826.
827.
828.
829.
830.
831.
832.
833.
834.
835.
836.
837.
838.
839.
840.
841.
842.
843.
844.
845.
846.
847.
848.
849.
850.
851.
852.
853.
854.
855.
856.
857.
858.
859.
860.
861.
862.
863.
864.
865.
866.
867.
868.
869.
870.
871.
872.
873.
874.
875.
876.
877.
878.
879.
880.
881.
882.
883.
884.
885.
886.
887.
888.
889.
890.
891.
892.
893.
894.
895.
896.
897.
898.
899.
900.
901.
902.
903.
904.
905.
906.
907.
908.
909.
910.
911.
912.
913.
914.
915.
916.
917.
918.
919.
920.
921.
922.
923.
924.
925.
926.
927.
928.
929.
930.
931.
932.
933.
934.
935.
936.
937.
938.
939.
940.
941.
942.
943.
944.
945.
946.
947.
948.
949.
950.
951.
952.
953.
954.
955.
956.
957.
958.
959.
960.
961.
962.
963.
964.
965.
966.
967.
968.
969.
970.
971.
972.
973.
974.
975.
976.
977.
978.
979.
980.
981.
982.
983.
984.
985.
986.
987.
988.
989.
990.
991.
992.
993.
994.
995.
996.
997.
998.
999.
1000.
1001.
1002.
1003.
1004.
1005.
1006.
1007.
1008.
1009.
1010.
1011.
1012.
1013.
1014.
1015.
1016.
1017.
1018.
1019.
1020.
1021.
1022.
1023.
1024.
1025.
1026.
1027.
1028.
1029.
1030.
1031.
1032.
1033.
1034.
1035.
1036.
1037.
1038.
1039.
1040.
1041.
1042.
1043.
1044.
1045.
1046.
1047.
1048.
1049.
1050.
1051.
1052.
1053.
1054.
1055.
1056.
1057.
1058.
1059.
1060.
1061.
1062.
1063.
1064.
1065.
1066.
1067.
1068.
1069.
1070.
1071.
1072.
1073.
1074.
1075.
1076.
1077.
1078.
1079.
1080.
1081.
1082.
1083.
1084.
1085.
1086.
1087.
1088.
1089.
1090.
1091.
1092.
1093.
1094.
1095.
1096.
1097.
1098.
1099.
1100.
1101.
1102.
1103.
1104.
1105.
1106.
1107.
1108.
1109.
1110.
1111.
1112.
1113.
1114.
1115.
1116.
1117.
1118.
1119.
1120.
1121.
1122.
1123.
1124.
1125.
1126.
1127.
1128.
1129.
1130.
1131.
1132.
1133.
1134.
1135.
1136.
1137.
1138.
1139.
1140.
1141.
1142.
1143.
1144.
1145.
1146.
1147.
1148.
1149.
1150.
1151.
1152.
1153.
1154.
1155.
1156.
1157.
1158.
1159.
1160.
1161.
1162.
1163.
1164.
1165.
1166.
1167.
1168.
1169.
1170.
1171.
1172.
1173.
1174.
1175.
1176.
1177.
1178.
1179.
1180.
1181.
1182.
1183.
1184.
1185.
1186.
1187.
1188.
1189.
1190.
1191.
1192.
1193.
1194.
1195.
1196.
1197.
1198.
1199.
1200.
1201.
1202.
1203.
1204.
1205.
1206.
1207.
1208.
1209.
1210.
1211.
1212.
1213.
1214.
1215.
1216.
1217.
1218.
1219.
1220.
1221.
1222.
1223.
1224.
1225.
1226.
1227.
1228.
1229.
1230.
1231.
1232.
1233.
1234.
1235.
1236.
1237.
1238.
1239.
1240.
1241.
1242.
1243.
1244.
1245.
1246.
1247.
1248.
1249.
1250.
1251.
1252.
1253.
1254.
1255.
1256.
1257.
1258.
1259.
1260.
1261.
1262.
1263.
1264.
1265.
1266.
1267.
1268.
1269.
1270.
1271.
1272.
1273.
1274.
1275.
1276.
1277.
1278.
1279.
1280.
1281.
1282.
1283.
1284.
1285.
1286.
1287.
1288.
1289.
1290.
1291.
1292.
1293.
1294.
1295.
1296.
1297.
1298.
1299.
1300.
1301.
1302.
1303.
1304.
1305.
1306.
1307.
1308.
1309.
1310.
1311.
1312.
1313.
1314.
1315.
1316.
1317.
1318.
1319.
1320.
1321.
1322.
1323.
1324.
1325.
1326.
1327.
1328.
1329.
1330.
1331.
1332.
1333.
1334.
1335.
1336.
1337.
1338.
1339.
1340.
1341.
1342.
1343.
1344.
1345.
1346.
1347.
1348.
1349.
1350.
1351.
1352.
1353.
1354.
1355.
1356.
1357.
1358.
1359.
1360.
1361.
1362.
1363.
1364.
1365.
1366.
1367.
1368.
1369.
1370.
1371.
1372.
1373.
1374.
1375.
1376.
1377.
1378.
1379.
1380.
1381.
1382.
1383.
1384.
1385.
1386.
1387.
1388.
1389.
1390.
1391.
1392.
1393.
1394.
1395.
1396.
1397.
1398.
1399.
1400.
1401.
1402.
1403.
1404.
1405.
1406.
1407.
1408.
1409.
1410.
1411.
1412.
1413.
1414.
1415.
1416.
1417.
1418.
1419.
1420.
1421.
1422.
1423.
1424.
1425.
1426.
1427.
1428.
1429.
1430.
1431.
1432.
1433.
1434.
1435.
1436.
1437.
1438.
1439.
1440.
1441.
1442.
1443.
1444.
1445.
1446.
1447.
1448.
1449.
1450.
1451.
1452.
1453.
1454.
1455.
1456.
1457.
1458.
1459.
1460.
1461.
1462.
1463.
1464.
1465.
1466.
1467.
1468.
1469.
1470.
1471.
1472.
1473.
1474.
1475.
1476.
1477.
1478.
1479.
1480.
1481.
1482.
1483.
1484.
1485.
1486.
1487.
1488.
1489.
1490.
1491.
1492.
1493.
1494.
1495.
1496.
1497.
1498.
1499.
1500.
1501.
1502.
1503.
1504.
1505.
1506.
1507.
1508.
1509.
1510.
1511.
1512.
1513.
1514.
1515.
1516.
1517.
1518.
1519.
1520.
1521.
1522.
1523.
1524.
1525.
1526.
1527.
1528.
1529.
1530.
1531.
1532.
1533.
1534.
1535.
1536.
1537.
1538.
1539.
1540.
1541.
1542.
1543.
1544.
1545.
1546.
1547.
1548.
1549.
1550.
1551.
1552.
1553.
1554.
1555.
1556.
1557.
1558.
1559.
1560.
1561.
1562.
1563.
1564.
1565.
1566.
1567.
1568.
1569.
1570.
1571.
1572.
1573.
1574.
1575.
1576.
1577.
1578.
1579.
1580.
1581.
1582.
1583.
1584.
1585.
1586.
1587.
1588.
1589.
1590.
1591.
1592.
1593.
1594.
1595.
1596.
1597.
1598.
1599.
1600.
1601.
1602.
1603.
1604.
1605.
1606.
1607.
1608.
1609.
1610.
1611.
1612.
1613.
1614.
1615.
1616.
1617.
1618.
1619.
1620.
1621.
1622.
1623.
1624.
1625.
1626.
1627.
1628.
1629.
1630.
1631.
1632.
1633.
1634.
1635.
1636.
1637.
1638.
1639.
1640.
1641.
1642.
1643.
1644.
1645.
1646.
1647.
1648.
1649.
1650.
1651.
1652.
1653.
1654.
1655.
1656.
1657.
1658.
1659.
1660.
1661.
1662.
1663.
1664.
1665.
1666.
1667.
1668.
1669.
1670.
1671.
1672.
1673.
1674.
1675.
1676.
1677.
1678.
1679.
1680.
1681.
1682.
1683.
1684.
1685.
1686.
1687.
1688.
1689.
1690.
1691.
1692.
1693.
1694.
1695.
1696.
1697.
1698.
1699.
1700.
1701.
1702.
1703.
1704.
1705.
1706.
1707.
1708.
1709.
1710.
1711.
1712.
1713.
1714.
1715.
1716.
1717.
1718.
1719.
1720.
1721.
1722.
1723.
1724.
1725.
1726.
1727.
1728.
1729.
1730.
1731.
1732.
1733.
1734.
1735.
1736.
1737.
1738.
1739.
1740.
1741.
1742.
1743.
1744.
1745.
1746.
1747.
1748.
1749.
1750.
1751.
1752.
1753.
1754.
1755.
1756.
1757.
1758.
1759.
1760.
1761.
1762.
1763.
1764.
1765.
1766.
1767.
1768.
1769.
1770.
1771.
1772.
1773.
1774.
1775.
1776.
1777.
1778.
1779.
1780.
1781.
1782.
1783.
1784.
1785.
1786.
1787.
1788.
1789.
1790.
1791.
1792.
1793.
1794.
1795.
1796.
1797.
1798.
1799.
1800.
1801.
1802.
1803.
1804.
1805.
1806.
1807.
1808.
1809.
1810.
1811.
1812.
1813.
1814.
1815.
1816.
1817.
1818.
1819.
1820.
1821.
1822.
1823.
1824.
1825.
1826.
1827.
1828.
1829.
1830.
1831.
1832.
1833.
1834.
1835.
1836.
1837.
1838.
1839.
1840.
1841.
1842.
1843.
1844.
1845.
1846.
1847.
1848.
1849.
1850.
1851.
1852.
1853.
1854.
1855.
1856.
1857.
1858.
1859.
1860.
1861.
1862.
1863.
1864.
1865.
1866.
1867.
1868.
1869.
1870.
1871.
1872.
1873.
1874.
1875.
1876.
1877.
1878.
1879.
1880.
1881.
1882.
1883.
1884.
1885.
1886.
1887.
1888.
1889.
1890.
1891.
1892.
1893.
1894.
1895.
1896.
1897.
1898.
1899.
1900.
1901.
1902.
1903.
1904.
1905.
1906.
1907.
1908.
1909.
1910.
1911.
1912.
1913.
1914.
1915.
1916.
1917.
1918.
1919.
1920.
1921.
1922.
1923.
1924.
1925.
1926.
1927.
1928.
1929.
1930.
1931.
1932.
1933.
1934.
1935.
1936.
1937.
1938.
1939.
1940.
1941.
1942.
1943.
1944.
1945.
1946.
1947.
1948.
1949.
1950.
1951.
1952.
1953.
1954.
1955.
1956.
1957.
1958.
1959.
1960.
1961.
1962.
1963.
1964.
1965.
1966.
1967.
1968.
1969.
1970.
1971.
1972.
1973.
1974.
1975.
1976.
1977.
1978.
1979.
1980.
1981.
1982.
1983.
1984.
1985.
1986.
1987.
1988.
1989.
1990.
1991.
1992.
1993.
1994.
1995.
1996.
1997.
1998.
1999.
2000.
2001.
2002.
2003.
2004.
2005.
2006.
2007.
2008.
2009.
2010.
2011.
2012.
2013.
2014.
2015.
2016.
2017.
2018.
2019.
2020.
2021.
2022.
2023.
2024.
2025.
2026.
2027.
2028.
2029.
2030.
2031.
2032.
2033.
2034.
2035.
2036.
2037.
2038.
2039.
2040.
2041.
2042.
2043.
2044.
2045.
2046.
2047.
2048.
2049.
2050.
2051.
2052.
2053.
2054.
2055.
2056.
2057.
2058.
2059.
2060.
2061.
2062.
2063.
2064.
2065.
2066.
2067.
2068.
2069.
2070.
2071.
2072.
2073.
2074.
2075.
2076.
2077.
2078.
2079.
2080.
2081.
2082.
2083.
2084.
2085.
2086.
2087.
2088.
2089.
2090.
2091.
2092.
2093.
2094.
2095.
2096.
2097.
2098.
2099.
2100.
2101.
2102.
2103.
2104.
2105.
2106.
2107.
2108.
2109.
2110.
2111.
2112.
2113.
2114.
2115.
2116.
2117.
2118.
2119.
2120.
2121.
2122.
2123.
2124.
2125.
2126.
2127.
2128.
2129.
2130.
2131.
2132.
2133.
2134.
2135.
2136.
2137.
2138.
2139.
2140.
2141.
2142.
2143.
2144.
2145.
2146.
2147.
2148.
2149.
2150.
2151.
2152.
2153.
2154.
2155.
2156.
2157.
2158.
2159.
2160.
2161.
2162.
2163.
2164.
2165.
2166.
2167.
2168.
2169.
2170.
2171.
2172.
2173.
2174.
2175.
2176.
2177.
2178.
2179.
2180.
2181.
2182.
2183.
2184.
2185.
2186.
2187.
2188.
2189.
2190.
2191.
2192.
2193.
2194.
2195.
2196.
2197.
2198.
2199.
2200.
2201.
2202.
2203.
2204.
2205.
2206.
2207.
2208.
2209.
2210.
2211.
2212.
2213.
2214.
2215.
2216.
2217.
2218.
2219.
2220.
2221.
2222.
2223.
2224.
2225.
2226.
2227.
2228.
2229.
2230.
2231.
2232.
2233.
2234.
2235.
2236.
2237.
2238.
2239.
2240.
2241.
2242.
2243.
2244.
2245.
2246.
2247.
2248.
2249.
2250.
2251.
2252.
2253.
2254.
2255.
2256.
2257.
2258.
2259.
2260.
2261.
2262.
2263.
2264.
2265.
2266.
2267.
2268.
2269.
2270.
2271.
2272.
2273.
2274.
2275.
2276.
2277.
2278.
2279.
2280.
2281.
2282.
2283.
2284.
2285.
2286.
2287.
2288.
2289.
2290.
2291.
2292.
2293.
2294.
2295.
2296.
2297.
2298.
2299.
2300.
2301.
2302.
2303.
2304.
2305.
2306.
2307.
2308.
2309.
2310.
2311.
2312.
2313.
2314.
2315.
2316.
2317.
2318.
2319.
2320.
2321.
2322.
2323.
2324.
2325.
2326.
2327.
2328.
2329.
2330.
2331.
2332.
2333.
2334.
2335.
2336.
2337.
2338.
2339.
2340.
2341.
2342.
2343.
2344.
2345.
2346.
2347.
2348.
2349.
2350.
2351.
2352.
2353.
2354.
2355.
2356.
2357.
2358.
2359.
2360.
2361.
2362.
2363.
2364.
2365.
2366.
2367.
2368.
2369.
2370.
2371.
2372.
2373.
2374.
2375.
2376.
2377.
2378.
2379.
2380.
2381.
2382.
2383.
2384.
2385.
2386.
2387.
2388.
2389.
2390.
2391.
2392.
2393.
2394.
2395.
2396.
2397.
2398.
2399.
2400.
2401.
2402.
2403.
2404.
2405.
2406.
2407.
2408.
2409.
2410.
2411.
2412.
2413.
2414.
2415.
2416.
2417.
2418.
2419.
2420.
2421.
2422.
2423.
2424.
2425.
2426.
2427.
2428.
2429.
2430.
2431.
2432.
2433.
2434.
2435.
2436.
2437.
2438.
2439.
2440.
2441.
2442.
2443.
2444.
2445.
2446.
2447.
2448.
2449.
2450.
2451.
2452.
2453.
2454.
2455.
2456.
2457.
2458.
2459.
2460.
2461.
2462.
2463.
2464.
2465.
2466.
2467.
2468.
2469.
2470.
2471.
2472.
2473.
2474.
2475.
2476.
2477.
2478.
2479.
2480.
2481.
2482.
2483.
2484.
2485.
2486.
2487.
2488.
2489.
2490.
2491.
2492.
2493.
2494.
2495.
2496.
2497.
2498.
2499.
2500.
2501.
2502.
2503.
2504.
2505.
2506.
2507.
2508.
2509.
2510.
2511.
2512.
2513.
2514.
2515.
2516.
2517.
2518.
2519.
2520.
2521.
2522.
2523.
2524.
2525.
2526.
2527.
2528.
2529.
2530.
2531.
2532.
2533.
2534.
2535.
2536.
2537.
2538.
2539.
2540.
2541.
2542.
2543.
2544.
2545.
2546.
2547.
2548.
2549.
2550.
2551.
2552.
2553.
2554.
2555.
2556.
2557.
2558.
2559.
2560.
2561.
2562.
2563.
2564.
2565.
2566.
2567.
2568.
2569.
2570.
2571.
2572.
2573.
2574.
2575.
2576.
2577.
2578.
2579.
2580.
2581.
2582.
2583.
2584.
2585.
2586.
2587.
2588.
2589.
2590.
2591.
2592.
2593.
2594.
2595.
2596.
2597.
2598.
2599.
2600.
2601.
2602.
2603.
2604.
2605.
2606.
2607.
2608.
2609.
2610.
2611.
2612.
2613.
2614.
2615.
2616.
2617.
2618.
2619.
2620.
2621.
2622.
2623.
2624.
2625.
2626.
2627.
2628.
2629.
2630.
2631.
2632.
2633.
2634.
2635.
2636.
2637.
2638.
2639.
2640.
2641.
2642.
2643.
2644.
2645.
2646.
2647.
2648.
2649.
2650.
2651.
2652.
2653.
2654.
2655.
2656.
2657.
2658.
2659.
2660.
2661.
2662.
2663.
2664.
2665.
2666.
2667.
2668.
2669.
2670.
2671.
2672.
2673.
2674.
2675.
2676.
2677.
2678.
2679.
2680.
2681.
2682.
2683.
2684.
2685.
2686.
2687.
2688.
2689.
2690.
2691.
2692.
2693.
2694.
2695.
2696.
2697.
2698.
2699.
2700.
2701.
2702.
2703.
2704.
2705.
2706.
2707.
2708.
2709.
2710.
2711.
2712.
2713.
2714.
2715.
2716.
2717.
2718.
2719.
2720.
2721.
2722.
2723.
2724.
2725.
2726.
2727.
2728.
2729.
2730.
2731.
2732.
2733.
2734.
2735.
2736.
2737.
2738.
2739.
2740.
2741.
2742.
2743.
2744.
2745.
2746.
2747.
2748.
2749.
2750.
2751.
2752.
2753.
2754.
2755.
2756.
2757.
2758.
2759.
2760.
2761.
2762.
2763.
2764.
2765.
2766.
2767.
2768.
2769.
2770.
2771.
2772.
2773.
2774.
2775.
2776.
2777.
2778.
2779.
2780.
2781.
2782.
2783.
2784.
2785.
2786.
2787.
2788.
2789.
2790.
2791.
2792.
2793.
2794.
2795.
2796.
2797.
2798.
2799.
2800.
2801.
2802.
2803.
2804.
2805.
2806.
2807.
2808.
2809.
2810.
2811.
2812.
2813.
2814.
2815.
2816.
2817.
2818.
2819.
2820.
2821.
2822.
2823.
2824.
2825.
2826.
2827.
2828.
2829.
2830.
2831.
2832.
2833.
2834.
2835.
2836.
2837.
2838.
2839.
2840.
2841.
2842.
2843.
2844.
2845.
2846.
2847.
2848.
2849.
2850.
2851.
2852.
2853.
2854.
2855.
2856.
2857.
2858.
2859.
2860.
2861.
2862.
2863.
2864.
2865.
2866.
2867.
2868.
2869.
2870.
2871.
2872.
2873.
2874.
2875.
2876.
2877.
2878.
2879.
2880.
2881.
2882.
2883.
2884.
2885.
2886.
2887.
2888.
2889.
2890.
2891.
2892.
2893.
2894.
2895.
2896.
2897.
2898.
2899.
2900.
2901.
2902.
2903.
2904.
2905.
2906.
2907.
2908.
2909.
2910.
2911.
2912.
2913.
2914.
2915.
2916.
2917.
2918.
2919.
2920.
2921.
2922.
2923.
2924.
2925.
2926.
2927.
2928.
2929.
2930.
2931.
2932.
2933.
2934.
2935.
2936.
2937.
2938.
2939.
2940.
2941.
2942.
2943.
2944.
2945.
2946.
2947.
2948.
2949.
2950.
2951.
2952.
2953.
2954.
2955.
2956.
2957.
2958.
2959.
2960.
2961.
2962.
2963.
2964.
2965.
2966.
2967.
2968.
2969.
2970.
2971.
2972.
2973.
2974.
2975.
2976.
2977.
2978.
2979.
2980.
2981.
2982.
2983.
2984.
2985.
2986.
2987.
2988.
2989.
2990.
2991.
2992.
2993.
2994.
2995.
2996.
2997.
2998.
2999.
3000.
3001.
3002.
3003.
3004.
3005.
3006.
3007.
3008.
3009.
3010.
3011.
3012.
3013.
3014.
3015.
3016.
3017.
3018.
3019.
3020.
3021.
3022.
3023.
3024.
3025.
3026.
3027.
3028.
3029.
3030.
3031.
3032.
3033.
3034.
3035.
3036.
3037.
3038.
3039.
3040.
3041.
3042.
3043.
3044.
3045.
3046.
3047.
3048.
3049.
3050.
3051.
3052.
3053.
3054.
3055.
3056.
3057.
3058.
3059.
3060.
3061.
3062.
3063.
3064.
3065.
3066.
3067.
3068.
3069.
3070.
3071.
3072.
3073.
3074.
3075.
3076.
3077.
3078.
3079.
3080.
3081.
3082.
3083.
3084.
3085.
3086.
3087.
3088.
3089.
3090.
3091.
3092.
3093.
3094.
3095.
3096.
3097.
3098.
3099.
3100.
3101.
3102.
3103.
3104.
3105.
3106.
3107.
3108.
3109.
3110.
3111.
3112.
3113.
3114.
3115.
3116.
3117.
3118.
3119.
3120.
3121.
3122.
3123.
3124.
3125.
3126.
3127.
3128.
3129.
3130.
3131.
3132.
3133.
3134.
3135.
3136.
3137.
3138.
3139.
3140.
3141.
3142.
3143.
3144.
3145.
3146.
3147.
3148.
3149.
3150.
3151.
3152.
3153.
3154.
3155.
3156.
3157.
3158.
3159.
3160.
3161.
3162.
3163.
3164.
3165.
3166.
3167.
3168.
3169.
3170.
3171.
3172.
3173.
3174.
3175.
3176.
3177.
3178.
3179.
3180.
3181.
3182.
3183.
3184.
3185.
3186.
3187.
3188.
3189.
3190.
3191.
3192.
3193.
3194.
3195.
3196.
3197.
3198.
3199.
3200.
3201.
3202.
3203.
3204.
3205.
3206.
3207.
3208.
3209.
3210.
3211.
3212.
3213.
3214.
3215.
3216.
3217.
3218.
3219.
3220.
3221.
3222.
3223.
3224.
3225.
3226.
3227.
3228.
3229.
3230.
3231.
3232.
3233.
3234.
3235.
3236.
3237.
3238.
3239.
3240.
3241.
3242.
3243.
3244.
3245.
3246.
3247.
3248.
3249.
3250.
3251.
3252.
3253.
3254.
3255.
3256.
3257.
3258.
3259.
3260.
3261.
3262.
3263.
3264.
3265.
3266.
3267.
3268.
3269.
3270.
3271.
3272.
3273.
3274.
3275.
3276.
3277.
3278.
3279.
3280.
3281.
3282.
3283.
3284.
3285.
3286.
3287.
3288.
3289.
3290.
3291.
3292.
3293.
3294.
3295.
3296.
3297.
3298.
3299.
3300.
3301.
3302.
3303.
3304.
3305.
3306.
3307.
3308.
3309.
3310.
3311.
3312.
3313.
3314.
3315.
3316.
3317.
3318.
3319.
3320.
3321.
3322.
3323.
3324.
3325.
3326.
3327.
3328.
3329.
3330.
3331.
3332.
3333.
3334.
3335.
3336.
3337.
3338.
3339.
3340.
3341.
3342.
3343.
3344.
3345.
3346.
3347.
3348.
3349.
3350.
3351.
3352.
3353.
3354.
3355.
3356.
3357.
3358.
3359.
3360.
3361.
3362.
3363.
3364.
3365.
3366.
3367.
3368.
3369.
3370.
3371.
3372.
3373.
3374.
3375.
3376.
3377.
3378.
3379.
3380.
3381.
3382.
3383.
3384.
3385.
3386.
3387.
3388.
3389.
3390.
3391.
3392.
3393.
3394.
3395.
3396.
3397.
3398.
3399.
3400.
3401.
3402.
3403.
3404.
3405.
3406.
3407.
3408.
3409.
3410.
3411.
3412.
3413.
3414.
3415.
3416.
3417.
3418.
3419.
3420.
3421.
3422.
3423.
3424.
3425.
3426.
3427.
3428.
3429.
3430.
3431.
3432.
3433.
3434.
3435.
3436.
3437.
3438.
3439.
3440.
3441.
3442.
3443.
3444.
3445.
3446.
3447.
3448.
3449.
3450.
3451.
3452.
3453.
3454.
3455.
3456.
3457.
3458.
3459.
3460.
3461.
3462.
3463.
3464.
3465.
3466.
3467.
3468.
3469.
3470.
3471.
3472.
3473.
3474.
3475.
3476.
3477.
3478.
3479.
3480.
3481.
3482.
3483.
3484.
3485.
3486.
3487.
3488.
3489.
3490.
3491.
3492.
3493.
3494.
3495.
3496.
3497.
3498.
3499.
3500.
3501.
3502.
3503.
3504.
3505.
3506.
3507.
3508.
3509.
3510.
3511.
3512.
3513.
3514.
3515.
3516.
3517.
3518.
3519.
3520.
3521.
3522.
3523.
3524.
3525.
3526.
3527.
3528.
3529.
3530.
3531.
3532.
3533.
3534.
3535.
3536.
3537.
3538.
3539.
3540.
3541.
3542.
3543.
3544.
3545.
3546.
3547.
3548.
3549.
3550.
3551.
3552.
3553.
3554.
3555.
3556.
3557.
3558.
3559.
3560.
3561.
3562.
3563.
3564.
3565.
3566.
3567.
3568.
3569.
3570.
3571.
3572.
3573.
3574.
3575.
3576.
3577.
3578.
3579.
3580.
3581.
3582.
3583.
3584.
3585.
3586.
3587.
3588.
3589.
3590.
3591.
3592.
3593.
3594.
3595.
3596.
3597.
3598.
3599.
3600.
3601.
3602.
3603.
3604.
3605.
3606.
3607.
3608.
3609.
3610.
3611.
3612.
3613.
3614.
3615.
3616.
3617.
3618.
3619.
3620.
3621.
3622.
3623.
3624.
3625.
3626.
3627.
3628.
3629.
3630.
3631.
3632.
3633.
3634.
3635.
3636.
3637.
3638.
3639.
3640.
3641.
3642.
3643.
3644.
3645.
3646.
3647.
3648.
3649.
3650.
3651.
3652.
3653.
3654.
3655.
3656.
3657.
3658.
3659.
3660.
3661.
3662.
3663.
3664.
3665.
3666.
3667.
3668.
3669.
3670.
3671.
3672.
3673.
3674.
3675.
3676.
3677.
3678.
3679.
3680.
3681.
3682.
3683.
3684.
3685.
3686.
3687.
3688.
3689.
3690.
3691.
3692.
3693.
3694.
3695.
3696.
3697.
3698.
3699.
3700.
3701.
3702.
3703.
3704.
3705.
3706.
3707.
3708.
3709.
3710.
3711.
3712.
3713.
3714.
3715.
3716.
3717.
3718.
3719.
3720.
3721.
3722.
3723.
3724.
3725.
3726.
3727.
3728.
3729.
3730.
3731.
3732.
3733.
3734.
3735.
3736.
3737.
3738.
3739.
3740.
3741.
3742.
3743.
3744.
3745.
3746.
3747.
3748.
3749.
3750.
3751.
3752.
3753.
3754.
3755.
3756.
3757.
3758.
3759.
3760.
3761.
3762.
3763.
3764.
3765.
3766.
3767.
3768.
3769.
3770.
3771.
3772.
3773.
3774.
3775.
3776.
3777.
3778.
3779.
3780.
3781.
3782.
3783.
3784.
3785.
3786.
3787.
3788.
3789.
3790.
3791.
3792.
3793.
3794.
3795.
3796.
3797.
3798.
3799.
3800.
3801.
3802.
3803.
3804.
3805.
3806.
3807.
3808.
3809.
3810.
3811.
3812.
3813.
3814.
3815.
3816.
3817.
3818.
3819.
3820.
3821.
3822.
3823.
3824.
3825.
3826.
3827.
3828.
3829.
3830.
3831.
3832.
3833.
3834.
3835.
3836.
3837.
3838.
3839.
3840.
3841.
3842.
3843.
3844.
3845.
3846.
3847.
3848.
3849.
3850.
3851.
3852.
3853.
3854.
3855.
3856.
3857.
3858.
3859.
3860.
3861.
3862.
3863.
3864.
3865.
3866.
3867.
3868.
3869.
3870.
3871.
3872.
3873.
3874.
3875.
3876.
3877.
3878.
3879.
3880.
3881.
3882.
3883.
3884.
3885.
3886.
3887.
3888.
3889.
3890.
3891.
3892.
3893.
3894.
3895.
3896.
3897.
3898.
3899.
3900.
3901.
3902.
3903.
3904.
3905.
3906.
3907.
3908.
3909.
3910.
3911.
3912.
3913.
3914.
3915.
3916.
3917.
3918.
3919.
3920.
3921.
3922.
3923.
3924.
3925.
3926.
3927.
3928.
3929.
3930.
3931.
3932.
3933.
3934.
3935.
3936.
3937.
3938.
3939.
3940.
3941.
3942.
3943.
3944.
3945.
3946.
3947.
3948.
3949.
3950.
3951.
3952.
3953.
3954.
3955.
3956.
3957.
3958.
3959.
3960.
3961.
3962.
3963.
3964.
3965.
3966.
3967.
3968.
3969.
3970.
3971.
3972.
3973.
3974.
3975.
3976.
3977.
3978.
3979.
3980.
3981.
3982.
3983.
3984.
3985.
3986.
3987.
3988.
3989.
3990.
3991.
3992.
3993.
3994.
3995.
3996.
3997.
3998.
3999.
4000.
4001.
4002.
4003.
4004.
4005.
4006.
4007.
4008.
4009.
4010.
4011.
4012.
4013.
4014.
4015.
4016.
4017.
4018.
4019.
4020.
4021.
4022.
4023.
4024.
4025.
4026.
4027.
4028.
4029.
4030.
4031.
4032.
4033.
4034.
4035.
4036.
4037.
4038.
4039.
4040.
4041.
4042.
4043.
4044.
4045.
4046.
4047.
4048.
4049.
4050.
4051.
4052.
4053.
4054.
4055.
4056.
4057.
4058.
4059.
4060.
4061.
4062.
4063.
4064.
4065.
4066.
4067.
4068.
4069.
4070.
4071.
4072.
4073.
4074.
4075.
4076.
4077.
4078.
4079.
4080.
4081.
4082.
4083.
4084.
4085.
4086.
4087.
4088.
4089.
4090.
4091.
4092.
4093.
4094.
4095.
4096.
4097.
4098.
4099.
4100.
4101.
4102.
4103.
4104.
4105.
4106.
4107.
4108.
4109.
4110.
4111.
4112.
4113.
4114.
4115.
4116.
4117.
4118.
4119.
4120.
4121.
4122.
4123.
4124.
4125.
4126.
4127.
4128.
4129.
4130.
4131.
4132.
4133.
4134.
4135.
4136.
4137.
4138.
4139.
4140.
4141.
4142.
4143.
4144.
4145.
4146.
4147.
4148.
4149.
4150.
4151.
4152.
4153.
4154.
4155.
4156.
4157.
4158.
4159.
4160.
4161.
4162.
4163.
4164.
4165.
4166.
4167.
4168.
4169.
4170.
4171.
4172.
4173.
4174.
4175.
4176.
4177.
4178.
4179.
4180.
4181.
4182.
4183.
4184.
4185.
4186.
4187.
4188.
4189.
4190.
4191.
4192.
4193.
4194.
4195.
4196.
4197.
4198.
4199.
4200.
4201.
4202.
4203.
4204.
4205.
4206.
4207.
4208.
4209.
4210.
4211.
4212.
4213.
4214.
4215.
4216.
4217.
4218.
4219.
4220.
4221.
4222.
4223.
4224.
4225.
4226.
4227.
4228.
4229.
4230.
4231.
4232.
4233.
4234.
4235.
4236.
4237.
4238.
4239.
4240.
4241.
4242.
4243.
4244.
4245.
4246.
4247.
4248.
4249.
4250.
4251.
4252.
4253.
4254.
4255.
4256.
4257.
4258.
4259.
4260.
4261.
4262.
4263.
4264.
4265.
4266.
4267.
4268.
4269.
4270.
4271.
4272.
4273.
4274.
4275.
4276.
4277.
4278.
4279.
4280.
4281.
4282.
4283.
4284.
4285.
4286.
4287.
4288.
4289.
4290.
4291.
4292.
4293.
4294.
4295.
4296.
4297.
4298.
4299.
4300.
4301.
4302.
4303.
4304.
4305.
4306.
4307.
4308.
4309.
4310.
4311.
4312.
4313.
4314.
4315.
4316.
4317.
4318.
4319.
4320.
4321.
4322.
4323.
4324.
4325.
4326.
4327.
4328.
4329.
4330.
4331.
4332.
4333.
4334.
4335.
4336.
4337.
4338.
4339.
4340.
4341.
4342.
4343.
4344.
4345.
4346.
4347.
4348.
4349.
4350.
4351.
4352.
4353.
4354.
4355.
4356.
4357.
4358.
4359.
4360.
4361.
4362.
4363.
4364.
4365.
4366.
4367.
4368.
4369.
4370.
4371.
4372.
4373.
4374.
4375.
4376.
4377.
4378.
4379.
4380.
4381.
4382.
4383.
4384.
4385.
4386.
4387.
4388.
4389.
4390.
4391.
4392.
4393.
4394.
4395.
4396.
4397.
4398.
4399.
4400.
4401.
4402.
4403.
4404.
4405.
4406.
4407.
4408.
4409.
4410.
4411.
4412.
4413.
4414.
4415.
4416.
4417.
4418.
4419.
4420.
4421.
4422.
4423.
4424.
4425.
4426.
4427.
4428.
4429.
4430.
4431.
4432.
4433.
4434.
4435.
4436.
4437.
4438.
4439.
4440.
4441.
4442.
4443.
4444.
4445.
4446.
4447.
4448.
4449.
4450.
4451.
4452.
4453.
4454.
4455.
4456.
4457.
4458.
4459.
4460.
4461.
4462.
4463.
4464.
4465.
4466.
4467.
4468.
4469.
4470.
4471.
4472.
4473.
4474.
4475.
4476.
4477.
4478.
4479.
4480.
4481.
4482.
4483.
4484.
4485.
4486.
4487.
4488.
4489.
4490.
4491.
4492.
4493.
4494.
4495.
4496.
4497.
4498.
4499.
4500.
4501.
4502.
4503.
4504.
4505.
4506.
4507.
4508.
4509.
4510.
4511.
4512.
4513.
4514.
4515.
4516.
4517.
4518.
4519.
4520.
4521.
4522.
4523.
4524.
4525.
4526.
4527.
4528.
4529.
4530.
4531.
4532.
4533.
4534.
4535.
4536.
4537.
4538.
4539.
4540.
4541.
4542.
4543.
4544.
4545.
4546.
4547.
4548.
4549.
4550.
4551.
4552.
4553.
4554.
4555.
4556.
4557.
4558.
4559.
4560.
4561.
4562.
4563.
4564.
4565.
4566.
4567.
4568.
4569.
4570.
4571.
4572.
4573.
4574.
4575.
4576.
4577.
4578.
4579.
4580.
4581.
4582.
4583.
4584.
4585.
4586.
4587.
4588.
4589.
4590.
4591.
4592.
4593.
4594.
4595.
4596.
4597.
4598.
4599.
4600.
4601.
4602.
4603.
4604.
4605.
4606.
4607.
4608.
4609.
4610.
4611.
4612.
4613.
4614.
4615.
4616.
4617.
4618.
4619.
4620.
4621.
4622.
4623.
4624.
4625.
4626.
4627.
4628.
4629.
4630.
4631.
4632.
4633.
4634.
4635.
4636.
4637.
4638.
4639.
4640.
4641.
4642.
4643.
4644.
4645.
4646.
4647.
4648.
4649.
4650.
4651.
4652.
4653.
4654.
4655.
4656.
4657.
4658.
4659.
4660.
4661.
4662.
4663.
4664.
4665.
4666.
4667.
4668.
4669.
4670.
4671.
4672.
4673.
4674.
4675.
4676.
4677.
4678.
4679.
4680.
4681.
4682.
4683.
4684.
4685.
4686.
4687.
4688.
4689.
4690.
4691.
4692.
4693.
4694.
4695.
4696.
4697.
4698.
4699.
4700.
4701.
4702.
4703.
4704.
4705.
4706.
4707.
4708.
4709.
4710.
4711.
4712.
4713.
4714.
4715.
4716.
4717.
4718.
4719.
4720.
4721.
4722.
4723.
4724.
4725.
4726.
4727.
4728.
4729.
4730.
4731.
4732.
4733.
4734.
4735.
4736.
4737.
4738.
4739.
4740.
4741.
4742.
4743.
4744.
4745.
4746.
4747.
4748.
4749.
4750.
4751.
4752.
4753.
4754.
4755.
4756.
4757.
4758.
4759.
4760.
4761.
4762.
4763.
4764.
4765.
4766.
4767.
4768.
4769.
4770.
4771.
4772.
4773.
4774.
4775.
4776.
4777.
4778.
4779.
4780.
4781.
4782.
4783.
4784.
4785.
4786.
4787.
4788.
4789.
4790.
4791.
4792.
4793.
4794.
4795.
4796.
4797.
4798.
4799.
4800.
4801.
4802.
4803.
4804.
4805.
4806.
4807.
4808.
4809.
4810.
4811.
4812.
4813.
4814.
4815.
4816.
4817.
4818.
4819.
4820.
4821.
4822.
4823.
4824.
4825.
4826.
4827.
4828.
4829.
4830.
4831.
4832.
4833.
4834.
4835.
4836.
4837.
4838.
4839.
4840.
4841.
4842.
4843.
4844.
4845.
4846.
4847.
4848.
4849.
4850.
4851.
4852.
4853.
4854.
4855.
4856.
4857.
4858.
4859.
4860.
4861.
4862.
4863.
4864.
4865.
4866.
4867.
4868.
4869.
4870.
4871.
4872.
4873.
4874.
4875.
4876.
4877.
4878.
4879.
4880.
4881.
4882.
4883.
4884.
4885.
4886.
4887.
4888.
4889.
4890.
4891.
4892.
4893.
4894.
4895.
4896.
4897.
4898.
4899.
4900.
4901.
4902.
4903.
4904.
4905.
4906.
4907.
4908.
4909.
4910.
4911.
4912.
4913.
4914.
4915.
4916.
4917.
4918.
4919.
4920.
4921.
4922.
4923.
4924.
4925.
4926.
4927.
4928.
4929.
4930.
4931.
4932.
4933.
4934.
4935.
4936.
4937.
4938.
4939.
4940.
4941.
4942.
4943.
4944.
4945.
4946.
4947.
4948.
4949.
4950.
4951.
4952.
4953.
4954.
4955.
4956.
4957.
4958.
4959.
4960.
4961.
4962.
4963.
4964.
4965.
4966.
4967.
4968.
4969.
4970.
4971.
4972.
4973.
4974.
4975.
4976.
4977.
4978.
4979.
4980.
4981.
4982.
4983.
4984.
4985.
4986.
4987.
4988.
4989.
4990.
4991.
4992.
4993.
4994.
4995.
4996.
4997.
4998.
4999.
5000.
5001.
5002.
5003.
5004.
5005.
5006.
5007.
5008.
5009.
5010.
5011.
5012.
5013.
5014.
5015.
5016.
5017.
5018.
5019.
5020.
5021.
5022.
5023.
5024.
5025.
5026.
5027.
5028.
5029.
5030.
5031.
5032.
5033.
5034.
5035.
5036.
5037.
5038.
5039.
5040.
5041.
5042.
5043.
5044.
5045.
5046.
5047.
5048.
5049.
5050.
5051.
5052.
5053.
5054.
5055.
5056.
5057.
5058.
5059.
5060.
5061.
5062.
5063.
5064.
5065.
5066.
5067.
5068.
5069.
5070.
5071.
5072.
5073.
5074.
5075.
5076.
5077.
5078.
5079.
5080.
5081.
5082.
5083.
5084.
5085.
5086.
5087.
5088.
5089.
5090.
5091.
5092.
5093.
5094.
5095.
5096.
5097.
5098.
5099.
5100.
5101.
5102.
5103.
5104.
5105.
5106.
5107.
5108.
5109.
5110.
5111.
5112.
5113.
5114.
5115.
5116.
5117.
5118.
5119.
5120.
5121.
5122.
5123.
5124.
5125.
5126.
5127.
5128.
5129.
5130.
5131.
5132.
5133.
5134.
5135.
5136.
5137.
5138.
5139.
5140.
5141.
5142.
5143.
5144.
5145.
5146.
5147.
5148.
5149.
5150.
5151.
5152.
5153.
5154.
5155.
5156.
5157.
5158.
5159.
5160.
5161.
5162.
5163.
5164.
5165.
5166.
5167.
5168.
5169.
5170.
5171.
5172.
5173.
5174.
5175.
5176.
5177.
5178.
5179.
5180.
5181.
5182.
5183.
5184.
5185.
5186.
5187.
5188.
5189.
5190.
5191.
5192.
5193.
5194.
5195.
5196.
5197.
5198.
5199.
5200.
5201.
5202.
5203.
5204.
5205.
5206.
5207.
5208.
5209.
5210.
5211.
5212.
5213.
5214.
5215.
5216.
5217.
5218.
5219.
5220.
5221.
5222.
5223.
5224.
5225.
5226.
5227.
5228.
5229.
5230.
5231.
5232.
5233.
5234.
5235.
5236.
5237.
5238.
5239.
5240.
5241.
5242.
5243.
5244.
5245.
5246.
5247.
5248.
5249.
5250.
5251.
5252.
5253.
5254.
5255.
5256.
5257.
5258.
5259.
5260.
5261.
5262.
5263.
5264.
5265.
5266.
5267.
5268.
5269.
5270.
5271.
5272.
5273.
5274.
5275.
5276.
5277.
5278.
5279.
5280.
5281.
5282.
5283.
5284.
5285.
5286.
5287.
5288.
5289.
5290.
5291.
5292.
5293.
5294.
5295.
5296.
5297.
5298.
5299.
5300.
5301.
5302.
5303.
5304.
5305.
5306.
5307.
5308.
5309.
5310.
5311.
5312.
5313.
5314.
5315.
5316.
5317.
5318.
5319.
5320.
5321.
5322.
5323.
5324.
5325.
5326.
5327.
5328.
5329.
5330.
5331.
5332.
5333.
5334.
5335.
5336.
5337.
5338.
5339.
5340.
5341.
5342.
5343.
5344.
5345.
5346.
5347.
5348.
5349.
5350.
5351.
5352.
5353.
5354.
5355.
5356.
5357.
5358.
5359.
5360.
5361.
5362.
5363.
5364.
5365.
5366.
5367.
5368.
5369.
5370.
5371.
5372.
5373.
5374.
5375.
5376.
5377.
5378.
5379.
5380.
5381.
5382.
5383.
5384.
5385.
5386.
5387.
5388.
5389.
5390.
5391.
5392.
5393.
5394.
5395.
5396.
5397.
5398.
5399.
5400.
5401.
5402.
5403.
5404.
5405.
5406.
5407.
5408.
5409.
5410.
5411.
5412.
5413.
5414.
5415.
5416.
5417.
5418.
5419.
5420.
5421.
5422.
5423.
5424.
5425.
5426.
5427.
5428.
5429.
5430.
5431.
5432.
5433.
5434.
5435.
5436.
5437.
5438.
5439.
5440.
5441.
5442.
5443.
5444.
5445.
5446.
5447.
5448.
5449.
5450.
5451.
5452.
5453.
5454.
5455.
5456.
5457.
5458.
5459.
5460.
5461.
5462.
5463.
5464.
5465.
5466.
5467.
5468.
5469.
5470.
5471.
5472.
5473.
5474.
5475.
5476.
5477.
5478.
5479.
5480.
5481.
5482.
5483.
5484.
5485.
5486.
5487.
5488.
5489.
5490.
5491.
5492.
5493.
5494.
5495.
5496.
5497.
5498.
5499.
5500.
5501.
5502.
5503.
5504.
5505.
5506.
5507.
5508.
5509.
5510.
5511.
5512.
5513.
5514.
5515.
5516.
5517.
5518.
5519.
5520.
5521.
5522.
5523.
5524.
5525.
5526.
5527.
5528.
5529.
5530.
5531.
5532.
5533.
5534.
5535.
5536.
5537.
5538.
5539.
5540.
5541.
5542.
5543.
5544.
5545.
5546.
5547.
5548.
5549.
5550.
5551.
5552.
5553.
5554.
5555.
5556.
5557.
5558.
5559.
5560.
5561.
5562.
5563.
5564.
5565.
5566.
5567.
5568.
5569.
5570.
5571.
5572.
5573.
5574.
5575.
5576.
5577.
5578.
5579.
5580.
5581.
5582.
5583.
5584.
5585.
5586.
5587.
5588.
5589.
5590.
5591.
5592.
5593.
5594.
5595.
5596.
5597.
5598.
5599.
5600.
5601.
5602.
5603.
5604.
5605.
5606.
5607.
5608.
5609.
5610.
5611.
5612.
5613.
5614.
5615.
5616.
5617.
5618.
5619.
5620.
5621.
5622.
5623.
5624.
5625.
5626.
5627.
5628.
5629.
5630.
5631.
5632.
5633.
5634.
5635.
5636.
5637.
5638.
5639.
5640.
5641.
5642.
5643.
5644.
5645.
5646.
5647.
5648.
5649.
5650.
5651.
5652.
5653.
5654.
5655.
5656.
5657.
5658.
5659.
5660.
5661.
5662.
5663.
5664.
5665.
5666.
5667.
5668.
5669.
5670.
5671.
5672.
5673.
5674.
5675.
5676.
5677.
5678.
5679.
5680.
5681.
5682.
5683.
5684.
5685.
5686.
5687.
5688.
5689.
5690.
5691.
5692.
5693.
5694.
5695.
5696.
5697.
5698.
5699.
5700.
5701.
5702.
5703.
5704.
5705.
5706.
5707.
5708.
5709.
5710.
5711.
5712.
5713.
5714.
5715.
5716.
5717.
5718.
5719.
5720.
5721.
5722.
5723.
5724.
5725.
5726.
5727.
5728.
5729.
5730.
5731.
5732.
5733.
5734.
5735.
5736.
5737.
5738.
5739.
5740.
5741.
5742.
5743.
5744.
5745.
5746.
5747.
5748.
5749.
5750.
5751.
5752.
5753.
5754.
5755.
5756.
5757.
5758.
5759.
5760.
5761.
5762.
5763.
5764.
5765.
5766.
5767.
5768.
5769.
5770.
5771.
5772.
5773.
5774.
5775.
5776.
5777.
5778.
5779.
5780.
5781.
5782.
5783.
5784.
5785.
5786.
5787.
5788.
5789.
5790.
5791.
5792.
5793.
5794.
5795.
5796.
5797.
5798.
5799.
5800.
5801.
5802.
5803.
5804.
5805.
5806.
5807.
5808.
5809.
5810.
5811.
5812.
5813.
5814.
5815.
5816.
5817.
5818.
5819.
5820.
5821.
5822.
5823.
5824.
5825.
5826.
5827.
5828.
5829.
5830.
5831.
5832.
5833.
5834.
5835.
5836.
5837.
5838.
5839.
5840.
5841.
5842.
5843.
5844.
5845.
5846.
5847.
5848.
5849.
5850.
5851.
5852.
5853.
5854.
5855.
5856.
5857.
5858.
5859.
5860.
5861.
5862.
5863.
5864.
5865.
5866.
5867.
5868.
5869.
5870.
5871.
5872.
5873.
5874.
5875.
5876.
5877.
5878.
5879.
5880.
5881.
5882.
5883.
5884.
5885.
5886.
5887.
5888.
5889.
5890.
5891.
5892.
5893.
5894.
5895.
5896.
5897.
5898.
5899.
5900.
5901.
5902.
5903.
5904.
5905.
5906.
5907.
5908.
5909.
5910.
5911.
5912.
5913.
5914.
5915.
5916.
5917.
5918.
5919.
5920.
5921.
5922.
5923.
5924.
5925.
5926.
5927.
5928.
5929.
5930.
5931.
5932.
5933.
5934.
5935.
5936.
5937.
5938.
5939.
5940.
5941.
5942.
5943.
5944.
5945.
5946.
5947.
5948.
5949.
5950.
5951.
5952.
5953.
5954.
5955.
5956.
5957.
5958.
5959.
5960.
5961.
5962.
5963.
5964.
5965.
5966.
5967.
5968.
5969.
5970.
5971.
5972.
5973.
5974.
5975.
5976.
5977.
5978.
5979.
5980.
5981.
5982.
5983.
5984.
5985.
5986.
5987.
5988.
5989.
5990.
5991.
5992.
5993.
5994.
5995.
5996.
5997.
5998.
5999.
6000.
6001.
6002.
6003.
6004.
6005.
6006.
6007.
6008.
6009.
6010.
6011.
6012.
6013.
6014.
6015.
6016.
6017.
6018.
6019.
6020.
6021.
6022.
6023.
6024.
6025.
6026.
6027.
6028.
6029.
6030.
6031.
6032.
6033.
6034.
6035.
6036.
6037.
6038.
6039.
6040.
6041.
6042.
6043.
6044.
6045.
6046.
6047.
6048.
6049.
6050.
6051.
6052.
6053.
6054.
6055.
6056.
6057.
6058.
6059.
6060.
6061.
6062.
6063.
6064.
6065.
6066.
6067.
6068.
6069.
6070.
6071.
6072.
6073.
6074.
6075.
6076.
6077.
6078.
6079.
6080.
6081.
6082.
6083.
6084.
6085.
6086.
6087.
6088.
6089.
6090.
6091.
6092.
6093.
6094.
6095.
6096.
6097.
6098.
6099.
6100.
6101.
6102.
6103.
6104.
6105.
6106.
6107.
6108.
6109.
6110.
6111.
6112.
6113.
6114.
6115.
6116.
6117.
6118.
6119.
6120.
6121.
6122.
6123.
6124.
6125.
6126.
6127.
6128.
6129.
6130.
6131.
6132.
6133.
6134.
6135.
6136.
6137.
6138.
6139.
6140.
6141.
6142.
6143.
6144.
6145.
6146.
6147.
6148.
6149.
6150.
6151.
6152.
6153.
6154.
6155.
6156.
6157.
6158.
6159.
6160.
6161.
6162.
6163.
6164.
6165.
6166.
6167.
6168.
6169.
6170.
6171.
6172.
6173.
6174.
6175.
6176.
6177.
6178.
6179.
6180.
6181.
6182.
6183.
6184.
6185.
6186.
6187.
6188.
6189.
6190.
6191.
6192.
6193.
6194.
6195.
6196.
6197.
6198.
6199.
6200.
6201.
6202.
6203.
6204.
6205.
6206.
6207.
6208.
6209.
6210.
6211.
6212.
6213.
6214.
6215.
6216.
6217.
6218.
6219.
6220.
6221.
6222.
6223.
6224.
6225.
6226.
6227.
6228.
6229.
6230.
6231.
6232.
6233.
6234.
6235.
6236.
6237.
6238.
6239.
6240.
6241.
6242.
6243.
6244.
6245.
6246.
6247.
6248.
6249.
6250.
6251.
6252.
6253.
6254.
6255.
6256.
6257.
6258.
6259.
6260.
6261.
6262.
6263.
6264.
6265.
6266.
6267.
6268.
6269.
6270.
6271.
6272.
6273.
6274.
6275.
6276.
6277.
6278.
6279.
6280.
6281.
6282.
6283.
6284.
6285.
6286.
6287.
6288.
6289.
6290.
6291.
6292.
6293.
6294.
6295.
6296.
6297.
6298.
6299.
6300.
6301.
6302.
6303.
6304.
6305.
6306.
6307.
6308.
6309.
6310.
6311.
6312.
6313.
6314.
6315.
6316.
6317.
6318.
6319.
6320.
6321.
6322.
6323.
6324.
6325.
6326.
6327.
6328.
6329.
6330.
6331.
6332.
6333.
6334.
6335.
6336.
6337.
6338.
6339.
6340.
6341.
6342.
6343.
6344.
6345.
6346.
6347.
6348.
6349.
6350.
6351.
6352.
6353.
6354.
6355.
6356.
6357.
6358.
6359.
6360.
6361.
6362.
6363.
6364.
6365.
6366.
6367.
6368.
6369.
6370.
6371.
6372.
6373.
6374.
6375.
6376.
6377.
6378.
6379.
6380.
6381.
6382.
6383.
6384.
6385.
6386.
6387.
6388.
6389.
6390.
6391.
6392.
6393.
6394.
6395.
6396.
6397.
6398.
6399.
6400.
6401.
6402.
6403.
6404.
6405.
6406.
6407.
6408.
6409.
6410.
6411.
6412.
6413.
6414.
6415.
6416.
6417.
6418.
6419.
6420.
6421.
6422.
6423.
6424.
6425.
6426.
6427.
6428.
6429.
6430.
6431.
6432.
6433.
6434.
6435.
6436.
6437.
6438.
6439.
6440.
6441.
6442.
6443.
6444.
6445.
6446.
6447.
6448.
6449.
6450.
6451.
6452.
6453.
6454.
6455.
6456.
6457.
6458.
6459.
6460.
6461.
6462.
6463.
6464.
6465.
6466.
6467.
6468.
6469.
6470.
6471.
6472.
6473.
6474.
6475.
6476.
6477.
6478.
6479.
6480.
6481.
6482.
6483.
6484.
6485.
6486.
6487.
6488.
6489.
6490.
6491.
6492.
6493.
6494.
6495.
6496.
6497.
6498.
6499.
6500.
6501.
6502.
6503.
6504.
6505.
6506.
6507.
6508.
6509.
6510.
6511.
6512.
6513.
6514.
6515.
6516.
6517.
6518.
6519.
6520.
6521.
6522.
6523.
6524.
6525.
6526.
6527.
6528.
6529.
6530.
6531.
6532.
6533.
6534.
6535.
6536.
6537.
6538.
6539.
6540.
6541.
6542.
6543.
6544.
6545.
6546.
6547.
6548.
6549.
6550.
6551.
6552.
6553.
6554.
6555.
6556.
6557.
6558.
6559.
6560.
6561.
6562.
6563.
6564.
6565.
6566.
6567.
6568.
6569.
6570.
6571.
6572.
6573.
6574.
6575.
6576.
6577.
6578.
6579.
6580.
6581.
6582.
6583.
6584.
6585.
6586.
6587.
6588.
6589.
6590.
6591.
6592.
6593.
6594.
6595.
6596.
6597.
6598.
6599.
6600.
6601.
6602.
6603.
6604.
6605.
6606.
6607.
6608.
6609.
6610.
6611.
6612.
6613.
6614.
6615.
6616.
6617.
6618.
6619.
6620.
6621.
6622.
6623.
6624.
6625.
6626.
6627.
6628.
6629.
6630.
6631.
6632.
6633.
6634.
6635.
6636.
6637.
6638.
6639.
6640.
6641.
6642.
6643.
6644.
6645.
6646.
6647.
6648.
6649.
6650.
6651.
6652.
6653.
6654.
6655.
6656.
6657.
6658.
6659.
6660.
6661.
6662.
6663.
6664.
6665.
6666.
6667.
6668.
6669.
6670.
6671.
6672.
6673.
6674.
6675.
6676.
6677.
6678.
6679.
6680.
6681.
6682.
6683.
6684.
6685.
6686.
6687.
6688.
6689.
6690.
6691.
6692.
6693.
6694.
6695.
6696.
6697.
6698.
6699.
6700.
6701.
6702.
6703.
6704.
6705.
6706.
6707.
6708.
6709.
6710.
6711.
6712.
6713.
6714.
6715.
6716.
6717.
6718.
6719.
6720.
6721.
6722.
6723.
6724.
6725.
6726.
6727.
6728.
6729.
6730.
6731.
6732.
6733.
6734.
6735.
6736.
6737.
6738.
6739.
6740.
6741.
6742.
6743.
6744.
6745.
6746.
6747.
6748.
6749.
6750.
6751.
6752.
6753.
6754.
6755.
6756.
6757.
6758.
6759.
6760.
6761.
6762.
6763.
6764.
6765.
6766.
6767.
6768.
6769.
6770.
6771.
6772.
6773.
6774.
6775.
6776.
6777.
6778.
6779.
6780.
6781.
6782.
6783.
6784.
6785.
6786.
6787.
6788.
6789.
6790.
6791.
6792.
6793.
6794.
6795.
6796.
6797.
6798.
6799.
6800.
6801.
6802.
6803.
6804.
6805.
6806.
6807.
6808.
6809.
6810.
6811.
6812.
6813.
6814.
6815.
6816.
6817.
6818.
6819.
6820.
6821.
6822.
6823.
6824.
6825.
6826.
6827.
6828.
6829.
6830.
6831.
6832.
6833.
6834.
6835.
6836.
6837.
6838.
6839.
6840.
6841.
6842.
6843.
6844.
6845.
6846.
6847.
6848.
6849.
6850.
6851.
6852.
6853.
6854.
6855.
6856.
6857.
6858.
6859.
6860.
6861.
6862.
6863.
6864.
6865.
6866.
6867.
6868.
6869.
6870.
6871.
6872.
6873.
6874.
6875.
6876.
6877.
6878.
6879.
6880.
6881.
6882.
6883.
6884.
6885.
6886.
6887.
6888.
6889.
6890.
6891.
6892.
6893.
6894.
6895.
6896.
6897.
6898.
6899.
6900.
6901.
6902.
6903.
6904.
6905.
6906.
6907.
6908.
6909.
6910.
6911.
6912.
6913.
6914.
</code_line></pre></td>
<td class='lines'><pre><code class="prettyprint">// SPDX-License-Identifier: GPL-2.0-only
/*
 * Kernel-based Virtual Machine driver for Linux
 *
 * This module enables machines with Intel VT-x extensions to run virtual
 * machines without emulation or binary translation.
 *
 * MMU support
 *
 * Copyright (C) 2006 Qumranet, Inc.
 * Copyright 2010 Red Hat, Inc. and/or its affiliates.
 *
 * Authors:
 *   Yaniv Kamay  &lt;yaniv@qumranet.com&gt;
 *   Avi Kivity   &lt;avi@qumranet.com&gt;
 */

#include &quot;irq.h&quot;
#include &quot;ioapic.h&quot;
#include &quot;mmu.h&quot;
#include &quot;mmu_internal.h&quot;
#include &quot;tdp_mmu.h&quot;
#include &quot;x86.h&quot;
#include &quot;kvm_cache_regs.h&quot;
#include &quot;kvm_emulate.h&quot;
#include &quot;cpuid.h&quot;
#include &quot;spte.h&quot;

#include &lt;linux/kvm_host.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/string.h&gt;
#include &lt;linux/mm.h&gt;
#include &lt;linux/highmem.h&gt;
#include &lt;linux/moduleparam.h&gt;
#include &lt;linux/export.h&gt;
#include &lt;linux/swap.h&gt;
#include &lt;linux/hugetlb.h&gt;
#include &lt;linux/compiler.h&gt;
#include &lt;linux/srcu.h&gt;
#include &lt;linux/slab.h&gt;
#include &lt;linux/sched/signal.h&gt;
#include &lt;linux/uaccess.h&gt;
#include &lt;linux/hash.h&gt;
#include &lt;linux/kern_levels.h&gt;
#include &lt;linux/kthread.h&gt;

#include &lt;asm/page.h&gt;
#include &lt;asm/memtype.h&gt;
#include &lt;asm/cmpxchg.h&gt;
#include &lt;asm/io.h&gt;
#include &lt;asm/set_memory.h&gt;
#include &lt;asm/vmx.h&gt;
#include &lt;asm/kvm_page_track.h&gt;
#include &quot;trace.h&quot;

extern bool itlb_multihit_kvm_mitigation;

int __read_mostly nx_huge_pages = -1;
static uint __read_mostly nx_huge_pages_recovery_period_ms;
#ifdef CONFIG_PREEMPT_RT
/* Recovery can cause latency spikes, disable it for PREEMPT_RT.  */
static uint __read_mostly nx_huge_pages_recovery_ratio = 0;
#else
static uint __read_mostly nx_huge_pages_recovery_ratio = 60;
#endif

static int set_nx_huge_pages(const char *val, const struct kernel_param *kp);
static int set_nx_huge_pages_recovery_param(const char *val, const struct kernel_param *kp);

static const struct kernel_param_ops nx_huge_pages_ops = {
	.set = set_nx_huge_pages,
	.get = param_get_bool,
};

static const struct kernel_param_ops nx_huge_pages_recovery_param_ops = {
	.set = set_nx_huge_pages_recovery_param,
	.get = param_get_uint,
};

module_param_cb(nx_huge_pages, &amp;nx_huge_pages_ops, &amp;nx_huge_pages, 0644);
__MODULE_PARM_TYPE(nx_huge_pages, &quot;bool&quot;);
module_param_cb(nx_huge_pages_recovery_ratio, &amp;nx_huge_pages_recovery_param_ops,
		&amp;nx_huge_pages_recovery_ratio, 0644);
__MODULE_PARM_TYPE(nx_huge_pages_recovery_ratio, &quot;uint&quot;);
module_param_cb(nx_huge_pages_recovery_period_ms, &amp;nx_huge_pages_recovery_param_ops,
		&amp;nx_huge_pages_recovery_period_ms, 0644);
__MODULE_PARM_TYPE(nx_huge_pages_recovery_period_ms, &quot;uint&quot;);

static bool __read_mostly force_flush_and_sync_on_reuse;
module_param_named(flush_on_reuse, force_flush_and_sync_on_reuse, bool, 0644);

/*
 * When setting this variable to true it enables Two-Dimensional-Paging
 * where the hardware walks 2 page tables:
 * 1. the guest-virtual to guest-physical
 * 2. while doing 1. it walks guest-physical to host-physical
 * If the hardware supports that we don&#x27;t need to do shadow paging.
 */
bool tdp_enabled = false;

static int max_huge_page_level __read_mostly;
static int tdp_root_level __read_mostly;
static int max_tdp_level __read_mostly;

#ifdef MMU_DEBUG
bool dbg = 0;
module_param(dbg, bool, 0644);
#endif

#define PTE_PREFETCH_NUM		8

#include &lt;trace/events/kvm.h&gt;

/* make pte_list_desc fit well in cache lines */
#define PTE_LIST_EXT 14

/*
 * Slight optimization of cacheline layout, by putting `more&#x27; and `spte_count&#x27;
 * at the start; then accessing it will only use one single cacheline for
 * either full (entries==PTE_LIST_EXT) case or entries&lt;=6.
 */
struct pte_list_desc {
	struct pte_list_desc *more;
	/*
	 * Stores number of entries stored in the pte_list_desc.  No need to be
	 * u64 but just for easier alignment.  When PTE_LIST_EXT, means full.
	 */
	u64 spte_count;
	u64 *sptes[PTE_LIST_EXT];
};

struct kvm_shadow_walk_iterator {
	u64 addr;
	hpa_t shadow_addr;
	u64 *sptep;
	int level;
	unsigned index;
};

#define for_each_shadow_entry_using_root(_vcpu, _root, _addr, _walker)     \
	for (shadow_walk_init_using_root(&amp;(_walker), (_vcpu),              \
					 (_root), (_addr));                \
	     shadow_walk_okay(&amp;(_walker));			           \
	     shadow_walk_next(&amp;(_walker)))

#define for_each_shadow_entry(_vcpu, _addr, _walker)            \
	for (shadow_walk_init(&amp;(_walker), _vcpu, _addr);	\
	     shadow_walk_okay(&amp;(_walker));			\
	     shadow_walk_next(&amp;(_walker)))

#define for_each_shadow_entry_lockless(_vcpu, _addr, _walker, spte)	\
	for (shadow_walk_init(&amp;(_walker), _vcpu, _addr);		\
	     shadow_walk_okay(&amp;(_walker)) &amp;&amp;				\
		({ spte = mmu_spte_get_lockless(_walker.sptep); 1; });	\
	     __shadow_walk_next(&amp;(_walker), spte))

static struct kmem_cache *pte_list_desc_cache;
struct kmem_cache *mmu_page_header_cache;
static struct percpu_counter kvm_total_used_mmu_pages;

static void mmu_spte_set(u64 *sptep, u64 spte);

struct kvm_mmu_role_regs {
	const unsigned long cr0;
	const unsigned long cr4;
	const u64 efer;
};

#define CREATE_TRACE_POINTS
#include &quot;mmutrace.h&quot;

/*
 * Yes, lot&#x27;s of underscores.  They&#x27;re a hint that you probably shouldn&#x27;t be
 * reading from the role_regs.  Once the root_role is constructed, it becomes
 * the single source of truth for the MMU&#x27;s state.
 */
#define BUILD_MMU_ROLE_REGS_ACCESSOR(reg, name, flag)			\
static inline bool __maybe_unused					\
____is_##reg##_##name(const struct kvm_mmu_role_regs *regs)		\
{									\
	return !!(regs-&gt;reg &amp; flag);					\
}
BUILD_MMU_ROLE_REGS_ACCESSOR(cr0, pg, X86_CR0_PG);
BUILD_MMU_ROLE_REGS_ACCESSOR(cr0, wp, X86_CR0_WP);
BUILD_MMU_ROLE_REGS_ACCESSOR(cr4, pse, X86_CR4_PSE);
<blue>BUILD_MMU_ROLE_REGS_ACCESSOR(cr4, pae, X86_CR4_PAE);</blue>
<blue>BUILD_MMU_ROLE_REGS_ACCESSOR(cr4, smep, X86_CR4_SMEP);</blue>
BUILD_MMU_ROLE_REGS_ACCESSOR(cr4, smap, X86_CR4_SMAP);
BUILD_MMU_ROLE_REGS_ACCESSOR(cr4, pke, X86_CR4_PKE);
<blue>BUILD_MMU_ROLE_REGS_ACCESSOR(cr4, la57, X86_CR4_LA57);</blue>
<blue>BUILD_MMU_ROLE_REGS_ACCESSOR(efer, nx, EFER_NX);</blue>
<blue>BUILD_MMU_ROLE_REGS_ACCESSOR(efer, lma, EFER_LMA);</blue>

/*
 * The MMU itself (with a valid role) is the single source of truth for the
 * MMU.  Do not use the regs used to build the MMU/role, nor the vCPU.  The
 * regs don&#x27;t account for dependencies, e.g. clearing CR4 bits if CR0.PG=1,
 * and the vCPU may be incorrect/irrelevant.
 */
#define BUILD_MMU_ROLE_ACCESSOR(base_or_ext, reg, name)		\
static inline bool __maybe_unused is_##reg##_##name(struct kvm_mmu *mmu)	\
{								\
	return !!(mmu-&gt;cpu_role. base_or_ext . reg##_##name);	\
}
<blue>BUILD_MMU_ROLE_ACCESSOR(base, cr0, wp);</blue>
<blue>BUILD_MMU_ROLE_ACCESSOR(ext,  cr4, pse);</blue>
<blue>BUILD_MMU_ROLE_ACCESSOR(ext,  cr4, smep);</blue>
BUILD_MMU_ROLE_ACCESSOR(ext,  cr4, smap);
BUILD_MMU_ROLE_ACCESSOR(ext,  cr4, pke);
BUILD_MMU_ROLE_ACCESSOR(ext,  cr4, la57);
<blue>BUILD_MMU_ROLE_ACCESSOR(base, efer, nx);</blue>
BUILD_MMU_ROLE_ACCESSOR(ext,  efer, lma);

static inline bool is_cr0_pg(struct kvm_mmu *mmu)
{
<blue>        return mmu->cpu_role.base.level > 0;</blue>
}

static inline bool is_cr4_pae(struct kvm_mmu *mmu)
{
<blue>        return !mmu->cpu_role.base.has_4_byte_gpte;</blue>
}

static struct kvm_mmu_role_regs vcpu_to_role_regs(struct kvm_vcpu *vcpu)
{
	struct kvm_mmu_role_regs regs = {
<blue>		.cr0 = kvm_read_cr0_bits(vcpu, KVM_MMU_CR0_ROLE_BITS),</blue>
		.cr4 = kvm_read_cr4_bits(vcpu, KVM_MMU_CR4_ROLE_BITS),
		.efer = vcpu-&gt;arch.efer,
	};

	return regs;
}

static inline bool kvm_available_flush_tlb_with_range(void)
{
<yellow>	return kvm_x86_ops.tlb_remote_flush_with_range;</yellow>
}

static void kvm_flush_remote_tlbs_with_range(struct kvm *kvm,
		struct kvm_tlb_range *range)
{
	int ret = -ENOTSUPP;

<blue>	if (range && kvm_x86_ops.tlb_remote_flush_with_range)</blue>
<yellow>		ret = static_call(kvm_x86_tlb_remote_flush_with_range)(kvm, range);</yellow>

	if (ret)
<blue>		kvm_flush_remote_tlbs(kvm);</blue>
}

void kvm_flush_remote_tlbs_with_address(struct kvm *kvm,
		u64 start_gfn, u64 pages)
<blue>{</blue>
	struct kvm_tlb_range range;

	range.start_gfn = start_gfn;
	range.pages = pages;

<blue>	kvm_flush_remote_tlbs_with_range(kvm, &range);</blue>
<yellow>}</yellow>

static void mark_mmio_spte(struct kvm_vcpu *vcpu, u64 *sptep, u64 gfn,
			   unsigned int access)
{
<blue>	u64 spte = make_mmio_spte(vcpu, gfn, access);</blue>

<yellow>	trace_mark_mmio_spte(sptep, gfn, spte);</yellow>
<blue>	mmu_spte_set(sptep, spte);</blue>
}

static gfn_t get_mmio_spte_gfn(u64 spte)
{
<blue>	u64 gpa = spte & shadow_nonpresent_or_rsvd_lower_gfn_mask;</blue>

	gpa |= (spte &gt;&gt; SHADOW_NONPRESENT_OR_RSVD_MASK_LEN)
	       &amp; shadow_nonpresent_or_rsvd_mask;

	return gpa &gt;&gt; PAGE_SHIFT;
}

static unsigned get_mmio_spte_access(u64 spte)
{
	return spte &amp; shadow_mmio_access_mask;
}

static bool check_mmio_spte(struct kvm_vcpu *vcpu, u64 spte)
{
	u64 kvm_gen, spte_gen, gen;

	gen = kvm_vcpu_memslots(vcpu)-&gt;generation;
	if (unlikely(gen &amp; KVM_MEMSLOT_GEN_UPDATE_IN_PROGRESS))
		return false;

	kvm_gen = gen &amp; MMIO_SPTE_GEN_MASK;
<blue>	spte_gen = get_mmio_spte_generation(spte);</blue>

<yellow>	trace_check_mmio_spte(spte, kvm_gen, spte_gen);</yellow>
	return likely(kvm_gen == spte_gen);
}

static int is_cpuid_PSE36(void)
{
	return 1;
}

#ifdef CONFIG_X86_64
static void __set_spte(u64 *sptep, u64 spte)
{
<blue>	WRITE_ONCE(*sptep, spte);</blue>
}

static void __update_clear_spte_fast(u64 *sptep, u64 spte)
{
<blue>	WRITE_ONCE(*sptep, spte);</blue>
}

static u64 __update_clear_spte_slow(u64 *sptep, u64 spte)
{
<blue>	return xchg(sptep, spte);</blue>
}

static u64 __get_spte_lockless(u64 *sptep)
{
<yellow>	return READ_ONCE(*sptep);</yellow>
}
#else
union split_spte {
	struct {
		u32 spte_low;
		u32 spte_high;
	};
	u64 spte;
};

static void count_spte_clear(u64 *sptep, u64 spte)
{
	struct kvm_mmu_page *sp =  sptep_to_sp(sptep);

	if (is_shadow_present_pte(spte))
		return;

	/* Ensure the spte is completely set before we increase the count */
	smp_wmb();
	sp-&gt;clear_spte_count++;
}

static void __set_spte(u64 *sptep, u64 spte)
{
	union split_spte *ssptep, sspte;

	ssptep = (union split_spte *)sptep;
	sspte = (union split_spte)spte;

	ssptep-&gt;spte_high = sspte.spte_high;

	/*
	 * If we map the spte from nonpresent to present, We should store
	 * the high bits firstly, then set present bit, so cpu can not
	 * fetch this spte while we are setting the spte.
	 */
	smp_wmb();

	WRITE_ONCE(ssptep-&gt;spte_low, sspte.spte_low);
}

static void __update_clear_spte_fast(u64 *sptep, u64 spte)
{
	union split_spte *ssptep, sspte;

	ssptep = (union split_spte *)sptep;
	sspte = (union split_spte)spte;

	WRITE_ONCE(ssptep-&gt;spte_low, sspte.spte_low);

	/*
	 * If we map the spte from present to nonpresent, we should clear
	 * present bit firstly to avoid vcpu fetch the old high bits.
	 */
	smp_wmb();

	ssptep-&gt;spte_high = sspte.spte_high;
	count_spte_clear(sptep, spte);
}

static u64 __update_clear_spte_slow(u64 *sptep, u64 spte)
{
	union split_spte *ssptep, sspte, orig;

	ssptep = (union split_spte *)sptep;
	sspte = (union split_spte)spte;

	/* xchg acts as a barrier before the setting of the high bits */
	orig.spte_low = xchg(&amp;ssptep-&gt;spte_low, sspte.spte_low);
	orig.spte_high = ssptep-&gt;spte_high;
	ssptep-&gt;spte_high = sspte.spte_high;
	count_spte_clear(sptep, spte);

	return orig.spte;
}

/*
 * The idea using the light way get the spte on x86_32 guest is from
 * gup_get_pte (mm/gup.c).
 *
 * An spte tlb flush may be pending, because kvm_set_pte_rmap
 * coalesces them and we are running out of the MMU lock.  Therefore
 * we need to protect against in-progress updates of the spte.
 *
 * Reading the spte while an update is in progress may get the old value
 * for the high part of the spte.  The race is fine for a present-&gt;non-present
 * change (because the high part of the spte is ignored for non-present spte),
 * but for a present-&gt;present change we must reread the spte.
 *
 * All such changes are done in two steps (present-&gt;non-present and
 * non-present-&gt;present), hence it is enough to count the number of
 * present-&gt;non-present updates: if it changed while reading the spte,
 * we might have hit the race.  This is done using clear_spte_count.
 */
static u64 __get_spte_lockless(u64 *sptep)
{
	struct kvm_mmu_page *sp =  sptep_to_sp(sptep);
	union split_spte spte, *orig = (union split_spte *)sptep;
	int count;

retry:
	count = sp-&gt;clear_spte_count;
	smp_rmb();

	spte.spte_low = orig-&gt;spte_low;
	smp_rmb();

	spte.spte_high = orig-&gt;spte_high;
	smp_rmb();

	if (unlikely(spte.spte_low != orig-&gt;spte_low ||
	      count != sp-&gt;clear_spte_count))
		goto retry;

	return spte.spte;
}
#endif

/* Rules for using mmu_spte_set:
 * Set the sptep from nonpresent to present.
 * Note: the sptep being assigned *must* be either not present
 * or in a state where the hardware will not attempt to update
 * the spte.
 */
static void mmu_spte_set(u64 *sptep, u64 new_spte)
{
<blue>	WARN_ON(is_shadow_present_pte(*sptep));</blue>
<blue>	__set_spte(sptep, new_spte);</blue>
}

/*
 * Update the SPTE (excluding the PFN), but do not track changes in its
 * accessed/dirty status.
 */
static u64 mmu_spte_update_no_track(u64 *sptep, u64 new_spte)
{
<blue>	u64 old_spte = *sptep;</blue>

<yellow>	WARN_ON(!is_shadow_present_pte(new_spte));</yellow>
<blue>	check_spte_writable_invariants(new_spte);</blue>

<blue>	if (!is_shadow_present_pte(old_spte)) {</blue>
<blue>		mmu_spte_set(sptep, new_spte);</blue>
		return old_spte;
	}

<blue>	if (!spte_has_volatile_bits(old_spte))</blue>
<blue>		__update_clear_spte_fast(sptep, new_spte);</blue>
	else
<yellow>		old_spte = __update_clear_spte_slow(sptep, new_spte);</yellow>

<blue>	WARN_ON(spte_to_pfn(old_spte) != spte_to_pfn(new_spte));</blue>

	return old_spte;
<blue>}</blue>

/* Rules for using mmu_spte_update:
 * Update the state bits, it means the mapped pfn is not changed.
 *
 * Whenever an MMU-writable SPTE is overwritten with a read-only SPTE, remote
 * TLBs must be flushed. Otherwise rmap_write_protect will find a read-only
 * spte, even though the writable spte might be cached on a CPU&#x27;s TLB.
 *
 * Returns true if the TLB needs to be flushed
 */
static bool mmu_spte_update(u64 *sptep, u64 new_spte)
{
	bool flush = false;
<blue>	u64 old_spte = mmu_spte_update_no_track(sptep, new_spte);</blue>

	if (!is_shadow_present_pte(old_spte))
		return false;

	/*
	 * For the spte updated out of mmu-lock is safe, since
	 * we always atomically update it, see the comments in
	 * spte_has_volatile_bits().
	 */
<blue>	if (is_mmu_writable_spte(old_spte) &&</blue>
<blue>	      !is_writable_pte(new_spte))</blue>
		flush = true;

	/*
	 * Flush TLB when accessed/dirty states are changed in the page tables,
	 * to guarantee consistency between TLB and page tables.
	 */

<blue>	if (is_accessed_spte(old_spte) && !is_accessed_spte(new_spte)) {</blue>
		flush = true;
<yellow>		kvm_set_pfn_accessed(spte_to_pfn(old_spte));</yellow>
	}

<blue>	if (is_dirty_spte(old_spte) && !is_dirty_spte(new_spte)) {</blue>
		flush = true;
<yellow>		kvm_set_pfn_dirty(spte_to_pfn(old_spte));</yellow>
	}

	return flush;
<blue>}</blue>

/*
 * Rules for using mmu_spte_clear_track_bits:
 * It sets the sptep from present to nonpresent, and track the
 * state bits, it is used to clear the last level sptep.
 * Returns the old PTE.
 */
static u64 mmu_spte_clear_track_bits(struct kvm *kvm, u64 *sptep)
{
	kvm_pfn_t pfn;
<blue>	u64 old_spte = *sptep;</blue>
<blue>	int level = sptep_to_sp(sptep)->role.level;</blue>
	struct page *page;

	if (!is_shadow_present_pte(old_spte) ||
<blue>	    !spte_has_volatile_bits(old_spte))</blue>
<blue>		__update_clear_spte_fast(sptep, 0ull);</blue>
	else
<blue>		old_spte = __update_clear_spte_slow(sptep, 0ull);</blue>

<blue>	if (!is_shadow_present_pte(old_spte))</blue>
		return old_spte;

	kvm_update_page_stats(kvm, level, -1);

	pfn = spte_to_pfn(old_spte);

	/*
	 * KVM doesn&#x27;t hold a reference to any pages mapped into the guest, and
	 * instead uses the mmu_notifier to ensure that KVM unmaps any pages
	 * before they are reclaimed.  Sanity check that, if the pfn is backed
	 * by a refcounted page, the refcount is elevated.
	 */
	page = kvm_pfn_to_refcounted_page(pfn);
<blue>	WARN_ON(page && !page_count(page));</blue>

<blue>	if (is_accessed_spte(old_spte))</blue>
<blue>		kvm_set_pfn_accessed(pfn);</blue>

<blue>	if (is_dirty_spte(old_spte))</blue>
<blue>		kvm_set_pfn_dirty(pfn);</blue>

	return old_spte;
<blue>}</blue>

/*
 * Rules for using mmu_spte_clear_no_track:
 * Directly clear spte without caring the state bits of sptep,
 * it is used to set the upper level spte.
 */
static void mmu_spte_clear_no_track(u64 *sptep)
{
<yellow>	__update_clear_spte_fast(sptep, 0ull);</yellow>
}

static u64 mmu_spte_get_lockless(u64 *sptep)
{
<yellow>	return __get_spte_lockless(sptep);</yellow>
}

/* Returns the Accessed status of the PTE and resets it at the same time. */
static bool mmu_spte_age(u64 *sptep)
{
<yellow>	u64 spte = mmu_spte_get_lockless(sptep);</yellow>

<yellow>	if (!is_accessed_spte(spte))</yellow>
		return false;

	if (spte_ad_enabled(spte)) {
<yellow>		clear_bit((ffs(shadow_accessed_mask) - 1),</yellow>
			  (unsigned long *)sptep);
	} else {
		/*
		 * Capture the dirty status of the page, so that it doesn&#x27;t get
		 * lost when the SPTE is marked for access tracking.
		 */
<yellow>		if (is_writable_pte(spte))</yellow>
<yellow>			kvm_set_pfn_dirty(spte_to_pfn(spte));</yellow>

<yellow>		spte = mark_spte_for_access_track(spte);</yellow>
		mmu_spte_update_no_track(sptep, spte);
	}

	return true;
}

static void walk_shadow_page_lockless_begin(struct kvm_vcpu *vcpu)
{
<blue>	if (is_tdp_mmu(vcpu->arch.mmu)) {</blue>
<blue>		kvm_tdp_mmu_walk_lockless_begin();</blue>
	} else {
		/*
		 * Prevent page table teardown by making any free-er wait during
		 * kvm_flush_remote_tlbs() IPI to all active vcpus.
		 */
<blue>		local_irq_disable();</blue>

		/*
		 * Make sure a following spte read is not reordered ahead of the write
		 * to vcpu-&gt;mode.
		 */
		smp_store_mb(vcpu-&gt;mode, READING_SHADOW_PAGE_TABLES);
	}
}

static void walk_shadow_page_lockless_end(struct kvm_vcpu *vcpu)
{
<blue>	if (is_tdp_mmu(vcpu->arch.mmu)) {</blue>
<blue>		kvm_tdp_mmu_walk_lockless_end();</blue>
	} else {
		/*
		 * Make sure the write to vcpu-&gt;mode is not reordered in front of
		 * reads to sptes.  If it does, kvm_mmu_commit_zap_page() can see us
		 * OUTSIDE_GUEST_MODE and proceed to free the shadow page table.
		 */
<blue>		smp_store_release(&vcpu->mode, OUTSIDE_GUEST_MODE);</blue>
		local_irq_enable();
	}
}

<blue>static int mmu_topup_memory_caches(struct kvm_vcpu *vcpu, bool maybe_indirect)</blue>
{
	int r;

	/* 1 rmap, 1 parent PTE per level, and the prefetched rmaps. */
<blue>	r = kvm_mmu_topup_memory_cache(&vcpu->arch.mmu_pte_list_desc_cache,</blue>
				       1 + PT64_ROOT_MAX_LEVEL + PTE_PREFETCH_NUM);
	if (r)
		return r;
<blue>	r = kvm_mmu_topup_memory_cache(&vcpu->arch.mmu_shadow_page_cache,</blue>
				       PT64_ROOT_MAX_LEVEL);
	if (r)
		return r;
<blue>	if (maybe_indirect) {</blue>
<blue>		r = kvm_mmu_topup_memory_cache(&vcpu->arch.mmu_shadowed_info_cache,</blue>
					       PT64_ROOT_MAX_LEVEL);
		if (r)
			return r;
	}
<blue>	return kvm_mmu_topup_memory_cache(&vcpu->arch.mmu_page_header_cache,</blue>
					  PT64_ROOT_MAX_LEVEL);
<blue>}</blue>

static void mmu_free_memory_caches(struct kvm_vcpu *vcpu)
{
	kvm_mmu_free_memory_cache(&amp;vcpu-&gt;arch.mmu_pte_list_desc_cache);
	kvm_mmu_free_memory_cache(&amp;vcpu-&gt;arch.mmu_shadow_page_cache);
	kvm_mmu_free_memory_cache(&amp;vcpu-&gt;arch.mmu_shadowed_info_cache);
	kvm_mmu_free_memory_cache(&amp;vcpu-&gt;arch.mmu_page_header_cache);
}

static void mmu_free_pte_list_desc(struct pte_list_desc *pte_list_desc)
{
<yellow>	kmem_cache_free(pte_list_desc_cache, pte_list_desc);</yellow>
}

static bool sp_has_gptes(struct kvm_mmu_page *sp);

<blue>static gfn_t kvm_mmu_page_get_gfn(struct kvm_mmu_page *sp, int index)</blue>
{
<blue>	if (sp->role.passthrough)</blue>
<yellow>		return sp->gfn;</yellow>

<blue>	if (!sp->role.direct)</blue>
<blue>		return sp->shadowed_translation[index] >> PAGE_SHIFT;</blue>

<blue>	return sp->gfn + (index << ((sp->role.level - 1) * SPTE_LEVEL_BITS));</blue>
<blue>}</blue>

/*
 * For leaf SPTEs, fetch the *guest* access permissions being shadowed. Note
 * that the SPTE itself may have a more constrained access permissions that
 * what the guest enforces. For example, a guest may create an executable
 * huge PTE but KVM may disallow execution to mitigate iTLB multihit.
 */
static u32 kvm_mmu_page_get_access(struct kvm_mmu_page *sp, int index)
{
<yellow>	if (sp_has_gptes(sp))</yellow>
		return sp-&gt;shadowed_translation[index] &amp; ACC_ALL;

	/*
	 * For direct MMUs (e.g. TDP or non-paging guests) or passthrough SPs,
	 * KVM is not shadowing any guest page tables, so the &quot;guest access
	 * permissions&quot; are just ACC_ALL.
	 *
	 * For direct SPs in indirect MMUs (shadow paging), i.e. when KVM
	 * is shadowing a guest huge page with small pages, the guest access
	 * permissions being shadowed are the access permissions of the huge
	 * page.
	 *
	 * In both cases, sp-&gt;role.access contains the correct access bits.
	 */
<blue>	return sp->role.access;</blue>
}

<blue>static void kvm_mmu_page_set_translation(struct kvm_mmu_page *sp, int index,</blue>
					 gfn_t gfn, unsigned int access)
{
<blue>	if (sp_has_gptes(sp)) {</blue>
<blue>		sp->shadowed_translation[index] = (gfn << PAGE_SHIFT) | access;</blue>
		return;
	}

<blue>	WARN_ONCE(access != kvm_mmu_page_get_access(sp, index),</blue>
	          &quot;access mismatch under %s page %llx (expected %u, got %u)\n&quot;,
	          sp-&gt;role.passthrough ? &quot;passthrough&quot; : &quot;direct&quot;,
	          sp-&gt;gfn, kvm_mmu_page_get_access(sp, index), access);

<blue>	WARN_ONCE(gfn != kvm_mmu_page_get_gfn(sp, index),</blue>
	          &quot;gfn mismatch under %s page %llx (expected %llx, got %llx)\n&quot;,
	          sp-&gt;role.passthrough ? &quot;passthrough&quot; : &quot;direct&quot;,
	          sp-&gt;gfn, kvm_mmu_page_get_gfn(sp, index), gfn);
<blue>}</blue>

static void kvm_mmu_page_set_access(struct kvm_mmu_page *sp, int index,
				    unsigned int access)
{
<yellow>	gfn_t gfn = kvm_mmu_page_get_gfn(sp, index);</yellow>

	kvm_mmu_page_set_translation(sp, index, gfn, access);
}

/*
 * Return the pointer to the large page information for a given gfn,
 * handling slots that are not large page aligned.
 */
static struct kvm_lpage_info *lpage_info_slot(gfn_t gfn,
		const struct kvm_memory_slot *slot, int level)
{
	unsigned long idx;

<blue>	idx = gfn_to_index(gfn, slot->base_gfn, level);</blue>
	return &amp;slot-&gt;arch.lpage_info[level - 2][idx];
}

static void update_gfn_disallow_lpage_count(const struct kvm_memory_slot *slot,
					    gfn_t gfn, int count)
{
	struct kvm_lpage_info *linfo;
	int i;

	for (i = PG_LEVEL_2M; i &lt;= KVM_MAX_HUGEPAGE_LEVEL; ++i) {
<blue>		linfo = lpage_info_slot(gfn, slot, i);</blue>
		linfo-&gt;disallow_lpage += count;
<yellow>		WARN_ON(linfo->disallow_lpage < 0);</yellow>
	}
<blue>}</blue>

void kvm_mmu_gfn_disallow_lpage(const struct kvm_memory_slot *slot, gfn_t gfn)
{
<blue>	update_gfn_disallow_lpage_count(slot, gfn, 1);</blue>
}

void kvm_mmu_gfn_allow_lpage(const struct kvm_memory_slot *slot, gfn_t gfn)
{
<blue>	update_gfn_disallow_lpage_count(slot, gfn, -1);</blue>
}

static void account_shadowed(struct kvm *kvm, struct kvm_mmu_page *sp)
{
	struct kvm_memslots *slots;
	struct kvm_memory_slot *slot;
	gfn_t gfn;

<blue>	kvm->arch.indirect_shadow_pages++;</blue>
	gfn = sp-&gt;gfn;
	slots = kvm_memslots_for_spte_role(kvm, sp-&gt;role);
<blue>	slot = __gfn_to_memslot(slots, gfn);</blue>

	/* the non-leaf shadow pages are keeping readonly. */
<blue>	if (sp->role.level > PG_LEVEL_4K)</blue>
<blue>		return kvm_slot_page_track_add_page(kvm, slot, gfn,</blue>
						    KVM_PAGE_TRACK_WRITE);

<yellow>	kvm_mmu_gfn_disallow_lpage(slot, gfn);</yellow>

	if (kvm_mmu_slot_gfn_write_protect(kvm, slot, gfn, PG_LEVEL_4K))
<yellow>		kvm_flush_remote_tlbs_with_address(kvm, gfn, 1);</yellow>
}

<yellow>void account_huge_nx_page(struct kvm *kvm, struct kvm_mmu_page *sp)</yellow>
{
<yellow>	if (sp->lpage_disallowed)</yellow>
		return;

<yellow>	++kvm->stat.nx_lpage_splits;</yellow>
	list_add_tail(&amp;sp-&gt;lpage_disallowed_link,
		      &amp;kvm-&gt;arch.lpage_disallowed_mmu_pages);
	sp-&gt;lpage_disallowed = true;
<yellow>}</yellow>

static void unaccount_shadowed(struct kvm *kvm, struct kvm_mmu_page *sp)
{
	struct kvm_memslots *slots;
	struct kvm_memory_slot *slot;
	gfn_t gfn;

<blue>	kvm->arch.indirect_shadow_pages--;</blue>
	gfn = sp-&gt;gfn;
	slots = kvm_memslots_for_spte_role(kvm, sp-&gt;role);
<blue>	slot = __gfn_to_memslot(slots, gfn);</blue>
<blue>	if (sp->role.level > PG_LEVEL_4K)</blue>
<blue>		return kvm_slot_page_track_remove_page(kvm, slot, gfn,</blue>
						       KVM_PAGE_TRACK_WRITE);

<yellow>	kvm_mmu_gfn_allow_lpage(slot, gfn);</yellow>
}

void unaccount_huge_nx_page(struct kvm *kvm, struct kvm_mmu_page *sp)
{
<yellow>	--kvm->stat.nx_lpage_splits;</yellow>
	sp-&gt;lpage_disallowed = false;
	list_del(&amp;sp-&gt;lpage_disallowed_link);
}

static struct kvm_memory_slot *
gfn_to_memslot_dirty_bitmap(struct kvm_vcpu *vcpu, gfn_t gfn,
			    bool no_dirty_log)
{
	struct kvm_memory_slot *slot;

<yellow>	slot = kvm_vcpu_gfn_to_memslot(vcpu, gfn);</yellow>
<blue>	if (!slot || slot->flags & KVM_MEMSLOT_INVALID)</blue>
		return NULL;
<blue>	if (no_dirty_log && kvm_slot_dirty_track_enabled(slot))</blue>
		return NULL;

	return slot;
}

/*
 * About rmap_head encoding:
 *
 * If the bit zero of rmap_head-&gt;val is clear, then it points to the only spte
 * in this rmap chain. Otherwise, (rmap_head-&gt;val &amp; ~1) points to a struct
 * pte_list_desc containing more mappings.
 */

/*
 * Returns the number of pointers in the rmap chain, not counting the new one.
 */
static int pte_list_add(struct kvm_mmu_memory_cache *cache, u64 *spte,
			struct kvm_rmap_head *rmap_head)
{
	struct pte_list_desc *desc;
	int count = 0;

<blue>	if (!rmap_head->val) {</blue>
		rmap_printk(&quot;%p %llx 0-&gt;1\n&quot;, spte, *spte);
<blue>		rmap_head->val = (unsigned long)spte;</blue>
<blue>	} else if (!(rmap_head->val & 1)) {</blue>
		rmap_printk(&quot;%p %llx 1-&gt;many\n&quot;, spte, *spte);
<blue>		desc = kvm_mmu_memory_cache_alloc(cache);</blue>
		desc-&gt;sptes[0] = (u64 *)rmap_head-&gt;val;
		desc-&gt;sptes[1] = spte;
		desc-&gt;spte_count = 2;
		rmap_head-&gt;val = (unsigned long)desc | 1;
		++count;
	} else {
		rmap_printk(&quot;%p %llx many-&gt;many\n&quot;, spte, *spte);
<yellow>		desc = (struct pte_list_desc *)(rmap_head->val & ~1ul);</yellow>
<yellow>		while (desc->spte_count == PTE_LIST_EXT) {</yellow>
			count += PTE_LIST_EXT;
<yellow>			if (!desc->more) {</yellow>
<yellow>				desc->more = kvm_mmu_memory_cache_alloc(cache);</yellow>
				desc = desc-&gt;more;
				desc-&gt;spte_count = 0;
				break;
			}
			desc = desc-&gt;more;
		}
		count += desc-&gt;spte_count;
<yellow>		desc->sptes[desc->spte_count++] = spte;</yellow>
	}
	return count;
<blue>}</blue>

static void
pte_list_desc_remove_entry(struct kvm_rmap_head *rmap_head,
			   struct pte_list_desc *desc, int i,
			   struct pte_list_desc *prev_desc)
{
<blue>	int j = desc->spte_count - 1;</blue>

	desc-&gt;sptes[i] = desc-&gt;sptes[j];
	desc-&gt;sptes[j] = NULL;
	desc-&gt;spte_count--;
	if (desc-&gt;spte_count)
		return;
<yellow>	if (!prev_desc && !desc->more)</yellow>
<yellow>		rmap_head->val = 0;</yellow>
	else
		if (prev_desc)
<yellow>			prev_desc->more = desc->more;</yellow>
		else
<yellow>			rmap_head->val = (unsigned long)desc->more | 1;</yellow>
<yellow>	mmu_free_pte_list_desc(desc);</yellow>
}

static void pte_list_remove(u64 *spte, struct kvm_rmap_head *rmap_head)
{
	struct pte_list_desc *desc;
	struct pte_list_desc *prev_desc;
	int i;

<blue>	if (!rmap_head->val) {</blue>
		pr_err(&quot;%s: %p 0-&gt;BUG\n&quot;, __func__, spte);
		BUG();
<blue>	} else if (!(rmap_head->val & 1)) {</blue>
		rmap_printk(&quot;%p 1-&gt;0\n&quot;, spte);
<blue>		if ((u64 *)rmap_head->val != spte) {</blue>
			pr_err(&quot;%s:  %p 1-&gt;BUG\n&quot;, __func__, spte);
			BUG();
		}
<blue>		rmap_head->val = 0;</blue>
	} else {
		rmap_printk(&quot;%p many-&gt;many\n&quot;, spte);
<blue>		desc = (struct pte_list_desc *)(rmap_head->val & ~1ul);</blue>
		prev_desc = NULL;
		while (desc) {
<blue>			for (i = 0; i < desc->spte_count; ++i) {</blue>
<blue>				if (desc->sptes[i] == spte) {</blue>
<blue>					pte_list_desc_remove_entry(rmap_head,</blue>
							desc, i, prev_desc);
					return;
				}
			}
			prev_desc = desc;
<yellow>			desc = desc->more;</yellow>
		}
		pr_err(&quot;%s: %p many-&gt;many\n&quot;, __func__, spte);
		BUG();
	}
<blue>}</blue>

static void kvm_zap_one_rmap_spte(struct kvm *kvm,
				  struct kvm_rmap_head *rmap_head, u64 *sptep)
{
<yellow>	mmu_spte_clear_track_bits(kvm, sptep);</yellow>
	pte_list_remove(sptep, rmap_head);
}

/* Return true if at least one SPTE was zapped, false otherwise */
static bool kvm_zap_all_rmap_sptes(struct kvm *kvm,
				   struct kvm_rmap_head *rmap_head)
{
	struct pte_list_desc *desc, *next;
	int i;

<blue>	if (!rmap_head->val)</blue>
		return false;

<blue>	if (!(rmap_head->val & 1)) {</blue>
<blue>		mmu_spte_clear_track_bits(kvm, (u64 *)rmap_head->val);</blue>
		goto out;
	}

<blue>	desc = (struct pte_list_desc *)(rmap_head->val & ~1ul);</blue>

	for (; desc; desc = next) {
<blue>		for (i = 0; i < desc->spte_count; i++)</blue>
<blue>			mmu_spte_clear_track_bits(kvm, desc->sptes[i]);</blue>
<blue>		next = desc->more;</blue>
		mmu_free_pte_list_desc(desc);
	}
out:
	/* rmap_head is meaningless now, remember to reset it */
<blue>	rmap_head->val = 0;</blue>
	return true;
<blue>}</blue>

unsigned int pte_list_count(struct kvm_rmap_head *rmap_head)
{
	struct pte_list_desc *desc;
	unsigned int count = 0;

<yellow>	if (!rmap_head->val)</yellow>
<yellow>		return 0;</yellow>
<yellow>	else if (!(rmap_head->val & 1))</yellow>
		return 1;

<yellow>	desc = (struct pte_list_desc *)(rmap_head->val & ~1ul);</yellow>

	while (desc) {
<yellow>		count += desc->spte_count;</yellow>
		desc = desc-&gt;more;
	}

	return count;
<yellow>}</yellow>

static struct kvm_rmap_head *gfn_to_rmap(gfn_t gfn, int level,
					 const struct kvm_memory_slot *slot)
{
	unsigned long idx;

<blue>	idx = gfn_to_index(gfn, slot->base_gfn, level);</blue>
	return &amp;slot-&gt;arch.rmap[level - PG_LEVEL_4K][idx];
}

static bool rmap_can_add(struct kvm_vcpu *vcpu)
{
	struct kvm_mmu_memory_cache *mc;

<yellow>	mc = &vcpu->arch.mmu_pte_list_desc_cache;</yellow>
	return kvm_mmu_memory_cache_nr_free_objects(mc);
}

static void rmap_remove(struct kvm *kvm, u64 *spte)
{
	struct kvm_memslots *slots;
	struct kvm_memory_slot *slot;
	struct kvm_mmu_page *sp;
	gfn_t gfn;
	struct kvm_rmap_head *rmap_head;

<blue>	sp = sptep_to_sp(spte);</blue>
	gfn = kvm_mmu_page_get_gfn(sp, spte_index(spte));

	/*
	 * Unlike rmap_add, rmap_remove does not run in the context of a vCPU
	 * so we have to determine which memslots to use based on context
	 * information in sp-&gt;role.
	 */
	slots = kvm_memslots_for_spte_role(kvm, sp-&gt;role);

<blue>	slot = __gfn_to_memslot(slots, gfn);</blue>
<blue>	rmap_head = gfn_to_rmap(gfn, sp->role.level, slot);</blue>

	pte_list_remove(spte, rmap_head);
}

/*
 * Used by the following functions to iterate through the sptes linked by a
 * rmap.  All fields are private and not assumed to be used outside.
 */
struct rmap_iterator {
	/* private fields */
	struct pte_list_desc *desc;	/* holds the sptep if not NULL */
	int pos;			/* index of the sptep */
};

/*
 * Iteration must be started by this function.  This should also be used after
 * removing/dropping sptes from the rmap link because in such cases the
 * information in the iterator may not be valid.
 *
 * Returns sptep if found, NULL otherwise.
 */
static u64 *rmap_get_first(struct kvm_rmap_head *rmap_head,
			   struct rmap_iterator *iter)
{
	u64 *sptep;

<blue>	if (!rmap_head->val)</blue>
		return NULL;

<blue>	if (!(rmap_head->val & 1)) {</blue>
<yellow>		iter->desc = NULL;</yellow>
<yellow>		sptep = (u64 *)rmap_head->val;</yellow>
<blue>		goto out;</blue>
	}

<yellow>	iter->desc = (struct pte_list_desc *)(rmap_head->val & ~1ul);</yellow>
<yellow>	iter->pos = 0;</yellow>
	sptep = iter-&gt;desc-&gt;sptes[iter-&gt;pos];
out:
<blue>	BUG_ON(!is_shadow_present_pte(*sptep));</blue>
	return sptep;
}

/*
 * Must be used with a valid iterator: e.g. after rmap_get_first().
 *
 * Returns sptep if found, NULL otherwise.
 */
static u64 *rmap_get_next(struct rmap_iterator *iter)
{
	u64 *sptep;

<blue>	if (iter->desc) {</blue>
<yellow>		if (iter->pos < PTE_LIST_EXT - 1) {</yellow>
<yellow>			++iter->pos;</yellow>
			sptep = iter-&gt;desc-&gt;sptes[iter-&gt;pos];
			if (sptep)
				goto out;
		}

<yellow>		iter->desc = iter->desc->more;</yellow>

		if (iter-&gt;desc) {
			iter-&gt;pos = 0;
			/* desc-&gt;sptes[0] cannot be NULL */
<yellow>			sptep = iter->desc->sptes[iter->pos];</yellow>
			goto out;
		}
	}

<yellow>	return NULL;</yellow>
out:
<yellow>	BUG_ON(!is_shadow_present_pte(*sptep));</yellow>
	return sptep;
<yellow>}</yellow>

#define for_each_rmap_spte(_rmap_head_, _iter_, _spte_)			\
	for (_spte_ = rmap_get_first(_rmap_head_, _iter_);		\
	     _spte_; _spte_ = rmap_get_next(_iter_))

static void drop_spte(struct kvm *kvm, u64 *sptep)
{
<blue>	u64 old_spte = mmu_spte_clear_track_bits(kvm, sptep);</blue>

	if (is_shadow_present_pte(old_spte))
<blue>		rmap_remove(kvm, sptep);</blue>
<blue>}</blue>

static void drop_large_spte(struct kvm *kvm, u64 *sptep, bool flush)
{
	struct kvm_mmu_page *sp;

<yellow>	sp = sptep_to_sp(sptep);</yellow>
<yellow>	WARN_ON(sp->role.level == PG_LEVEL_4K);</yellow>

<yellow>	drop_spte(kvm, sptep);</yellow>

	if (flush)
<yellow>		kvm_flush_remote_tlbs_with_address(kvm, sp->gfn,</yellow>
<yellow>			KVM_PAGES_PER_HPAGE(sp->role.level));</yellow>
}

/*
 * Write-protect on the specified @sptep, @pt_protect indicates whether
 * spte write-protection is caused by protecting shadow page table.
 *
 * Note: write protection is difference between dirty logging and spte
 * protection:
 * - for dirty logging, the spte can be set to writable at anytime if
 *   its dirty bitmap is properly set.
 * - for spte protection, the spte can be writable only after unsync-ing
 *   shadow page.
 *
 * Return true if tlb need be flushed.
 */
static bool spte_write_protect(u64 *sptep, bool pt_protect)
{
<blue>	u64 spte = *sptep;</blue>

<blue>	if (!is_writable_pte(spte) &&</blue>
<blue>	    !(pt_protect && is_mmu_writable_spte(spte)))</blue>
		return false;

	rmap_printk(&quot;spte %p %llx\n&quot;, sptep, *sptep);

<blue>	if (pt_protect)</blue>
<blue>		spte &= ~shadow_mmu_writable_mask;</blue>
<blue>	spte = spte & ~PT_WRITABLE_MASK;</blue>

	return mmu_spte_update(sptep, spte);
}

static bool rmap_write_protect(struct kvm_rmap_head *rmap_head,
			       bool pt_protect)
{
	u64 *sptep;
	struct rmap_iterator iter;
	bool flush = false;

<blue>	for_each_rmap_spte(rmap_head, &iter, sptep)</blue>
<blue>		flush |= spte_write_protect(sptep, pt_protect);</blue>

	return flush;
<blue>}</blue>

static bool spte_clear_dirty(u64 *sptep)
{
	u64 spte = *sptep;

	rmap_printk(&quot;spte %p %llx\n&quot;, sptep, *sptep);

	MMU_WARN_ON(!spte_ad_enabled(spte));
<yellow>	spte &= ~shadow_dirty_mask;</yellow>
	return mmu_spte_update(sptep, spte);
}

static bool spte_wrprot_for_clear_dirty(u64 *sptep)
{
<yellow>	bool was_writable = test_and_clear_bit(PT_WRITABLE_SHIFT,</yellow>
					       (unsigned long *)sptep);
<yellow>	if (was_writable && !spte_ad_enabled(*sptep))</yellow>
<yellow>		kvm_set_pfn_dirty(spte_to_pfn(*sptep));</yellow>

	return was_writable;
}

/*
 * Gets the GFN ready for another round of dirty logging by clearing the
 *	- D bit on ad-enabled SPTEs, and
 *	- W bit on ad-disabled SPTEs.
 * Returns true iff any D or W bits were cleared.
 */
static bool __rmap_clear_dirty(struct kvm *kvm, struct kvm_rmap_head *rmap_head,
			       const struct kvm_memory_slot *slot)
{
	u64 *sptep;
	struct rmap_iterator iter;
	bool flush = false;

<yellow>	for_each_rmap_spte(rmap_head, &iter, sptep)</yellow>
<yellow>		if (spte_ad_need_write_protect(*sptep))</yellow>
<yellow>			flush |= spte_wrprot_for_clear_dirty(sptep);</yellow>
		else
<yellow>			flush |= spte_clear_dirty(sptep);</yellow>

	return flush;
<yellow>}</yellow>

/**
 * kvm_mmu_write_protect_pt_masked - write protect selected PT level pages
 * @kvm: kvm instance
 * @slot: slot to protect
 * @gfn_offset: start of the BITS_PER_LONG pages we care about
 * @mask: indicates which pages we should protect
 *
 * Used when we do not need to care about huge page mappings.
 */
static void kvm_mmu_write_protect_pt_masked(struct kvm *kvm,
				     struct kvm_memory_slot *slot,
				     gfn_t gfn_offset, unsigned long mask)
{
	struct kvm_rmap_head *rmap_head;

<yellow>	if (is_tdp_mmu_enabled(kvm))</yellow>
		kvm_tdp_mmu_clear_dirty_pt_masked(kvm, slot,
<yellow>				slot->base_gfn + gfn_offset, mask, true);</yellow>

<yellow>	if (!kvm_memslots_have_rmaps(kvm))</yellow>
		return;

<yellow>	while (mask) {</yellow>
<yellow>		rmap_head = gfn_to_rmap(slot->base_gfn + gfn_offset + __ffs(mask),</yellow>
					PG_LEVEL_4K, slot);
		rmap_write_protect(rmap_head, false);

		/* clear the first set bit */
		mask &amp;= mask - 1;
	}
}

/**
 * kvm_mmu_clear_dirty_pt_masked - clear MMU D-bit for PT level pages, or write
 * protect the page if the D-bit isn&#x27;t supported.
 * @kvm: kvm instance
 * @slot: slot to clear D-bit
 * @gfn_offset: start of the BITS_PER_LONG pages we care about
 * @mask: indicates which pages we should clear D-bit
 *
 * Used for PML to re-log the dirty GPAs after userspace querying dirty_bitmap.
 */
static void kvm_mmu_clear_dirty_pt_masked(struct kvm *kvm,
					 struct kvm_memory_slot *slot,
					 gfn_t gfn_offset, unsigned long mask)
{
	struct kvm_rmap_head *rmap_head;

<yellow>	if (is_tdp_mmu_enabled(kvm))</yellow>
		kvm_tdp_mmu_clear_dirty_pt_masked(kvm, slot,
<yellow>				slot->base_gfn + gfn_offset, mask, false);</yellow>

<yellow>	if (!kvm_memslots_have_rmaps(kvm))</yellow>
		return;

<yellow>	while (mask) {</yellow>
<yellow>		rmap_head = gfn_to_rmap(slot->base_gfn + gfn_offset + __ffs(mask),</yellow>
					PG_LEVEL_4K, slot);
		__rmap_clear_dirty(kvm, rmap_head, slot);

		/* clear the first set bit */
		mask &amp;= mask - 1;
	}
}

/**
 * kvm_arch_mmu_enable_log_dirty_pt_masked - enable dirty logging for selected
 * PT level pages.
 *
 * It calls kvm_mmu_write_protect_pt_masked to write protect selected pages to
 * enable dirty logging for them.
 *
 * We need to care about huge page mappings: e.g. during dirty logging we may
 * have such mappings.
 */
void kvm_arch_mmu_enable_log_dirty_pt_masked(struct kvm *kvm,
				struct kvm_memory_slot *slot,
				gfn_t gfn_offset, unsigned long mask)
{
	/*
	 * Huge pages are NOT write protected when we start dirty logging in
	 * initially-all-set mode; must write protect them here so that they
	 * are split to 4K on the first write.
	 *
	 * The gfn_offset is guaranteed to be aligned to 64, but the base_gfn
	 * of memslot has no such restriction, so the range can cross two large
	 * pages.
	 */
<yellow>	if (kvm_dirty_log_manual_protect_and_init_set(kvm)) {</yellow>
<yellow>		gfn_t start = slot->base_gfn + gfn_offset + __ffs(mask);</yellow>
		gfn_t end = slot-&gt;base_gfn + gfn_offset + __fls(mask);

<yellow>		if (READ_ONCE(eager_page_split))</yellow>
<yellow>			kvm_mmu_try_split_huge_pages(kvm, slot, start, end, PG_LEVEL_4K);</yellow>

<yellow>		kvm_mmu_slot_gfn_write_protect(kvm, slot, start, PG_LEVEL_2M);</yellow>

		/* Cross two large pages? */
		if (ALIGN(start &lt;&lt; PAGE_SHIFT, PMD_SIZE) !=
		    ALIGN(end &lt;&lt; PAGE_SHIFT, PMD_SIZE))
<yellow>			kvm_mmu_slot_gfn_write_protect(kvm, slot, end,</yellow>
						       PG_LEVEL_2M);
	}

	/* Now handle 4K PTEs.  */
<yellow>	if (kvm_x86_ops.cpu_dirty_log_size)</yellow>
<yellow>		kvm_mmu_clear_dirty_pt_masked(kvm, slot, gfn_offset, mask);</yellow>
	else
<yellow>		kvm_mmu_write_protect_pt_masked(kvm, slot, gfn_offset, mask);</yellow>
<yellow>}</yellow>

int kvm_cpu_dirty_log_size(void)
{
<yellow>	return kvm_x86_ops.cpu_dirty_log_size;</yellow>
}

bool kvm_mmu_slot_gfn_write_protect(struct kvm *kvm,
				    struct kvm_memory_slot *slot, u64 gfn,
				    int min_level)
{
	struct kvm_rmap_head *rmap_head;
	int i;
	bool write_protected = false;

<blue>	if (kvm_memslots_have_rmaps(kvm)) {</blue>
<blue>		for (i = min_level; i <= KVM_MAX_HUGEPAGE_LEVEL; ++i) {</blue>
<blue>			rmap_head = gfn_to_rmap(gfn, i, slot);</blue>
			write_protected |= rmap_write_protect(rmap_head, true);
		}
	}

<blue>	if (is_tdp_mmu_enabled(kvm))</blue>
		write_protected |=
<blue>			kvm_tdp_mmu_write_protect_gfn(kvm, slot, gfn, min_level);</blue>

	return write_protected;
<blue>}</blue>

static bool kvm_vcpu_write_protect_gfn(struct kvm_vcpu *vcpu, u64 gfn)
{
	struct kvm_memory_slot *slot;

	slot = kvm_vcpu_gfn_to_memslot(vcpu, gfn);
	return kvm_mmu_slot_gfn_write_protect(vcpu-&gt;kvm, slot, gfn, PG_LEVEL_4K);
}

static bool __kvm_zap_rmap(struct kvm *kvm, struct kvm_rmap_head *rmap_head,
			   const struct kvm_memory_slot *slot)
{
<blue>	return kvm_zap_all_rmap_sptes(kvm, rmap_head);</blue>
}

static bool kvm_zap_rmap(struct kvm *kvm, struct kvm_rmap_head *rmap_head,
			 struct kvm_memory_slot *slot, gfn_t gfn, int level,
			 pte_t unused)
{
<blue>	return __kvm_zap_rmap(kvm, rmap_head, slot);</blue>
}

static bool kvm_set_pte_rmap(struct kvm *kvm, struct kvm_rmap_head *rmap_head,
			     struct kvm_memory_slot *slot, gfn_t gfn, int level,
			     pte_t pte)
{
	u64 *sptep;
	struct rmap_iterator iter;
	bool need_flush = false;
	u64 new_spte;
	kvm_pfn_t new_pfn;

<blue>	WARN_ON(pte_huge(pte));</blue>
<blue>	new_pfn = pte_pfn(pte);</blue>

restart:
<yellow>	for_each_rmap_spte(rmap_head, &iter, sptep) {</yellow>
		rmap_printk(&quot;spte %p %llx gfn %llx (%d)\n&quot;,
			    sptep, *sptep, gfn, level);

		need_flush = true;

<yellow>		if (pte_write(pte)) {</yellow>
<yellow>			kvm_zap_one_rmap_spte(kvm, rmap_head, sptep);</yellow>
			goto restart;
		} else {
<yellow>			new_spte = kvm_mmu_changed_pte_notifier_make_spte(</yellow>
					*sptep, new_pfn);

			mmu_spte_clear_track_bits(kvm, sptep);
<yellow>			mmu_spte_set(sptep, new_spte);</yellow>
		}
	}

<yellow>	if (need_flush && kvm_available_flush_tlb_with_range()) {</yellow>
<yellow>		kvm_flush_remote_tlbs_with_address(kvm, gfn, 1);</yellow>
<yellow>		return false;</yellow>
	}

	return need_flush;
}

struct slot_rmap_walk_iterator {
	/* input fields. */
	const struct kvm_memory_slot *slot;
	gfn_t start_gfn;
	gfn_t end_gfn;
	int start_level;
	int end_level;

	/* output fields. */
	gfn_t gfn;
	struct kvm_rmap_head *rmap;
	int level;

	/* private field. */
	struct kvm_rmap_head *end_rmap;
};

static void
rmap_walk_init_level(struct slot_rmap_walk_iterator *iterator, int level)
{
<blue>	iterator->level = level;</blue>
	iterator-&gt;gfn = iterator-&gt;start_gfn;
<blue>	iterator->rmap = gfn_to_rmap(iterator->gfn, level, iterator->slot);</blue>
<blue>	iterator->end_rmap = gfn_to_rmap(iterator->end_gfn, level, iterator->slot);</blue>
}

static void
slot_rmap_walk_init(struct slot_rmap_walk_iterator *iterator,
		    const struct kvm_memory_slot *slot, int start_level,
		    int end_level, gfn_t start_gfn, gfn_t end_gfn)
{
<yellow>	iterator->slot = slot;</yellow>
	iterator-&gt;start_level = start_level;
	iterator-&gt;end_level = end_level;
	iterator-&gt;start_gfn = start_gfn;
	iterator-&gt;end_gfn = end_gfn;

	rmap_walk_init_level(iterator, iterator-&gt;start_level);
}

static bool slot_rmap_walk_okay(struct slot_rmap_walk_iterator *iterator)
{
	return !!iterator-&gt;rmap;
}

static void slot_rmap_walk_next(struct slot_rmap_walk_iterator *iterator)
{
<blue>	while (++iterator->rmap <= iterator->end_rmap) {</blue>
<blue>		iterator->gfn += (1UL << KVM_HPAGE_GFN_SHIFT(iterator->level));</blue>

		if (iterator-&gt;rmap-&gt;val)
			return;
	}

<blue>	if (++iterator->level > iterator->end_level) {</blue>
<blue>		iterator->rmap = NULL;</blue>
		return;
	}

<blue>	rmap_walk_init_level(iterator, iterator->level);</blue>
<blue>}</blue>

#define for_each_slot_rmap_range(_slot_, _start_level_, _end_level_,	\
	   _start_gfn, _end_gfn, _iter_)				\
	for (slot_rmap_walk_init(_iter_, _slot_, _start_level_,		\
				 _end_level_, _start_gfn, _end_gfn);	\
	     slot_rmap_walk_okay(_iter_);				\
	     slot_rmap_walk_next(_iter_))

typedef bool (*rmap_handler_t)(struct kvm *kvm, struct kvm_rmap_head *rmap_head,
			       struct kvm_memory_slot *slot, gfn_t gfn,
			       int level, pte_t pte);

static __always_inline bool kvm_handle_gfn_range(struct kvm *kvm,
						 struct kvm_gfn_range *range,
						 rmap_handler_t handler)
{
	struct slot_rmap_walk_iterator iterator;
	bool ret = false;

<blue>	for_each_slot_rmap_range(range->slot, PG_LEVEL_4K, KVM_MAX_HUGEPAGE_LEVEL,</blue>
				 range-&gt;start, range-&gt;end - 1, &amp;iterator)
<blue>		ret |= handler(kvm, iterator.rmap, range->slot, iterator.gfn,</blue>
			       iterator.level, range-&gt;pte);

<blue>	return ret;</blue>
}

bool kvm_unmap_gfn_range(struct kvm *kvm, struct kvm_gfn_range *range)
<blue>{</blue>
	bool flush = false;

<blue>	if (kvm_memslots_have_rmaps(kvm))</blue>
<blue>		flush = kvm_handle_gfn_range(kvm, range, kvm_zap_rmap);</blue>

<blue>	if (is_tdp_mmu_enabled(kvm))</blue>
<blue>		flush = kvm_tdp_mmu_unmap_gfn_range(kvm, range, flush);</blue>

	return flush;
}

bool kvm_set_spte_gfn(struct kvm *kvm, struct kvm_gfn_range *range)
<blue>{</blue>
	bool flush = false;

<blue>	if (kvm_memslots_have_rmaps(kvm))</blue>
<blue>		flush = kvm_handle_gfn_range(kvm, range, kvm_set_pte_rmap);</blue>

<blue>	if (is_tdp_mmu_enabled(kvm))</blue>
<blue>		flush |= kvm_tdp_mmu_set_spte_gfn(kvm, range);</blue>

	return flush;
}

static bool kvm_age_rmap(struct kvm *kvm, struct kvm_rmap_head *rmap_head,
			 struct kvm_memory_slot *slot, gfn_t gfn, int level,
			 pte_t unused)
{
	u64 *sptep;
	struct rmap_iterator iter;
	int young = 0;

<yellow>	for_each_rmap_spte(rmap_head, &iter, sptep)</yellow>
<yellow>		young |= mmu_spte_age(sptep);</yellow>

	return young;
}

static bool kvm_test_age_rmap(struct kvm *kvm, struct kvm_rmap_head *rmap_head,
			      struct kvm_memory_slot *slot, gfn_t gfn,
			      int level, pte_t unused)
{
	u64 *sptep;
	struct rmap_iterator iter;

<yellow>	for_each_rmap_spte(rmap_head, &iter, sptep)</yellow>
<yellow>		if (is_accessed_spte(*sptep))</yellow>
			return true;
	return false;
}

#define RMAP_RECYCLE_THRESHOLD 1000

static void __rmap_add(struct kvm *kvm,
		       struct kvm_mmu_memory_cache *cache,
		       const struct kvm_memory_slot *slot,
		       u64 *spte, gfn_t gfn, unsigned int access)
<blue>{</blue>
	struct kvm_mmu_page *sp;
	struct kvm_rmap_head *rmap_head;
	int rmap_count;

<blue>	sp = sptep_to_sp(spte);</blue>
	kvm_mmu_page_set_translation(sp, spte_index(spte), gfn, access);
	kvm_update_page_stats(kvm, sp-&gt;role.level, 1);

	rmap_head = gfn_to_rmap(gfn, sp-&gt;role.level, slot);
	rmap_count = pte_list_add(cache, spte, rmap_head);

	if (rmap_count &gt; kvm-&gt;stat.max_mmu_rmap_size)
<blue>		kvm->stat.max_mmu_rmap_size = rmap_count;</blue>
<blue>	if (rmap_count > RMAP_RECYCLE_THRESHOLD) {</blue>
<yellow>		kvm_zap_all_rmap_sptes(kvm, rmap_head);</yellow>
<yellow>		kvm_flush_remote_tlbs_with_address(</yellow>
<yellow>				kvm, sp->gfn, KVM_PAGES_PER_HPAGE(sp->role.level));</yellow>
	}
}

static void rmap_add(struct kvm_vcpu *vcpu, const struct kvm_memory_slot *slot,
		     u64 *spte, gfn_t gfn, unsigned int access)
{
<blue>	struct kvm_mmu_memory_cache *cache = &vcpu->arch.mmu_pte_list_desc_cache;</blue>

	__rmap_add(vcpu-&gt;kvm, cache, slot, spte, gfn, access);
}

bool kvm_age_gfn(struct kvm *kvm, struct kvm_gfn_range *range)
<blue>{</blue>
	bool young = false;

<blue>	if (kvm_memslots_have_rmaps(kvm))</blue>
<yellow>		young = kvm_handle_gfn_range(kvm, range, kvm_age_rmap);</yellow>

<blue>	if (is_tdp_mmu_enabled(kvm))</blue>
<blue>		young |= kvm_tdp_mmu_age_gfn_range(kvm, range);</blue>

	return young;
}

bool kvm_test_age_gfn(struct kvm *kvm, struct kvm_gfn_range *range)
<yellow>{</yellow>
	bool young = false;

<yellow>	if (kvm_memslots_have_rmaps(kvm))</yellow>
<yellow>		young = kvm_handle_gfn_range(kvm, range, kvm_test_age_rmap);</yellow>

<yellow>	if (is_tdp_mmu_enabled(kvm))</yellow>
<yellow>		young |= kvm_tdp_mmu_test_age_gfn(kvm, range);</yellow>

	return young;
}

#ifdef MMU_DEBUG
static int is_empty_shadow_page(u64 *spt)
{
	u64 *pos;
	u64 *end;

	for (pos = spt, end = pos + PAGE_SIZE / sizeof(u64); pos != end; pos++)
		if (is_shadow_present_pte(*pos)) {
			printk(KERN_ERR &quot;%s: %p %llx\n&quot;, __func__,
			       pos, *pos);
			return 0;
		}
	return 1;
}
#endif

/*
 * This value is the sum of all of the kvm instances&#x27;s
 * kvm-&gt;arch.n_used_mmu_pages values.  We need a global,
 * aggregate version in order to make the slab shrinker
 * faster
 */
static inline void kvm_mod_used_mmu_pages(struct kvm *kvm, long nr)
{
<blue>	kvm->arch.n_used_mmu_pages += nr;</blue>
	percpu_counter_add(&amp;kvm_total_used_mmu_pages, nr);
}

static void kvm_account_mmu_page(struct kvm *kvm, struct kvm_mmu_page *sp)
{
	kvm_mod_used_mmu_pages(kvm, +1);
<blue>	kvm_account_pgtable_pages((void *)sp->spt, +1);</blue>
}

static void kvm_unaccount_mmu_page(struct kvm *kvm, struct kvm_mmu_page *sp)
{
<blue>	kvm_mod_used_mmu_pages(kvm, -1);</blue>
<blue>	kvm_account_pgtable_pages((void *)sp->spt, -1);</blue>
}

static void kvm_mmu_free_shadow_page(struct kvm_mmu_page *sp)
{
	MMU_WARN_ON(!is_empty_shadow_page(sp-&gt;spt));
<blue>	hlist_del(&sp->hash_link);</blue>
<blue>	list_del(&sp->link);</blue>
	free_page((unsigned long)sp-&gt;spt);
	if (!sp-&gt;role.direct)
<blue>		free_page((unsigned long)sp->shadowed_translation);</blue>
<blue>	kmem_cache_free(mmu_page_header_cache, sp);</blue>
}

static unsigned kvm_page_table_hashfn(gfn_t gfn)
{
<blue>	return hash_64(gfn, KVM_MMU_HASH_SHIFT);</blue>
}

static void mmu_page_add_parent_pte(struct kvm_mmu_memory_cache *cache,
				    struct kvm_mmu_page *sp, u64 *parent_pte)
{
	if (!parent_pte)
		return;

<blue>	pte_list_add(cache, parent_pte, &sp->parent_ptes);</blue>
}

static void mmu_page_remove_parent_pte(struct kvm_mmu_page *sp,
				       u64 *parent_pte)
{
<blue>	pte_list_remove(parent_pte, &sp->parent_ptes);</blue>
}

static void drop_parent_pte(struct kvm_mmu_page *sp,
			    u64 *parent_pte)
{
<blue>	mmu_page_remove_parent_pte(sp, parent_pte);</blue>
	mmu_spte_clear_no_track(parent_pte);
}

static void mark_unsync(u64 *spte);
static void kvm_mmu_mark_parents_unsync(struct kvm_mmu_page *sp)
{
	u64 *sptep;
	struct rmap_iterator iter;

<yellow>	for_each_rmap_spte(&sp->parent_ptes, &iter, sptep) {</yellow>
<yellow>		mark_unsync(sptep);</yellow>
	}
<yellow>}</yellow>

static void mark_unsync(u64 *spte)
{
	struct kvm_mmu_page *sp;

<yellow>	sp = sptep_to_sp(spte);</yellow>
	if (__test_and_set_bit(spte_index(spte), sp-&gt;unsync_child_bitmap))
		return;
<yellow>	if (sp->unsync_children++)</yellow>
		return;
<yellow>	kvm_mmu_mark_parents_unsync(sp);</yellow>
<yellow>}</yellow>

static int nonpaging_sync_page(struct kvm_vcpu *vcpu,
			       struct kvm_mmu_page *sp)
{
	return -1;
<yellow>}</yellow>

#define KVM_PAGE_ARRAY_NR 16

struct kvm_mmu_pages {
	struct mmu_page_and_offset {
		struct kvm_mmu_page *sp;
		unsigned int idx;
	} page[KVM_PAGE_ARRAY_NR];
	unsigned int nr;
};

static int mmu_pages_add(struct kvm_mmu_pages *pvec, struct kvm_mmu_page *sp,
			 int idx)
{
	int i;

<yellow>	if (sp->unsync)</yellow>
<yellow>		for (i=0; i < pvec->nr; i++)</yellow>
<yellow>			if (pvec->page[i].sp == sp)</yellow>
				return 0;

<yellow>	pvec->page[pvec->nr].sp = sp;</yellow>
	pvec-&gt;page[pvec-&gt;nr].idx = idx;
	pvec-&gt;nr++;
	return (pvec-&gt;nr == KVM_PAGE_ARRAY_NR);
<yellow>}</yellow>

static inline void clear_unsync_child_bit(struct kvm_mmu_page *sp, int idx)
{
<yellow>	--sp->unsync_children;</yellow>
<yellow>	WARN_ON((int)sp->unsync_children < 0);</yellow>
<yellow>	__clear_bit(idx, sp->unsync_child_bitmap);</yellow>
}

static int __mmu_unsync_walk(struct kvm_mmu_page *sp,
			   struct kvm_mmu_pages *pvec)
{
	int i, ret, nr_unsync_leaf = 0;

<yellow>	for_each_set_bit(i, sp->unsync_child_bitmap, 512) {</yellow>
		struct kvm_mmu_page *child;
<yellow>		u64 ent = sp->spt[i];</yellow>

<yellow>		if (!is_shadow_present_pte(ent) || is_large_pte(ent)) {</yellow>
<yellow>			clear_unsync_child_bit(sp, i);</yellow>
			continue;
		}

<yellow>		child = to_shadow_page(ent & SPTE_BASE_ADDR_MASK);</yellow>

		if (child-&gt;unsync_children) {
<yellow>			if (mmu_pages_add(pvec, child, i))</yellow>
				return -ENOSPC;

<yellow>			ret = __mmu_unsync_walk(child, pvec);</yellow>
			if (!ret) {
<yellow>				clear_unsync_child_bit(sp, i);</yellow>
				continue;
<yellow>			} else if (ret > 0) {</yellow>
<yellow>				nr_unsync_leaf += ret;</yellow>
			} else
				return ret;
<yellow>		} else if (child->unsync) {</yellow>
			nr_unsync_leaf++;
<yellow>			if (mmu_pages_add(pvec, child, i))</yellow>
				return -ENOSPC;
		} else
<yellow>			clear_unsync_child_bit(sp, i);</yellow>
	}

	return nr_unsync_leaf;
<yellow>}</yellow>

#define INVALID_INDEX (-1)

<yellow>static int mmu_unsync_walk(struct kvm_mmu_page *sp,</yellow>
			   struct kvm_mmu_pages *pvec)
{
	pvec-&gt;nr = 0;
<blue>	if (!sp->unsync_children)</blue>
		return 0;

<yellow>	mmu_pages_add(pvec, sp, INVALID_INDEX);</yellow>
	return __mmu_unsync_walk(sp, pvec);
}

static void kvm_unlink_unsync_page(struct kvm *kvm, struct kvm_mmu_page *sp)
{
<yellow>	WARN_ON(!sp->unsync);</yellow>
<yellow>	trace_kvm_mmu_sync_page(sp);</yellow>
<yellow>	sp->unsync = 0;</yellow>
	--kvm-&gt;stat.mmu_unsync;
}

static bool kvm_mmu_prepare_zap_page(struct kvm *kvm, struct kvm_mmu_page *sp,
				     struct list_head *invalid_list);
static void kvm_mmu_commit_zap_page(struct kvm *kvm,
				    struct list_head *invalid_list);

static bool sp_has_gptes(struct kvm_mmu_page *sp)
{
<blue>	if (sp->role.direct)</blue>
		return false;

<blue>	if (sp->role.passthrough)</blue>
		return false;

	return true;
}

#define for_each_valid_sp(_kvm, _sp, _list)				\
	hlist_for_each_entry(_sp, _list, hash_link)			\
		if (is_obsolete_sp((_kvm), (_sp))) {			\
		} else

#define for_each_gfn_valid_sp_with_gptes(_kvm, _sp, _gfn)		\
	for_each_valid_sp(_kvm, _sp,					\
	  &amp;(_kvm)-&gt;arch.mmu_page_hash[kvm_page_table_hashfn(_gfn)])	\
		if ((_sp)-&gt;gfn != (_gfn) || !sp_has_gptes(_sp)) {} else

static int kvm_sync_page(struct kvm_vcpu *vcpu, struct kvm_mmu_page *sp,
			 struct list_head *invalid_list)
{
<yellow>	int ret = vcpu->arch.mmu->sync_page(vcpu, sp);</yellow>

	if (ret &lt; 0)
		kvm_mmu_prepare_zap_page(vcpu-&gt;kvm, sp, invalid_list);
	return ret;
}

static bool kvm_mmu_remote_flush_or_zap(struct kvm *kvm,
					struct list_head *invalid_list,
					bool remote_flush)
{
<blue>	if (!remote_flush && list_empty(invalid_list))</blue>
		return false;

<yellow>	if (!list_empty(invalid_list))</yellow>
<yellow>		kvm_mmu_commit_zap_page(kvm, invalid_list);</yellow>
	else
<yellow>		kvm_flush_remote_tlbs(kvm);</yellow>
	return true;
}

<blue>static bool is_obsolete_sp(struct kvm *kvm, struct kvm_mmu_page *sp)</blue>
{
<blue>	if (sp->role.invalid)</blue>
		return true;

	/* TDP MMU pages due not use the MMU generation. */
<blue>	return !sp->tdp_mmu_page &&</blue>
<blue>	       unlikely(sp->mmu_valid_gen != kvm->arch.mmu_valid_gen);</blue>
}

struct mmu_page_path {
	struct kvm_mmu_page *parent[PT64_ROOT_MAX_LEVEL];
	unsigned int idx[PT64_ROOT_MAX_LEVEL];
};

#define for_each_sp(pvec, sp, parents, i)			\
		for (i = mmu_pages_first(&amp;pvec, &amp;parents);	\
			i &lt; pvec.nr &amp;&amp; ({ sp = pvec.page[i].sp; 1;});	\
			i = mmu_pages_next(&amp;pvec, &amp;parents, i))

static int mmu_pages_next(struct kvm_mmu_pages *pvec,
			  struct mmu_page_path *parents,
			  int i)
{
	int n;

<yellow>	for (n = i+1; n < pvec->nr; n++) {</yellow>
<yellow>		struct kvm_mmu_page *sp = pvec->page[n].sp;</yellow>
		unsigned idx = pvec-&gt;page[n].idx;
		int level = sp-&gt;role.level;

		parents-&gt;idx[level-1] = idx;
		if (level == PG_LEVEL_4K)
			break;

<yellow>		parents->parent[level-2] = sp;</yellow>
	}

	return n;
}

static int mmu_pages_first(struct kvm_mmu_pages *pvec,
			   struct mmu_page_path *parents)
{
	struct kvm_mmu_page *sp;
	int level;

<yellow>	if (pvec->nr == 0)</yellow>
		return 0;

<yellow>	WARN_ON(pvec->page[0].idx != INVALID_INDEX);</yellow>

<yellow>	sp = pvec->page[0].sp;</yellow>
	level = sp-&gt;role.level;
<yellow>	WARN_ON(level == PG_LEVEL_4K);</yellow>

<yellow>	parents->parent[level-2] = sp;</yellow>

	/* Also set up a sentinel.  Further entries in pvec are all
	 * children of sp, so this element is never overwritten.
	 */
	parents-&gt;parent[level-1] = NULL;
<yellow>	return mmu_pages_next(pvec, parents, 0);</yellow>
<yellow>}</yellow>

static void mmu_pages_clear_parents(struct mmu_page_path *parents)
{
	struct kvm_mmu_page *sp;
	unsigned int level = 0;

	do {
<yellow>		unsigned int idx = parents->idx[level];</yellow>
		sp = parents-&gt;parent[level];
		if (!sp)
			return;

<yellow>		WARN_ON(idx == INVALID_INDEX);</yellow>
<yellow>		clear_unsync_child_bit(sp, idx);</yellow>
		level++;
	} while (!sp-&gt;unsync_children);
}

static int mmu_sync_children(struct kvm_vcpu *vcpu,
			     struct kvm_mmu_page *parent, bool can_yield)
<yellow>{</yellow>
	int i;
	struct kvm_mmu_page *sp;
	struct mmu_page_path parents;
	struct kvm_mmu_pages pages;
<yellow>	LIST_HEAD(invalid_list);</yellow>
	bool flush = false;

<yellow>	while (mmu_unsync_walk(parent, &pages)) {</yellow>
		bool protected = false;

<yellow>		for_each_sp(pages, sp, parents, i)</yellow>
			protected |= kvm_vcpu_write_protect_gfn(vcpu, sp-&gt;gfn);

<yellow>		if (protected) {</yellow>
<yellow>			kvm_mmu_remote_flush_or_zap(vcpu->kvm, &invalid_list, true);</yellow>
			flush = false;
		}

<yellow>		for_each_sp(pages, sp, parents, i) {</yellow>
			kvm_unlink_unsync_page(vcpu-&gt;kvm, sp);
<yellow>			flush |= kvm_sync_page(vcpu, sp, &invalid_list) > 0;</yellow>
<yellow>			mmu_pages_clear_parents(&parents);</yellow>
		}
<yellow>		if (need_resched() || rwlock_needbreak(&vcpu->kvm->mmu_lock)) {</yellow>
<yellow>			kvm_mmu_remote_flush_or_zap(vcpu->kvm, &invalid_list, flush);</yellow>
<yellow>			if (!can_yield) {</yellow>
<yellow>				kvm_make_request(KVM_REQ_MMU_SYNC, vcpu);</yellow>
				return -EINTR;
			}

<yellow>			cond_resched_rwlock_write(&vcpu->kvm->mmu_lock);</yellow>
			flush = false;
		}
	}

<yellow>	kvm_mmu_remote_flush_or_zap(vcpu->kvm, &invalid_list, flush);</yellow>
	return 0;
}

static void __clear_sp_write_flooding_count(struct kvm_mmu_page *sp)
{
<blue>	atomic_set(&sp->write_flooding_count,  0);</blue>
}

static void clear_sp_write_flooding_count(u64 *spte)
{
<blue>	__clear_sp_write_flooding_count(sptep_to_sp(spte));</blue>
}

/*
 * The vCPU is required when finding indirect shadow pages; the shadow
 * page may already exist and syncing it needs the vCPU pointer in
 * order to read guest page tables.  Direct shadow pages are never
 * unsync, thus @vcpu can be NULL if @role.direct is true.
 */
static struct kvm_mmu_page *kvm_mmu_find_shadow_page(struct kvm *kvm,
						     struct kvm_vcpu *vcpu,
						     gfn_t gfn,
						     struct hlist_head *sp_list,
						     union kvm_mmu_page_role role)
{
	struct kvm_mmu_page *sp;
	int ret;
	int collisions = 0;
	LIST_HEAD(invalid_list);

<blue>	for_each_valid_sp(kvm, sp, sp_list) {</blue>
<blue>		if (sp->gfn != gfn) {</blue>
<yellow>			collisions++;</yellow>
			continue;
		}

<blue>		if (sp->role.word != role.word) {</blue>
			/*
			 * If the guest is creating an upper-level page, zap
			 * unsync pages for the same gfn.  While it&#x27;s possible
			 * the guest is using recursive page tables, in all
			 * likelihood the guest has stopped using the unsync
			 * page and is installing a completely unrelated page.
			 * Unsync pages must not be left as is, because the new
			 * upper-level page will be write-protected.
			 */
<blue>			if (role.level > PG_LEVEL_4K && sp->unsync)</blue>
<yellow>				kvm_mmu_prepare_zap_page(kvm, sp,</yellow>
							 &amp;invalid_list);
			continue;
		}

		/* unsync and write-flooding only apply to indirect SPs. */
<blue>		if (sp->role.direct)</blue>
			goto out;

<blue>		if (sp->unsync) {</blue>
<yellow>			if (KVM_BUG_ON(!vcpu, kvm))</yellow>
				break;

			/*
			 * The page is good, but is stale.  kvm_sync_page does
			 * get the latest guest state, but (unlike mmu_unsync_children)
			 * it doesn&#x27;t write-protect the page or mark it synchronized!
			 * This way the validity of the mapping is ensured, but the
			 * overhead of write protection is not incurred until the
			 * guest invalidates the TLB mapping.  This allows multiple
			 * SPs for a single gfn to be unsync.
			 *
			 * If the sync fails, the page is zapped.  If so, break
			 * in order to rebuild it.
			 */
<yellow>			ret = kvm_sync_page(vcpu, sp, &invalid_list);</yellow>
			if (ret &lt; 0)
				break;

<yellow>			WARN_ON(!list_empty(&invalid_list));</yellow>
<yellow>			if (ret > 0)</yellow>
<yellow>				kvm_flush_remote_tlbs(kvm);</yellow>
		}

<blue>		__clear_sp_write_flooding_count(sp);</blue>

		goto out;
	}

	sp = NULL;
<blue>	++kvm->stat.mmu_cache_miss;</blue>

out:
<blue>	kvm_mmu_commit_zap_page(kvm, &invalid_list);</blue>

<blue>	if (collisions > kvm->stat.max_mmu_page_hash_collisions)</blue>
<yellow>		kvm->stat.max_mmu_page_hash_collisions = collisions;</yellow>
	return sp;
}

/* Caches used when allocating a new shadow page. */
struct shadow_page_caches {
	struct kvm_mmu_memory_cache *page_header_cache;
	struct kvm_mmu_memory_cache *shadow_page_cache;
	struct kvm_mmu_memory_cache *shadowed_info_cache;
};

static struct kvm_mmu_page *kvm_mmu_alloc_shadow_page(struct kvm *kvm,
						      struct shadow_page_caches *caches,
						      gfn_t gfn,
						      struct hlist_head *sp_list,
						      union kvm_mmu_page_role role)
{
	struct kvm_mmu_page *sp;

<blue>	sp = kvm_mmu_memory_cache_alloc(caches->page_header_cache);</blue>
	sp-&gt;spt = kvm_mmu_memory_cache_alloc(caches-&gt;shadow_page_cache);
	if (!role.direct)
<blue>		sp->shadowed_translation = kvm_mmu_memory_cache_alloc(caches->shadowed_info_cache);</blue>

<blue>	set_page_private(virt_to_page(sp->spt), (unsigned long)sp);</blue>

	/*
	 * active_mmu_pages must be a FIFO list, as kvm_zap_obsolete_pages()
	 * depends on valid pages being added to the head of the list.  See
	 * comments in kvm_zap_obsolete_pages().
	 */
	sp-&gt;mmu_valid_gen = kvm-&gt;arch.mmu_valid_gen;
	list_add(&amp;sp-&gt;link, &amp;kvm-&gt;arch.active_mmu_pages);
<blue>	kvm_account_mmu_page(kvm, sp);</blue>

	sp-&gt;gfn = gfn;
	sp-&gt;role = role;
<blue>	hlist_add_head(&sp->hash_link, sp_list);</blue>
<blue>	if (sp_has_gptes(sp))</blue>
<blue>		account_shadowed(kvm, sp);</blue>

	return sp;
}

/* Note, @vcpu may be NULL if @role.direct is true; see kvm_mmu_find_shadow_page. */
static struct kvm_mmu_page *__kvm_mmu_get_shadow_page(struct kvm *kvm,
						      struct kvm_vcpu *vcpu,
						      struct shadow_page_caches *caches,
						      gfn_t gfn,
						      union kvm_mmu_page_role role)
<blue>{</blue>
	struct hlist_head *sp_list;
	struct kvm_mmu_page *sp;
	bool created = false;

<blue>	sp_list = &kvm->arch.mmu_page_hash[kvm_page_table_hashfn(gfn)];</blue>

<blue>	sp = kvm_mmu_find_shadow_page(kvm, vcpu, gfn, sp_list, role);</blue>
<blue>	if (!sp) {</blue>
		created = true;
<blue>		sp = kvm_mmu_alloc_shadow_page(kvm, caches, gfn, sp_list, role);</blue>
	}

<blue>	trace_kvm_mmu_get_page(sp, created);</blue>
	return sp;
}

static struct kvm_mmu_page *kvm_mmu_get_shadow_page(struct kvm_vcpu *vcpu,
						    gfn_t gfn,
						    union kvm_mmu_page_role role)
{
	struct shadow_page_caches caches = {
<blue>		.page_header_cache = &vcpu->arch.mmu_page_header_cache,</blue>
		.shadow_page_cache = &amp;vcpu-&gt;arch.mmu_shadow_page_cache,
		.shadowed_info_cache = &amp;vcpu-&gt;arch.mmu_shadowed_info_cache,
	};

	return __kvm_mmu_get_shadow_page(vcpu-&gt;kvm, vcpu, &amp;caches, gfn, role);
}

static union kvm_mmu_page_role kvm_mmu_child_role(u64 *sptep, bool direct,
						  unsigned int access)
{
<blue>	struct kvm_mmu_page *parent_sp = sptep_to_sp(sptep);</blue>
	union kvm_mmu_page_role role;

	role = parent_sp-&gt;role;
	role.level--;
	role.access = access;
	role.direct = direct;
	role.passthrough = 0;

	/*
	 * If the guest has 4-byte PTEs then that means it&#x27;s using 32-bit,
	 * 2-level, non-PAE paging. KVM shadows such guests with PAE paging
	 * (i.e. 8-byte PTEs). The difference in PTE size means that KVM must
	 * shadow each guest page table with multiple shadow page tables, which
	 * requires extra bookkeeping in the role.
	 *
	 * Specifically, to shadow the guest&#x27;s page directory (which covers a
	 * 4GiB address space), KVM uses 4 PAE page directories, each mapping
	 * 1GiB of the address space. @role.quadrant encodes which quarter of
	 * the address space each maps.
	 *
	 * To shadow the guest&#x27;s page tables (which each map a 4MiB region), KVM
	 * uses 2 PAE page tables, each mapping a 2MiB region. For these,
	 * @role.quadrant encodes which half of the region they map.
	 *
	 * Concretely, a 4-byte PDE consumes bits 31:22, while an 8-byte PDE
	 * consumes bits 29:21.  To consume bits 31:30, KVM&#x27;s uses 4 shadow
	 * PDPTEs; those 4 PAE page directories are pre-allocated and their
	 * quadrant is assigned in mmu_alloc_root().   A 4-byte PTE consumes
	 * bits 21:12, while an 8-byte PTE consumes bits 20:12.  To consume
	 * bit 21 in the PTE (the child here), KVM propagates that bit to the
	 * quadrant, i.e. sets quadrant to &#x27;0&#x27; or &#x27;1&#x27;.  The parent 8-byte PDE
	 * covers bit 21 (see above), thus the quadrant is calculated from the
	 * _least_ significant bit of the PDE index.
	 */
	if (role.has_4_byte_gpte) {
<yellow>		WARN_ON_ONCE(role.level != PG_LEVEL_4K);</yellow>
<yellow>		role.quadrant = spte_index(sptep) & 1;</yellow>
	}

<blue>	return role;</blue>
}

static struct kvm_mmu_page *kvm_mmu_get_child_sp(struct kvm_vcpu *vcpu,
						 u64 *sptep, gfn_t gfn,
						 bool direct, unsigned int access)
<blue>{</blue>
	union kvm_mmu_page_role role;

<blue>	if (is_shadow_present_pte(*sptep) && !is_large_pte(*sptep))</blue>
		return ERR_PTR(-EEXIST);

<blue>	role = kvm_mmu_child_role(sptep, direct, access);</blue>
	return kvm_mmu_get_shadow_page(vcpu, gfn, role);
}

static void shadow_walk_init_using_root(struct kvm_shadow_walk_iterator *iterator,
					struct kvm_vcpu *vcpu, hpa_t root,
					u64 addr)
{
<blue>	iterator->addr = addr;</blue>
	iterator-&gt;shadow_addr = root;
	iterator-&gt;level = vcpu-&gt;arch.mmu-&gt;root_role.level;

	if (iterator-&gt;level &gt;= PT64_ROOT_4LEVEL &amp;&amp;
<blue>	    vcpu->arch.mmu->cpu_role.base.level < PT64_ROOT_4LEVEL &&</blue>
<yellow>	    !vcpu->arch.mmu->root_role.direct)</yellow>
<yellow>		iterator->level = PT32E_ROOT_LEVEL;</yellow>

<yellow>	if (iterator->level == PT32E_ROOT_LEVEL) {</yellow>
		/*
		 * prev_root is currently only used for 64-bit hosts. So only
		 * the active root_hpa is valid here.
		 */
<yellow>		BUG_ON(root != vcpu->arch.mmu->root.hpa);</yellow>

		iterator-&gt;shadow_addr
<yellow>			= vcpu->arch.mmu->pae_root[(addr >> 30) & 3];</yellow>
		iterator-&gt;shadow_addr &amp;= SPTE_BASE_ADDR_MASK;
<yellow>		--iterator->level;</yellow>
		if (!iterator-&gt;shadow_addr)
<yellow>			iterator->level = 0;</yellow>
	}
<blue>}</blue>

static void shadow_walk_init(struct kvm_shadow_walk_iterator *iterator,
			     struct kvm_vcpu *vcpu, u64 addr)
{
<blue>	shadow_walk_init_using_root(iterator, vcpu, vcpu->arch.mmu->root.hpa,</blue>
				    addr);
}

static bool shadow_walk_okay(struct kvm_shadow_walk_iterator *iterator)
{
<blue>	if (iterator->level < PG_LEVEL_4K)</blue>
		return false;

<blue>	iterator->index = SPTE_INDEX(iterator->addr, iterator->level);</blue>
	iterator-&gt;sptep	= ((u64 *)__va(iterator-&gt;shadow_addr)) + iterator-&gt;index;
	return true;
<blue>}</blue>

static void __shadow_walk_next(struct kvm_shadow_walk_iterator *iterator,
			       u64 spte)
{
<blue>	if (!is_shadow_present_pte(spte) || is_last_spte(spte, iterator->level)) {</blue>
<blue>		iterator->level = 0;</blue>
		return;
	}

<blue>	iterator->shadow_addr = spte & SPTE_BASE_ADDR_MASK;</blue>
<blue>	--iterator->level;</blue>
}

static void shadow_walk_next(struct kvm_shadow_walk_iterator *iterator)
{
<blue>	__shadow_walk_next(iterator, *iterator->sptep);</blue>
}

static void __link_shadow_page(struct kvm *kvm,
			       struct kvm_mmu_memory_cache *cache, u64 *sptep,
			       struct kvm_mmu_page *sp, bool flush)
<blue>{</blue>
	u64 spte;

	BUILD_BUG_ON(VMX_EPT_WRITABLE_MASK != PT_WRITABLE_MASK);

	/*
	 * If an SPTE is present already, it must be a leaf and therefore
	 * a large one.  Drop it, and flush the TLB if needed, before
	 * installing sp.
	 */
<blue>	if (is_shadow_present_pte(*sptep))</blue>
<yellow>		drop_large_spte(kvm, sptep, flush);</yellow>

<blue>	spte = make_nonleaf_spte(sp->spt, sp_ad_disabled(sp));</blue>

<blue>	mmu_spte_set(sptep, spte);</blue>

<blue>	mmu_page_add_parent_pte(cache, sp, sptep);</blue>

<blue>	if (sp->unsync_children || sp->unsync)</blue>
<yellow>		mark_unsync(sptep);</yellow>
}

static void link_shadow_page(struct kvm_vcpu *vcpu, u64 *sptep,
			     struct kvm_mmu_page *sp)
{
<blue>	__link_shadow_page(vcpu->kvm, &vcpu->arch.mmu_pte_list_desc_cache, sptep, sp, true);</blue>
}

static void validate_direct_spte(struct kvm_vcpu *vcpu, u64 *sptep,
				   unsigned direct_access)
<blue>{</blue>
<blue>	if (is_shadow_present_pte(*sptep) && !is_large_pte(*sptep)) {</blue>
		struct kvm_mmu_page *child;

		/*
		 * For the direct sp, if the guest pte&#x27;s dirty bit
		 * changed form clean to dirty, it will corrupt the
		 * sp&#x27;s access: allow writable in the read-only sp,
		 * so we should update the spte at this point to get
		 * a new sp with the correct access.
		 */
<blue>		child = to_shadow_page(*sptep & SPTE_BASE_ADDR_MASK);</blue>
		if (child-&gt;role.access == direct_access)
			return;

<blue>		drop_parent_pte(child, sptep);</blue>
<blue>		kvm_flush_remote_tlbs_with_address(vcpu->kvm, child->gfn, 1);</blue>
	}
}

/* Returns the number of zapped non-leaf child shadow pages. */
static int mmu_page_zap_pte(struct kvm *kvm, struct kvm_mmu_page *sp,
			    u64 *spte, struct list_head *invalid_list)
<blue>{</blue>
	u64 pte;
	struct kvm_mmu_page *child;

<blue>	pte = *spte;</blue>
	if (is_shadow_present_pte(pte)) {
<blue>		if (is_last_spte(pte, sp->role.level)) {</blue>
<blue>			drop_spte(kvm, spte);</blue>
		} else {
<blue>			child = to_shadow_page(pte & SPTE_BASE_ADDR_MASK);</blue>
			drop_parent_pte(child, spte);

			/*
			 * Recursively zap nested TDP SPs, parentless SPs are
			 * unlikely to be used again in the near future.  This
			 * avoids retaining a large number of stale nested SPs.
			 */
<blue>			if (tdp_enabled && invalid_list &&</blue>
<blue>			    child->role.guest_mode && !child->parent_ptes.val)</blue>
<blue>				return kvm_mmu_prepare_zap_page(kvm, child,</blue>
								invalid_list);
		}
<blue>	} else if (is_mmio_spte(pte)) {</blue>
<yellow>		mmu_spte_clear_no_track(spte);</yellow>
	}
	return 0;
}

static int kvm_mmu_page_unlink_children(struct kvm *kvm,
					struct kvm_mmu_page *sp,
					struct list_head *invalid_list)
{
	int zapped = 0;
	unsigned i;

	for (i = 0; i &lt; SPTE_ENT_PER_PAGE; ++i)
<blue>		zapped += mmu_page_zap_pte(kvm, sp, sp->spt + i, invalid_list);</blue>

	return zapped;
}

static void kvm_mmu_unlink_parents(struct kvm_mmu_page *sp)
{
	u64 *sptep;
	struct rmap_iterator iter;

<yellow>	while ((sptep = rmap_get_first(&sp->parent_ptes, &iter)))</yellow>
<yellow>		drop_parent_pte(sp, sptep);</yellow>
}

static int mmu_zap_unsync_children(struct kvm *kvm,
				   struct kvm_mmu_page *parent,
				   struct list_head *invalid_list)
<blue>{</blue>
	int i, zapped = 0;
	struct mmu_page_path parents;
	struct kvm_mmu_pages pages;

<blue>	if (parent->role.level == PG_LEVEL_4K)</blue>
		return 0;

<blue>	while (mmu_unsync_walk(parent, &pages)) {</blue>
		struct kvm_mmu_page *sp;

<yellow>		for_each_sp(pages, sp, parents, i) {</yellow>
			kvm_mmu_prepare_zap_page(kvm, sp, invalid_list);
<yellow>			mmu_pages_clear_parents(&parents);</yellow>
			zapped++;
		}
	}

	return zapped;
}

static bool __kvm_mmu_prepare_zap_page(struct kvm *kvm,
				       struct kvm_mmu_page *sp,
				       struct list_head *invalid_list,
				       int *nr_zapped)
{
	bool list_unstable, zapped_root = false;

	lockdep_assert_held_write(&amp;kvm-&gt;mmu_lock);
<blue>	trace_kvm_mmu_prepare_zap_page(sp);</blue>
<blue>	++kvm->stat.mmu_shadow_zapped;</blue>
	*nr_zapped = mmu_zap_unsync_children(kvm, sp, invalid_list);
<blue>	*nr_zapped += kvm_mmu_page_unlink_children(kvm, sp, invalid_list);</blue>
<yellow>	kvm_mmu_unlink_parents(sp);</yellow>

	/* Zapping children means active_mmu_pages has become unstable. */
<blue>	list_unstable = *nr_zapped;</blue>

<blue>	if (!sp->role.invalid && sp_has_gptes(sp))</blue>
<blue>		unaccount_shadowed(kvm, sp);</blue>

<blue>	if (sp->unsync)</blue>
<yellow>		kvm_unlink_unsync_page(kvm, sp);</yellow>
<blue>	if (!sp->root_count) {</blue>
		/* Count self */
<blue>		(*nr_zapped)++;</blue>

		/*
		 * Already invalid pages (previously active roots) are not on
		 * the active page list.  See list_del() in the &quot;else&quot; case of
		 * !sp-&gt;root_count.
		 */
		if (sp-&gt;role.invalid)
<blue>			list_add(&sp->link, invalid_list);</blue>
		else
<blue>			list_move(&sp->link, invalid_list);</blue>
<blue>		kvm_unaccount_mmu_page(kvm, sp);</blue>
	} else {
		/*
		 * Remove the active root from the active page list, the root
		 * will be explicitly freed when the root_count hits zero.
		 */
<blue>		list_del(&sp->link);</blue>

		/*
		 * Obsolete pages cannot be used on any vCPUs, see the comment
		 * in kvm_mmu_zap_all_fast().  Note, is_obsolete_sp() also
		 * treats invalid shadow pages as being obsolete.
		 */
<blue>		zapped_root = !is_obsolete_sp(kvm, sp);</blue>
	}

<blue>	if (sp->lpage_disallowed)</blue>
<yellow>		unaccount_huge_nx_page(kvm, sp);</yellow>

<blue>	sp->role.invalid = 1;</blue>

	/*
	 * Make the request to free obsolete roots after marking the root
	 * invalid, otherwise other vCPUs may not see it as invalid.
	 */
	if (zapped_root)
<blue>		kvm_make_all_cpus_request(kvm, KVM_REQ_MMU_FREE_OBSOLETE_ROOTS);</blue>
	return list_unstable;
<blue>}</blue>

static bool kvm_mmu_prepare_zap_page(struct kvm *kvm, struct kvm_mmu_page *sp,
				     struct list_head *invalid_list)
{
	int nr_zapped;

<blue>	__kvm_mmu_prepare_zap_page(kvm, sp, invalid_list, &nr_zapped);</blue>
	return nr_zapped;
}

static void kvm_mmu_commit_zap_page(struct kvm *kvm,
				    struct list_head *invalid_list)
{
	struct kvm_mmu_page *sp, *nsp;

<blue>	if (list_empty(invalid_list))</blue>
		return;

	/*
	 * We need to make sure everyone sees our modifications to
	 * the page tables and see changes to vcpu-&gt;mode here. The barrier
	 * in the kvm_flush_remote_tlbs() achieves this. This pairs
	 * with vcpu_enter_guest and walk_shadow_page_lockless_begin/end.
	 *
	 * In addition, kvm_flush_remote_tlbs waits for all vcpus to exit
	 * guest mode and/or lockless shadow page table walks.
	 */
<blue>	kvm_flush_remote_tlbs(kvm);</blue>

	list_for_each_entry_safe(sp, nsp, invalid_list, link) {
<blue>		WARN_ON(!sp->role.invalid || sp->root_count);</blue>
<blue>		kvm_mmu_free_shadow_page(sp);</blue>
	}
<blue>}</blue>

static unsigned long kvm_mmu_zap_oldest_mmu_pages(struct kvm *kvm,
						  unsigned long nr_to_zap)
<yellow>{</yellow>
	unsigned long total_zapped = 0;
	struct kvm_mmu_page *sp, *tmp;
<yellow>	LIST_HEAD(invalid_list);</yellow>
	bool unstable;
	int nr_zapped;

	if (list_empty(&amp;kvm-&gt;arch.active_mmu_pages))
		return 0;

restart:
<yellow>	list_for_each_entry_safe_reverse(sp, tmp, &kvm->arch.active_mmu_pages, link) {</yellow>
		/*
		 * Don&#x27;t zap active root pages, the page itself can&#x27;t be freed
		 * and zapping it will just force vCPUs to realloc and reload.
		 */
<yellow>		if (sp->root_count)</yellow>
			continue;

<yellow>		unstable = __kvm_mmu_prepare_zap_page(kvm, sp, &invalid_list,</yellow>
						      &amp;nr_zapped);
		total_zapped += nr_zapped;
		if (total_zapped &gt;= nr_to_zap)
			break;

<yellow>		if (unstable)</yellow>
			goto restart;
	}

<yellow>	kvm_mmu_commit_zap_page(kvm, &invalid_list);</yellow>

<yellow>	kvm->stat.mmu_recycled += total_zapped;</yellow>
	return total_zapped;
}

static inline unsigned long kvm_mmu_available_pages(struct kvm *kvm)
{
	if (kvm-&gt;arch.n_max_mmu_pages &gt; kvm-&gt;arch.n_used_mmu_pages)
<blue>		return kvm->arch.n_max_mmu_pages -</blue>
			kvm-&gt;arch.n_used_mmu_pages;

	return 0;
}

static int make_mmu_pages_available(struct kvm_vcpu *vcpu)
{
<blue>	unsigned long avail = kvm_mmu_available_pages(vcpu->kvm);</blue>

	if (likely(avail &gt;= KVM_MIN_FREE_MMU_PAGES))
		return 0;

<yellow>	kvm_mmu_zap_oldest_mmu_pages(vcpu->kvm, KVM_REFILL_PAGES - avail);</yellow>

	/*
	 * Note, this check is intentionally soft, it only guarantees that one
	 * page is available, while the caller may end up allocating as many as
	 * four pages, e.g. for PAE roots or for 5-level paging.  Temporarily
	 * exceeding the (arbitrary by default) limit will not harm the host,
	 * being too aggressive may unnecessarily kill the guest, and getting an
	 * exact count is far more trouble than it&#x27;s worth, especially in the
	 * page fault paths.
	 */
	if (!kvm_mmu_available_pages(vcpu-&gt;kvm))
		return -ENOSPC;
	return 0;
}

/*
 * Changing the number of mmu pages allocated to the vm
 * Note: if goal_nr_mmu_pages is too small, you will get dead lock
 */
void kvm_mmu_change_mmu_pages(struct kvm *kvm, unsigned long goal_nr_mmu_pages)
{
<blue>	write_lock(&kvm->mmu_lock);</blue>

	if (kvm-&gt;arch.n_used_mmu_pages &gt; goal_nr_mmu_pages) {
<yellow>		kvm_mmu_zap_oldest_mmu_pages(kvm, kvm->arch.n_used_mmu_pages -</yellow>
						  goal_nr_mmu_pages);

		goal_nr_mmu_pages = kvm-&gt;arch.n_used_mmu_pages;
	}

<blue>	kvm->arch.n_max_mmu_pages = goal_nr_mmu_pages;</blue>

	write_unlock(&amp;kvm-&gt;mmu_lock);
}

int kvm_mmu_unprotect_page(struct kvm *kvm, gfn_t gfn)
{
	struct kvm_mmu_page *sp;
<blue>	LIST_HEAD(invalid_list);</blue>
	int r;

	pgprintk(&quot;%s: looking for gfn %llx\n&quot;, __func__, gfn);
	r = 0;
	write_lock(&amp;kvm-&gt;mmu_lock);
<blue>	for_each_gfn_valid_sp_with_gptes(kvm, sp, gfn) {</blue>
		pgprintk(&quot;%s: gfn %llx role %x\n&quot;, __func__, gfn,
			 sp-&gt;role.word);
		r = 1;
<blue>		kvm_mmu_prepare_zap_page(kvm, sp, &invalid_list);</blue>
	}
<blue>	kvm_mmu_commit_zap_page(kvm, &invalid_list);</blue>
<blue>	write_unlock(&kvm->mmu_lock);</blue>

	return r;
}

static int kvm_mmu_unprotect_page_virt(struct kvm_vcpu *vcpu, gva_t gva)
{
	gpa_t gpa;
	int r;

<yellow>	if (vcpu->arch.mmu->root_role.direct)</yellow>
		return 0;

<yellow>	gpa = kvm_mmu_gva_to_gpa_read(vcpu, gva, NULL);</yellow>

	r = kvm_mmu_unprotect_page(vcpu-&gt;kvm, gpa &gt;&gt; PAGE_SHIFT);

	return r;
}

static void kvm_unsync_page(struct kvm *kvm, struct kvm_mmu_page *sp)
{
<yellow>	trace_kvm_mmu_unsync_page(sp);</yellow>
<yellow>	++kvm->stat.mmu_unsync;</yellow>
	sp-&gt;unsync = 1;

<yellow>	kvm_mmu_mark_parents_unsync(sp);</yellow>
}

/*
 * Attempt to unsync any shadow pages that can be reached by the specified gfn,
 * KVM is creating a writable mapping for said gfn.  Returns 0 if all pages
 * were marked unsync (or if there is no shadow page), -EPERM if the SPTE must
 * be write-protected.
 */
int mmu_try_to_unsync_pages(struct kvm *kvm, const struct kvm_memory_slot *slot,
			    gfn_t gfn, bool can_unsync, bool prefetch)
<blue>{</blue>
	struct kvm_mmu_page *sp;
	bool locked = false;

	/*
	 * Force write-protection if the page is being tracked.  Note, the page
	 * track machinery is used to write-protect upper-level shadow pages,
	 * i.e. this guards the role.level == 4K assertion below!
	 */
<blue>	if (kvm_slot_page_track_is_active(kvm, slot, gfn, KVM_PAGE_TRACK_WRITE))</blue>
		return -EPERM;

	/*
	 * The page is not write-tracked, mark existing shadow pages unsync
	 * unless KVM is synchronizing an unsync SP (can_unsync = false).  In
	 * that case, KVM must complete emulation of the guest TLB flush before
	 * allowing shadow pages to become unsync (writable by the guest).
	 */
<blue>	for_each_gfn_valid_sp_with_gptes(kvm, sp, gfn) {</blue>
<yellow>		if (!can_unsync)</yellow>
			return -EPERM;

<yellow>		if (sp->unsync)</yellow>
			continue;

<yellow>		if (prefetch)</yellow>
			return -EEXIST;

		/*
		 * TDP MMU page faults require an additional spinlock as they
		 * run with mmu_lock held for read, not write, and the unsync
		 * logic is not thread safe.  Take the spinklock regardless of
		 * the MMU type to avoid extra conditionals/parameters, there&#x27;s
		 * no meaningful penalty if mmu_lock is held for write.
		 */
<yellow>		if (!locked) {</yellow>
			locked = true;
<yellow>			spin_lock(&kvm->arch.mmu_unsync_pages_lock);</yellow>

			/*
			 * Recheck after taking the spinlock, a different vCPU
			 * may have since marked the page unsync.  A false
			 * positive on the unprotected check above is not
			 * possible as clearing sp-&gt;unsync _must_ hold mmu_lock
			 * for write, i.e. unsync cannot transition from 0-&gt;1
			 * while this CPU holds mmu_lock for read (or write).
			 */
<yellow>			if (READ_ONCE(sp->unsync))</yellow>
				continue;
		}

<yellow>		WARN_ON(sp->role.level != PG_LEVEL_4K);</yellow>
<yellow>		kvm_unsync_page(kvm, sp);</yellow>
	}
<blue>	if (locked)</blue>
<yellow>		spin_unlock(&kvm->arch.mmu_unsync_pages_lock);</yellow>

	/*
	 * We need to ensure that the marking of unsync pages is visible
	 * before the SPTE is updated to allow writes because
	 * kvm_mmu_sync_roots() checks the unsync flags without holding
	 * the MMU lock and so can race with this. If the SPTE was updated
	 * before the page had been marked as unsync-ed, something like the
	 * following could happen:
	 *
	 * CPU 1                    CPU 2
	 * ---------------------------------------------------------------------
	 * 1.2 Host updates SPTE
	 *     to be writable
	 *                      2.1 Guest writes a GPTE for GVA X.
	 *                          (GPTE being in the guest page table shadowed
	 *                           by the SP from CPU 1.)
	 *                          This reads SPTE during the page table walk.
	 *                          Since SPTE.W is read as 1, there is no
	 *                          fault.
	 *
	 *                      2.2 Guest issues TLB flush.
	 *                          That causes a VM Exit.
	 *
	 *                      2.3 Walking of unsync pages sees sp-&gt;unsync is
	 *                          false and skips the page.
	 *
	 *                      2.4 Guest accesses GVA X.
	 *                          Since the mapping in the SP was not updated,
	 *                          so the old mapping for GVA X incorrectly
	 *                          gets used.
	 * 1.1 Host marks SP
	 *     as unsync
	 *     (sp-&gt;unsync = true)
	 *
	 * The write barrier below ensures that 1.1 happens before 1.2 and thus
	 * the situation in 2.4 does not arise.  It pairs with the read barrier
	 * in is_unsync_root(), placed between 2.1&#x27;s load of SPTE.W and 2.3.
	 */
	smp_wmb();

<blue>	return 0;</blue>
}

static int mmu_set_spte(struct kvm_vcpu *vcpu, struct kvm_memory_slot *slot,
			u64 *sptep, unsigned int pte_access, gfn_t gfn,
			kvm_pfn_t pfn, struct kvm_page_fault *fault)
<blue>{</blue>
<blue>	struct kvm_mmu_page *sp = sptep_to_sp(sptep);</blue>
	int level = sp-&gt;role.level;
	int was_rmapped = 0;
	int ret = RET_PF_FIXED;
	bool flush = false;
	bool wrprot;
	u64 spte;

	/* Prefetching always gets a writable pfn.  */
<blue>	bool host_writable = !fault || fault->map_writable;</blue>
<blue>	bool prefetch = !fault || fault->prefetch;</blue>
<blue>	bool write_fault = fault && fault->write;</blue>

	pgprintk(&quot;%s: spte %llx write_fault %d gfn %llx\n&quot;, __func__,
		 *sptep, write_fault, gfn);

<blue>	if (unlikely(is_noslot_pfn(pfn))) {</blue>
<blue>		vcpu->stat.pf_mmio_spte_created++;</blue>
		mark_mmio_spte(vcpu, sptep, gfn, pte_access);
		return RET_PF_EMULATE;
	}

<blue>	if (is_shadow_present_pte(*sptep)) {</blue>
		/*
		 * If we overwrite a PTE page pointer with a 2MB PMD, unlink
		 * the parent of the now unreachable PTE.
		 */
<blue>		if (level > PG_LEVEL_4K && !is_large_pte(*sptep)) {</blue>
			struct kvm_mmu_page *child;
			u64 pte = *sptep;

<blue>			child = to_shadow_page(pte & SPTE_BASE_ADDR_MASK);</blue>
			drop_parent_pte(child, sptep);
			flush = true;
<blue>		} else if (pfn != spte_to_pfn(*sptep)) {</blue>
			pgprintk(&quot;hfn old %llx new %llx\n&quot;,
				 spte_to_pfn(*sptep), pfn);
<yellow>			drop_spte(vcpu->kvm, sptep);</yellow>
			flush = true;
		} else
			was_rmapped = 1;
	}

<blue>	wrprot = make_spte(vcpu, sp, slot, pte_access, gfn, pfn, *sptep, prefetch,</blue>
			   true, host_writable, &amp;spte);

	if (*sptep == spte) {
		ret = RET_PF_SPURIOUS;
	} else {
<blue>		flush |= mmu_spte_update(sptep, spte);</blue>
<yellow>		trace_kvm_mmu_set_spte(level, gfn, sptep);</yellow>
	}

<blue>	if (wrprot) {</blue>
<yellow>		if (write_fault)</yellow>
			ret = RET_PF_EMULATE;
	}

<blue>	if (flush)</blue>
<yellow>		kvm_flush_remote_tlbs_with_address(vcpu->kvm, gfn,</yellow>
<yellow>				KVM_PAGES_PER_HPAGE(level));</yellow>

	pgprintk(&quot;%s: setting spte %llx\n&quot;, __func__, *sptep);

<blue>	if (!was_rmapped) {</blue>
<blue>		WARN_ON_ONCE(ret == RET_PF_SPURIOUS);</blue>
<blue>		rmap_add(vcpu, slot, sptep, gfn, pte_access);</blue>
	} else {
		/* Already rmapped but the pte_access bits may have changed. */
<blue>		kvm_mmu_page_set_access(sp, spte_index(sptep), pte_access);</blue>
	}

	return ret;
}

static int direct_pte_prefetch_many(struct kvm_vcpu *vcpu,
				    struct kvm_mmu_page *sp,
				    u64 *start, u64 *end)
<blue>{</blue>
	struct page *pages[PTE_PREFETCH_NUM];
	struct kvm_memory_slot *slot;
<blue>	unsigned int access = sp->role.access;</blue>
	int i, ret;
	gfn_t gfn;

	gfn = kvm_mmu_page_get_gfn(sp, spte_index(start));
<blue>	slot = gfn_to_memslot_dirty_bitmap(vcpu, gfn, access & ACC_WRITE_MASK);</blue>
	if (!slot)
		return -1;

<blue>	ret = gfn_to_page_many_atomic(slot, gfn, pages, end - start);</blue>
	if (ret &lt;= 0)
		return -1;

<blue>	for (i = 0; i < ret; i++, gfn++, start++) {</blue>
		mmu_set_spte(vcpu, slot, start, access, gfn,
<blue>			     page_to_pfn(pages[i]), NULL);</blue>
<blue>		put_page(pages[i]);</blue>
	}

	return 0;
}

static void __direct_pte_prefetch(struct kvm_vcpu *vcpu,
				  struct kvm_mmu_page *sp, u64 *sptep)
{
	u64 *spte, *start = NULL;
	int i;

<blue>	WARN_ON(!sp->role.direct);</blue>

<blue>	i = spte_index(sptep) & ~(PTE_PREFETCH_NUM - 1);</blue>
	spte = sp-&gt;spt + i;

<blue>	for (i = 0; i < PTE_PREFETCH_NUM; i++, spte++) {</blue>
<blue>		if (is_shadow_present_pte(*spte) || spte == sptep) {</blue>
<blue>			if (!start)</blue>
				continue;
<blue>			if (direct_pte_prefetch_many(vcpu, sp, start, spte) < 0)</blue>
				return;
			start = NULL;
<blue>		} else if (!start)</blue>
			start = spte;
	}
<blue>	if (start)</blue>
<blue>		direct_pte_prefetch_many(vcpu, sp, start, spte);</blue>
<blue>}</blue>

static void direct_pte_prefetch(struct kvm_vcpu *vcpu, u64 *sptep)
{
	struct kvm_mmu_page *sp;

<yellow>	sp = sptep_to_sp(sptep);</yellow>

	/*
	 * Without accessed bits, there&#x27;s no way to distinguish between
	 * actually accessed translations and prefetched, so disable pte
	 * prefetch if accessed bits aren&#x27;t available.
	 */
	if (sp_ad_disabled(sp))
		return;

<yellow>	if (sp->role.level > PG_LEVEL_4K)</yellow>
		return;

	/*
	 * If addresses are being invalidated, skip prefetching to avoid
	 * accidentally prefetching those addresses.
	 */
<yellow>	if (unlikely(vcpu->kvm->mmu_invalidate_in_progress))</yellow>
		return;

<yellow>	__direct_pte_prefetch(vcpu, sp, sptep);</yellow>
}

/*
 * Lookup the mapping level for @gfn in the current mm.
 *
 * WARNING!  Use of host_pfn_mapping_level() requires the caller and the end
 * consumer to be tied into KVM&#x27;s handlers for MMU notifier events!
 *
 * There are several ways to safely use this helper:
 *
 * - Check mmu_invalidate_retry_hva() after grabbing the mapping level, before
 *   consuming it.  In this case, mmu_lock doesn&#x27;t need to be held during the
 *   lookup, but it does need to be held while checking the MMU notifier.
 *
 * - Hold mmu_lock AND ensure there is no in-progress MMU notifier invalidation
 *   event for the hva.  This can be done by explicit checking the MMU notifier
 *   or by ensuring that KVM already has a valid mapping that covers the hva.
 *
 * - Do not use the result to install new mappings, e.g. use the host mapping
 *   level only to decide whether or not to zap an entry.  In this case, it&#x27;s
 *   not required to hold mmu_lock (though it&#x27;s highly likely the caller will
 *   want to hold mmu_lock anyways, e.g. to modify SPTEs).
 *
 * Note!  The lookup can still race with modifications to host page tables, but
 * the above &quot;rules&quot; ensure KVM will not _consume_ the result of the walk if a
 * race with the primary MMU occurs.
 */
static int host_pfn_mapping_level(struct kvm *kvm, gfn_t gfn,
				  const struct kvm_memory_slot *slot)
{
	int level = PG_LEVEL_4K;
	unsigned long hva;
	unsigned long flags;
	pgd_t pgd;
	p4d_t p4d;
	pud_t pud;
	pmd_t pmd;

	/*
	 * Note, using the already-retrieved memslot and __gfn_to_hva_memslot()
	 * is not solely for performance, it&#x27;s also necessary to avoid the
	 * &quot;writable&quot; check in __gfn_to_hva_many(), which will always fail on
	 * read-only memslots due to gfn_to_hva() assuming writes.  Earlier
	 * page fault steps have already verified the guest isn&#x27;t writing a
	 * read-only memslot.
	 */
<blue>	hva = __gfn_to_hva_memslot(slot, gfn);</blue>

	/*
	 * Disable IRQs to prevent concurrent tear down of host page tables,
	 * e.g. if the primary MMU promotes a P*D to a huge page and then frees
	 * the original page table.
	 */
	local_irq_save(flags);

	/*
	 * Read each entry once.  As above, a non-leaf entry can be promoted to
	 * a huge page _during_ this walk.  Re-reading the entry could send the
	 * walk into the weeks, e.g. p*d_large() returns false (sees the old
	 * value) and then p*d_offset() walks into the target huge page instead
	 * of the old page table (sees the new value).
	 */
<blue>	pgd = READ_ONCE(*pgd_offset(kvm->mm, hva));</blue>
<yellow>	if (pgd_none(pgd))</yellow>
		goto out;

<blue>	p4d = READ_ONCE(*p4d_offset(&pgd, hva));</blue>
<blue>	if (p4d_none(p4d) || !p4d_present(p4d))</blue>
		goto out;

<blue>	pud = READ_ONCE(*pud_offset(&p4d, hva));</blue>
<blue>	if (pud_none(pud) || !pud_present(pud))</blue>
		goto out;

<blue>	if (pud_large(pud)) {</blue>
		level = PG_LEVEL_1G;
		goto out;
	}

<blue>	pmd = READ_ONCE(*pmd_offset(&pud, hva));</blue>
<blue>	if (pmd_none(pmd) || !pmd_present(pmd))</blue>
		goto out;

<blue>	if (pmd_large(pmd))</blue>
		level = PG_LEVEL_2M;

out:
<blue>	local_irq_restore(flags);</blue>
	return level;
}

int kvm_mmu_max_mapping_level(struct kvm *kvm,
			      const struct kvm_memory_slot *slot, gfn_t gfn,
			      int max_level)
<blue>{</blue>
	struct kvm_lpage_info *linfo;
	int host_level;

<blue>	max_level = min(max_level, max_huge_page_level);</blue>
<blue>	for ( ; max_level > PG_LEVEL_4K; max_level--) {</blue>
<blue>		linfo = lpage_info_slot(gfn, slot, max_level);</blue>
		if (!linfo-&gt;disallow_lpage)
			break;
	}

<blue>	if (max_level == PG_LEVEL_4K)</blue>
		return PG_LEVEL_4K;

<blue>	host_level = host_pfn_mapping_level(kvm, gfn, slot);</blue>
<blue>	return min(host_level, max_level);</blue>
}

void kvm_mmu_hugepage_adjust(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault)
{
<blue>	struct kvm_memory_slot *slot = fault->slot;</blue>
	kvm_pfn_t mask;

<blue>	fault->huge_page_disallowed = fault->exec && fault->nx_huge_page_workaround_enabled;</blue>

	if (unlikely(fault-&gt;max_level == PG_LEVEL_4K))
		return;

<blue>	if (is_error_noslot_pfn(fault->pfn))</blue>
		return;

<blue>	if (kvm_slot_dirty_track_enabled(slot))</blue>
		return;

	/*
	 * Enforce the iTLB multihit workaround after capturing the requested
	 * level, which will be used to do precise, accurate accounting.
	 */
<blue>	fault->req_level = kvm_mmu_max_mapping_level(vcpu->kvm, slot,</blue>
						     fault-&gt;gfn, fault-&gt;max_level);
<blue>	if (fault->req_level == PG_LEVEL_4K || fault->huge_page_disallowed)</blue>
		return;

	/*
	 * mmu_invalidate_retry() was successful and mmu_lock is held, so
	 * the pmd can&#x27;t be split from under us.
	 */
<blue>	fault->goal_level = fault->req_level;</blue>
<blue>	mask = KVM_PAGES_PER_HPAGE(fault->goal_level) - 1;</blue>
	VM_BUG_ON((fault-&gt;gfn &amp; mask) != (fault-&gt;pfn &amp; mask));
	fault-&gt;pfn &amp;= ~mask;
<blue>}</blue>

<yellow>void disallowed_hugepage_adjust(struct kvm_page_fault *fault, u64 spte, int cur_level)</yellow>
{
<yellow>	if (cur_level > PG_LEVEL_4K &&</yellow>
<yellow>	    cur_level == fault->goal_level &&</yellow>
<yellow>	    is_shadow_present_pte(spte) &&</yellow>
<yellow>	    !is_large_pte(spte)) {</yellow>
		/*
		 * A small SPTE exists for this pfn, but FNAME(fetch)
		 * and __direct_map would like to create a large PTE
		 * instead: just force them to go down another level,
		 * patching back for them into pfn the next 9 bits of
		 * the address.
		 */
<yellow>		u64 page_mask = KVM_PAGES_PER_HPAGE(cur_level) -</yellow>
<yellow>				KVM_PAGES_PER_HPAGE(cur_level - 1);</yellow>
		fault-&gt;pfn |= fault-&gt;gfn &amp; page_mask;
		fault-&gt;goal_level--;
	}
<yellow>}</yellow>

static int __direct_map(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault)
{
	struct kvm_shadow_walk_iterator it;
	struct kvm_mmu_page *sp;
	int ret;
<yellow>	gfn_t base_gfn = fault->gfn;</yellow>

	kvm_mmu_hugepage_adjust(vcpu, fault);

<yellow>	trace_kvm_mmu_spte_requested(fault);</yellow>
<yellow>	for_each_shadow_entry(vcpu, fault->addr, it) {</yellow>
		/*
		 * We cannot overwrite existing page tables with an NX
		 * large page, as the leaf could be executable.
		 */
<yellow>		if (fault->nx_huge_page_workaround_enabled)</yellow>
<yellow>			disallowed_hugepage_adjust(fault, *it.sptep, it.level);</yellow>

<yellow>		base_gfn = fault->gfn & ~(KVM_PAGES_PER_HPAGE(it.level) - 1);</yellow>
		if (it.level == fault-&gt;goal_level)
			break;

<yellow>		sp = kvm_mmu_get_child_sp(vcpu, it.sptep, base_gfn, true, ACC_ALL);</yellow>
		if (sp == ERR_PTR(-EEXIST))
			continue;

<yellow>		link_shadow_page(vcpu, it.sptep, sp);</yellow>
<yellow>		if (fault->is_tdp && fault->huge_page_disallowed &&</yellow>
<yellow>		    fault->req_level >= it.level)</yellow>
<yellow>			account_huge_nx_page(vcpu->kvm, sp);</yellow>
	}

<yellow>	if (WARN_ON_ONCE(it.level != fault->goal_level))</yellow>
		return -EFAULT;

<yellow>	ret = mmu_set_spte(vcpu, fault->slot, it.sptep, ACC_ALL,</yellow>
			   base_gfn, fault-&gt;pfn, fault);
	if (ret == RET_PF_SPURIOUS)
		return ret;

<yellow>	direct_pte_prefetch(vcpu, it.sptep);</yellow>
	return ret;
}

static void kvm_send_hwpoison_signal(unsigned long address, struct task_struct *tsk)
{
	send_sig_mceerr(BUS_MCEERR_AR, (void __user *)address, PAGE_SHIFT, tsk);
}

static int kvm_handle_bad_page(struct kvm_vcpu *vcpu, gfn_t gfn, kvm_pfn_t pfn)
{
	/*
	 * Do not cache the mmio info caused by writing the readonly gfn
	 * into the spte otherwise read access on readonly gfn also can
	 * caused mmio page fault and treat it as mmio access.
	 */
	if (pfn == KVM_PFN_ERR_RO_FAULT)
		return RET_PF_EMULATE;

<yellow>	if (pfn == KVM_PFN_ERR_HWPOISON) {</yellow>
<yellow>		kvm_send_hwpoison_signal(kvm_vcpu_gfn_to_hva(vcpu, gfn), current);</yellow>
		return RET_PF_RETRY;
	}

	return -EFAULT;
}

<blue>static int handle_abnormal_pfn(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault,</blue>
			       unsigned int access)
{
	/* The pfn is invalid, report the error! */
<blue>	if (unlikely(is_error_pfn(fault->pfn)))</blue>
<blue>		return kvm_handle_bad_page(vcpu, fault->gfn, fault->pfn);</blue>

<blue>	if (unlikely(!fault->slot)) {</blue>
<blue>		gva_t gva = fault->is_tdp ? 0 : fault->addr;</blue>

<blue>		vcpu_cache_mmio_info(vcpu, gva, fault->gfn,</blue>
				     access &amp; shadow_mmio_access_mask);
		/*
		 * If MMIO caching is disabled, emulate immediately without
		 * touching the shadow page tables as attempting to install an
		 * MMIO SPTE will just be an expensive nop.  Do not cache MMIO
		 * whose gfn is greater than host.MAXPHYADDR, any guest that
		 * generates such gfns is running nested and is being tricked
		 * by L0 userspace (you can observe gfn &gt; L1.MAXPHYADDR if
		 * and only if L1&#x27;s MAXPHYADDR is inaccurate with respect to
		 * the hardware&#x27;s).
		 */
<blue>		if (unlikely(!enable_mmio_caching) ||</blue>
<blue>		    unlikely(fault->gfn > kvm_mmu_max_gfn()))</blue>
			return RET_PF_EMULATE;
	}

	return RET_PF_CONTINUE;
<blue>}</blue>

static bool page_fault_can_be_fast(struct kvm_page_fault *fault)
{
	/*
	 * Page faults with reserved bits set, i.e. faults on MMIO SPTEs, only
	 * reach the common page fault handler if the SPTE has an invalid MMIO
	 * generation number.  Refreshing the MMIO generation needs to go down
	 * the slow path.  Note, EPT Misconfigs do NOT set the PRESENT flag!
	 */
<blue>	if (fault->rsvd)</blue>
		return false;

	/*
	 * #PF can be fast if:
	 *
	 * 1. The shadow page table entry is not present and A/D bits are
	 *    disabled _by KVM_, which could mean that the fault is potentially
	 *    caused by access tracking (if enabled).  If A/D bits are enabled
	 *    by KVM, but disabled by L1 for L2, KVM is forced to disable A/D
	 *    bits for L2 and employ access tracking, but the fast page fault
	 *    mechanism only supports direct MMUs.
	 * 2. The shadow page table entry is present, the access is a write,
	 *    and no reserved bits are set (MMIO SPTEs cannot be &quot;fixed&quot;), i.e.
	 *    the fault was caused by a write-protection violation.  If the
	 *    SPTE is MMU-writable (determined later), the fault can be fixed
	 *    by setting the Writable bit, which can be done out of mmu_lock.
	 */
<blue>	if (!fault->present)</blue>
<blue>		return !kvm_ad_enabled();</blue>

	/*
	 * Note, instruction fetches and writes are mutually exclusive, ignore
	 * the &quot;exec&quot; flag.
	 */
<blue>	return fault->write;</blue>
}

/*
 * Returns true if the SPTE was fixed successfully. Otherwise,
 * someone else modified the SPTE from its original value.
 */
static bool
fast_pf_fix_direct_spte(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault,
			u64 *sptep, u64 old_spte, u64 new_spte)
{
	/*
	 * Theoretically we could also set dirty bit (and flush TLB) here in
	 * order to eliminate unnecessary PML logging. See comments in
	 * set_spte. But fast_page_fault is very unlikely to happen with PML
	 * enabled, so we do not do this. This might result in the same GPA
	 * to be logged in PML buffer again when the write really happens, and
	 * eventually to be called by mark_page_dirty twice. But it&#x27;s also no
	 * harm. This also avoids the TLB flush needed after setting dirty bit
	 * so non-PML cases won&#x27;t be impacted.
	 *
	 * Compare with set_spte where instead shadow_dirty_mask is set.
	 */
	if (!try_cmpxchg64(sptep, &amp;old_spte, new_spte))
		return false;

<yellow>	if (is_writable_pte(new_spte) && !is_writable_pte(old_spte))</yellow>
<yellow>		mark_page_dirty_in_slot(vcpu->kvm, fault->slot, fault->gfn);</yellow>

	return true;
}

<yellow>static bool is_access_allowed(struct kvm_page_fault *fault, u64 spte)</yellow>
{
<blue>	if (fault->exec)</blue>
<yellow>		return is_executable_pte(spte);</yellow>

<blue>	if (fault->write)</blue>
<blue>		return is_writable_pte(spte);</blue>

	/* Fault was on Read access */
<yellow>	return spte & PT_PRESENT_MASK;</yellow>
<blue>}</blue>

/*
 * Returns the last level spte pointer of the shadow page walk for the given
 * gpa, and sets *spte to the spte value. This spte may be non-preset. If no
 * walk could be performed, returns NULL and *spte does not contain valid data.
 *
 * Contract:
 *  - Must be called between walk_shadow_page_lockless_{begin,end}.
 *  - The returned sptep must not be used after walk_shadow_page_lockless_end.
 */
static u64 *fast_pf_get_last_sptep(struct kvm_vcpu *vcpu, gpa_t gpa, u64 *spte)
{
	struct kvm_shadow_walk_iterator iterator;
	u64 old_spte;
	u64 *sptep = NULL;

<yellow>	for_each_shadow_entry_lockless(vcpu, gpa, iterator, old_spte) {</yellow>
		sptep = iterator.sptep;
		*spte = old_spte;
	}

	return sptep;
}

/*
 * Returns one of RET_PF_INVALID, RET_PF_FIXED or RET_PF_SPURIOUS.
 */
static int fast_page_fault(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault)
{
	struct kvm_mmu_page *sp;
<yellow>	int ret = RET_PF_INVALID;</yellow>
	u64 spte = 0ull;
	u64 *sptep = NULL;
	uint retry_count = 0;

<blue>	if (!page_fault_can_be_fast(fault))</blue>
		return ret;

<blue>	walk_shadow_page_lockless_begin(vcpu);</blue>

	do {
		u64 new_spte;

<blue>		if (is_tdp_mmu(vcpu->arch.mmu))</blue>
<blue>			sptep = kvm_tdp_mmu_fast_pf_get_last_sptep(vcpu, fault->addr, &spte);</blue>
		else
<yellow>			sptep = fast_pf_get_last_sptep(vcpu, fault->addr, &spte);</yellow>

<blue>		if (!is_shadow_present_pte(spte))</blue>
			break;

<blue>		sp = sptep_to_sp(sptep);</blue>
<blue>		if (!is_last_spte(spte, sp->role.level))</blue>
			break;

		/*
		 * Check whether the memory access that caused the fault would
		 * still cause it if it were to be performed right now. If not,
		 * then this is a spurious fault caused by TLB lazily flushed,
		 * or some other CPU has already fixed the PTE after the
		 * current CPU took the fault.
		 *
		 * Need not check the access of upper level table entries since
		 * they are always ACC_ALL.
		 */
<blue>		if (is_access_allowed(fault, spte)) {</blue>
<yellow>			ret = RET_PF_SPURIOUS;</yellow>
			break;
		}

		new_spte = spte;

		/*
		 * KVM only supports fixing page faults outside of MMU lock for
		 * direct MMUs, nested MMUs are always indirect, and KVM always
		 * uses A/D bits for non-nested MMUs.  Thus, if A/D bits are
		 * enabled, the SPTE can&#x27;t be an access-tracked SPTE.
		 */
<blue>		if (unlikely(!kvm_ad_enabled()) && is_access_track_spte(spte))</blue>
<yellow>			new_spte = restore_acc_track_spte(new_spte);</yellow>

		/*
		 * To keep things simple, only SPTEs that are MMU-writable can
		 * be made fully writable outside of mmu_lock, e.g. only SPTEs
		 * that were write-protected for dirty-logging or access
		 * tracking are handled here.  Don&#x27;t bother checking if the
		 * SPTE is writable to prioritize running with A/D bits enabled.
		 * The is_access_allowed() check above handles the common case
		 * of the fault being spurious, and the SPTE is known to be
		 * shadow-present, i.e. except for access tracking restoration
		 * making the new SPTE writable, the check is wasteful.
		 */
<blue>		if (fault->write && is_mmu_writable_spte(spte)) {</blue>
			new_spte |= PT_WRITABLE_MASK;

			/*
			 * Do not fix write-permission on the large spte when
			 * dirty logging is enabled. Since we only dirty the
			 * first page into the dirty-bitmap in
			 * fast_pf_fix_direct_spte(), other pages are missed
			 * if its slot has dirty logging enabled.
			 *
			 * Instead, we let the slow page fault path create a
			 * normal spte to fix the access.
			 */
<yellow>			if (sp->role.level > PG_LEVEL_4K &&</yellow>
<yellow>			    kvm_slot_dirty_track_enabled(fault->slot))</yellow>
				break;
		}

		/* Verify that the fault can be handled in the fast path */
<blue>		if (new_spte == spte ||</blue>
<yellow>		    !is_access_allowed(fault, new_spte))</yellow>
			break;

		/*
		 * Currently, fast page fault only works for direct mapping
		 * since the gfn is not stable for indirect shadow page. See
		 * Documentation/virt/kvm/locking.rst to get more detail.
		 */
<yellow>		if (fast_pf_fix_direct_spte(vcpu, fault, sptep, spte, new_spte)) {</yellow>
<yellow>			ret = RET_PF_FIXED;</yellow>
			break;
		}

<yellow>		if (++retry_count > 4) {</yellow>
<yellow>			printk_once(KERN_WARNING</yellow>
				&quot;kvm: Fast #PF retrying more than 4 times.\n&quot;);
			break;
		}

	} while (true);

<blue>	trace_fast_page_fault(vcpu, fault, sptep, spte, ret);</blue>
<blue>	walk_shadow_page_lockless_end(vcpu);</blue>

<blue>	if (ret != RET_PF_INVALID)</blue>
<yellow>		vcpu->stat.pf_fast++;</yellow>

	return ret;
}

static void mmu_free_root_page(struct kvm *kvm, hpa_t *root_hpa,
			       struct list_head *invalid_list)
<blue>{</blue>
	struct kvm_mmu_page *sp;

<blue>	if (!VALID_PAGE(*root_hpa))</blue>
		return;

<blue>	sp = to_shadow_page(*root_hpa & SPTE_BASE_ADDR_MASK);</blue>
<yellow>	if (WARN_ON(!sp))</yellow>
		return;

<blue>	if (is_tdp_mmu_page(sp))</blue>
<blue>		kvm_tdp_mmu_put_root(kvm, sp, false);</blue>
<blue>	else if (!--sp->root_count && sp->role.invalid)</blue>
<blue>		kvm_mmu_prepare_zap_page(kvm, sp, invalid_list);</blue>

<blue>	*root_hpa = INVALID_PAGE;</blue>
}

/* roots_to_free must be some combination of the KVM_MMU_ROOT_* flags */
void kvm_mmu_free_roots(struct kvm *kvm, struct kvm_mmu *mmu,
			ulong roots_to_free)
<blue>{</blue>
	int i;
	LIST_HEAD(invalid_list);
	bool free_active_root;

	BUILD_BUG_ON(KVM_MMU_NUM_PREV_ROOTS &gt;= BITS_PER_LONG);

	/* Before acquiring the MMU lock, see if we need to do any real work. */
	free_active_root = (roots_to_free &amp; KVM_MMU_ROOT_CURRENT)
<blue>		&& VALID_PAGE(mmu->root.hpa);</blue>

	if (!free_active_root) {
<blue>		for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++)</blue>
<blue>			if ((roots_to_free & KVM_MMU_ROOT_PREVIOUS(i)) &&</blue>
<blue>			    VALID_PAGE(mmu->prev_roots[i].hpa))</blue>
				break;

		if (i == KVM_MMU_NUM_PREV_ROOTS)
			return;
	}

<blue>	write_lock(&kvm->mmu_lock);</blue>

<blue>	for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++)</blue>
<blue>		if (roots_to_free & KVM_MMU_ROOT_PREVIOUS(i))</blue>
<blue>			mmu_free_root_page(kvm, &mmu->prev_roots[i].hpa,</blue>
					   &amp;invalid_list);

<blue>	if (free_active_root) {</blue>
<blue>		if (to_shadow_page(mmu->root.hpa)) {</blue>
<blue>			mmu_free_root_page(kvm, &mmu->root.hpa, &invalid_list);</blue>
<yellow>		} else if (mmu->pae_root) {</yellow>
<yellow>			for (i = 0; i < 4; ++i) {</yellow>
<yellow>				if (!IS_VALID_PAE_ROOT(mmu->pae_root[i]))</yellow>
					continue;

<yellow>				mmu_free_root_page(kvm, &mmu->pae_root[i],</yellow>
						   &amp;invalid_list);
				mmu-&gt;pae_root[i] = INVALID_PAE_ROOT;
			}
		}
<blue>		mmu->root.hpa = INVALID_PAGE;</blue>
		mmu-&gt;root.pgd = 0;
	}

<blue>	kvm_mmu_commit_zap_page(kvm, &invalid_list);</blue>
<blue>	write_unlock(&kvm->mmu_lock);</blue>
}
EXPORT_SYMBOL_GPL(kvm_mmu_free_roots);

void kvm_mmu_free_guest_mode_roots(struct kvm *kvm, struct kvm_mmu *mmu)
{
	unsigned long roots_to_free = 0;
	hpa_t root_hpa;
	int i;

	/*
	 * This should not be called while L2 is active, L2 can&#x27;t invalidate
	 * _only_ its own roots, e.g. INVVPID unconditionally exits.
	 */
<yellow>	WARN_ON_ONCE(mmu->root_role.guest_mode);</yellow>

<yellow>	for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++) {</yellow>
<yellow>		root_hpa = mmu->prev_roots[i].hpa;</yellow>
		if (!VALID_PAGE(root_hpa))
			continue;

<yellow>		if (!to_shadow_page(root_hpa) ||</yellow>
			to_shadow_page(root_hpa)-&gt;role.guest_mode)
<yellow>			roots_to_free |= KVM_MMU_ROOT_PREVIOUS(i);</yellow>
	}

<yellow>	kvm_mmu_free_roots(kvm, mmu, roots_to_free);</yellow>
}
EXPORT_SYMBOL_GPL(kvm_mmu_free_guest_mode_roots);


static int mmu_check_root(struct kvm_vcpu *vcpu, gfn_t root_gfn)
{
	int ret = 0;

	if (!kvm_vcpu_is_visible_gfn(vcpu, root_gfn)) {
<yellow>		kvm_make_request(KVM_REQ_TRIPLE_FAULT, vcpu);</yellow>
		ret = 1;
	}

	return ret;
}

static hpa_t mmu_alloc_root(struct kvm_vcpu *vcpu, gfn_t gfn, int quadrant,
			    u8 level)
{
<blue>	union kvm_mmu_page_role role = vcpu->arch.mmu->root_role;</blue>
	struct kvm_mmu_page *sp;

	role.level = level;
	role.quadrant = quadrant;

<yellow>	WARN_ON_ONCE(quadrant && !role.has_4_byte_gpte);</yellow>
<blue>	WARN_ON_ONCE(role.direct && role.has_4_byte_gpte);</blue>

<blue>	sp = kvm_mmu_get_shadow_page(vcpu, gfn, role);</blue>
	++sp-&gt;root_count;

<blue>	return __pa(sp->spt);</blue>
}

static int mmu_alloc_direct_roots(struct kvm_vcpu *vcpu)
{
	struct kvm_mmu *mmu = vcpu-&gt;arch.mmu;
<blue>	u8 shadow_root_level = mmu->root_role.level;</blue>
	hpa_t root;
	unsigned i;
	int r;

	write_lock(&amp;vcpu-&gt;kvm-&gt;mmu_lock);
<blue>	r = make_mmu_pages_available(vcpu);</blue>
	if (r &lt; 0)
		goto out_unlock;

<blue>	if (is_tdp_mmu_enabled(vcpu->kvm)) {</blue>
<blue>		root = kvm_tdp_mmu_get_vcpu_root_hpa(vcpu);</blue>
<blue>		mmu->root.hpa = root;</blue>
<yellow>	} else if (shadow_root_level >= PT64_ROOT_4LEVEL) {</yellow>
<yellow>		root = mmu_alloc_root(vcpu, 0, 0, shadow_root_level);</yellow>
		mmu-&gt;root.hpa = root;
<yellow>	} else if (shadow_root_level == PT32E_ROOT_LEVEL) {</yellow>
<yellow>		if (WARN_ON_ONCE(!mmu->pae_root)) {</yellow>
			r = -EIO;
			goto out_unlock;
		}

		for (i = 0; i &lt; 4; ++i) {
<yellow>			WARN_ON_ONCE(IS_VALID_PAE_ROOT(mmu->pae_root[i]));</yellow>

<yellow>			root = mmu_alloc_root(vcpu, i << (30 - PAGE_SHIFT), 0,</yellow>
					      PT32_ROOT_LEVEL);
			mmu-&gt;pae_root[i] = root | PT_PRESENT_MASK |
					   shadow_me_value;
		}
<yellow>		mmu->root.hpa = __pa(mmu->pae_root);</yellow>
	} else {
<yellow>		WARN_ONCE(1, "Bad TDP root level = %d\n", shadow_root_level);</yellow>
		r = -EIO;
		goto out_unlock;
	}

	/* root.pgd is ignored for direct MMUs. */
	mmu-&gt;root.pgd = 0;
out_unlock:
<yellow>	write_unlock(&vcpu->kvm->mmu_lock);</yellow>
	return r;
}

static int mmu_first_shadow_root_alloc(struct kvm *kvm)
{
	struct kvm_memslots *slots;
	struct kvm_memory_slot *slot;
	int r = 0, i, bkt;

	/*
	 * Check if this is the first shadow root being allocated before
	 * taking the lock.
	 */
<blue>	if (kvm_shadow_root_allocated(kvm))</blue>
		return 0;

<blue>	mutex_lock(&kvm->slots_arch_lock);</blue>

	/* Recheck, under the lock, whether this is the first shadow root. */
<blue>	if (kvm_shadow_root_allocated(kvm))</blue>
		goto out_unlock;

	/*
	 * Check if anything actually needs to be allocated, e.g. all metadata
	 * will be allocated upfront if TDP is disabled.
	 */
<blue>	if (kvm_memslots_have_rmaps(kvm) &&</blue>
<yellow>	    kvm_page_track_write_tracking_enabled(kvm))</yellow>
		goto out_success;

<blue>	for (i = 0; i < KVM_ADDRESS_SPACE_NUM; i++) {</blue>
<blue>		slots = __kvm_memslots(kvm, i);</blue>
<blue>		kvm_for_each_memslot(slot, bkt, slots) {</blue>
			/*
			 * Both of these functions are no-ops if the target is
			 * already allocated, so unconditionally calling both
			 * is safe.  Intentionally do NOT free allocations on
			 * failure to avoid having to track which allocations
			 * were made now versus when the memslot was created.
			 * The metadata is guaranteed to be freed when the slot
			 * is freed, and will be kept/used if userspace retries
			 * KVM_RUN instead of killing the VM.
			 */
<blue>			r = memslot_rmap_alloc(slot, slot->npages);</blue>
			if (r)
				goto out_unlock;
<blue>			r = kvm_page_track_write_tracking_alloc(slot);</blue>
			if (r)
				goto out_unlock;
		}
	}

	/*
	 * Ensure that shadow_root_allocated becomes true strictly after
	 * all the related pointers are set.
	 */
out_success:
<blue>	smp_store_release(&kvm->arch.shadow_root_allocated, true);</blue>

out_unlock:
<yellow>	mutex_unlock(&kvm->slots_arch_lock);</yellow>
	return r;
}

static int mmu_alloc_shadow_roots(struct kvm_vcpu *vcpu)
{
	struct kvm_mmu *mmu = vcpu-&gt;arch.mmu;
	u64 pdptrs[4], pm_mask;
	gfn_t root_gfn, root_pgd;
	int quadrant, i, r;
	hpa_t root;

<blue>	root_pgd = mmu->get_guest_pgd(vcpu);</blue>
	root_gfn = root_pgd &gt;&gt; PAGE_SHIFT;

	if (mmu_check_root(vcpu, root_gfn))
		return 1;

	/*
	 * On SVM, reading PDPTRs might access guest memory, which might fault
	 * and thus might sleep.  Grab the PDPTRs before acquiring mmu_lock.
	 */
<blue>	if (mmu->cpu_role.base.level == PT32E_ROOT_LEVEL) {</blue>
<yellow>		for (i = 0; i < 4; ++i) {</yellow>
<yellow>			pdptrs[i] = mmu->get_pdptr(vcpu, i);</yellow>
			if (!(pdptrs[i] &amp; PT_PRESENT_MASK))
				continue;

<yellow>			if (mmu_check_root(vcpu, pdptrs[i] >> PAGE_SHIFT))</yellow>
				return 1;
		}
	}

<blue>	r = mmu_first_shadow_root_alloc(vcpu->kvm);</blue>
	if (r)
		return r;

<blue>	write_lock(&vcpu->kvm->mmu_lock);</blue>
<blue>	r = make_mmu_pages_available(vcpu);</blue>
	if (r &lt; 0)
		goto out_unlock;

	/*
	 * Do we shadow a long mode page table? If so we need to
	 * write-protect the guests page table root.
	 */
<blue>	if (mmu->cpu_role.base.level >= PT64_ROOT_4LEVEL) {</blue>
		root = mmu_alloc_root(vcpu, root_gfn, 0,
<blue>				      mmu->root_role.level);</blue>
<blue>		mmu->root.hpa = root;</blue>
		goto set_root_pgd;
	}

<yellow>	if (WARN_ON_ONCE(!mmu->pae_root)) {</yellow>
		r = -EIO;
		goto out_unlock;
	}

	/*
	 * We shadow a 32 bit page table. This may be a legacy 2-level
	 * or a PAE 3-level page table. In either case we need to be aware that
	 * the shadow page table may be a PAE or a long mode page table.
	 */
<yellow>	pm_mask = PT_PRESENT_MASK | shadow_me_value;</yellow>
	if (mmu-&gt;root_role.level &gt;= PT64_ROOT_4LEVEL) {
		pm_mask |= PT_ACCESSED_MASK | PT_WRITABLE_MASK | PT_USER_MASK;

<yellow>		if (WARN_ON_ONCE(!mmu->pml4_root)) {</yellow>
			r = -EIO;
			goto out_unlock;
		}
<yellow>		mmu->pml4_root[0] = __pa(mmu->pae_root) | pm_mask;</yellow>

		if (mmu-&gt;root_role.level == PT64_ROOT_5LEVEL) {
<yellow>			if (WARN_ON_ONCE(!mmu->pml5_root)) {</yellow>
				r = -EIO;
				goto out_unlock;
			}
<yellow>			mmu->pml5_root[0] = __pa(mmu->pml4_root) | pm_mask;</yellow>
		}
	}

<yellow>	for (i = 0; i < 4; ++i) {</yellow>
<yellow>		WARN_ON_ONCE(IS_VALID_PAE_ROOT(mmu->pae_root[i]));</yellow>

<yellow>		if (mmu->cpu_role.base.level == PT32E_ROOT_LEVEL) {</yellow>
<yellow>			if (!(pdptrs[i] & PT_PRESENT_MASK)) {</yellow>
<yellow>				mmu->pae_root[i] = INVALID_PAE_ROOT;</yellow>
				continue;
			}
<yellow>			root_gfn = pdptrs[i] >> PAGE_SHIFT;</yellow>
		}

		/*
		 * If shadowing 32-bit non-PAE page tables, each PAE page
		 * directory maps one quarter of the guest&#x27;s non-PAE page
		 * directory. Othwerise each PAE page direct shadows one guest
		 * PAE page directory so that quadrant should be 0.
		 */
<yellow>		quadrant = (mmu->cpu_role.base.level == PT32_ROOT_LEVEL) ? i : 0;</yellow>

<yellow>		root = mmu_alloc_root(vcpu, root_gfn, quadrant, PT32_ROOT_LEVEL);</yellow>
		mmu-&gt;pae_root[i] = root | pm_mask;
	}

<yellow>	if (mmu->root_role.level == PT64_ROOT_5LEVEL)</yellow>
<yellow>		mmu->root.hpa = __pa(mmu->pml5_root);</yellow>
<yellow>	else if (mmu->root_role.level == PT64_ROOT_4LEVEL)</yellow>
<yellow>		mmu->root.hpa = __pa(mmu->pml4_root);</yellow>
	else
<yellow>		mmu->root.hpa = __pa(mmu->pae_root);</yellow>

set_root_pgd:
	mmu-&gt;root.pgd = root_pgd;
out_unlock:
<yellow>	write_unlock(&vcpu->kvm->mmu_lock);</yellow>

	return r;
}

static int mmu_alloc_special_roots(struct kvm_vcpu *vcpu)
{
	struct kvm_mmu *mmu = vcpu-&gt;arch.mmu;
	bool need_pml5 = mmu-&gt;root_role.level &gt; PT64_ROOT_4LEVEL;
	u64 *pml5_root = NULL;
	u64 *pml4_root = NULL;
	u64 *pae_root;

	/*
	 * When shadowing 32-bit or PAE NPT with 64-bit NPT, the PML4 and PDP
	 * tables are allocated and initialized at root creation as there is no
	 * equivalent level in the guest&#x27;s NPT to shadow.  Allocate the tables
	 * on demand, as running a 32-bit L1 VMM on 64-bit KVM is very rare.
	 */
	if (mmu-&gt;root_role.direct ||
<blue>	    mmu->cpu_role.base.level >= PT64_ROOT_4LEVEL ||</blue>
	    mmu-&gt;root_role.level &lt; PT64_ROOT_4LEVEL)
		return 0;

	/*
	 * NPT, the only paging mode that uses this horror, uses a fixed number
	 * of levels for the shadow page tables, e.g. all MMUs are 4-level or
	 * all MMus are 5-level.  Thus, this can safely require that pml5_root
	 * is allocated if the other roots are valid and pml5 is needed, as any
	 * prior MMU would also have required pml5.
	 */
<yellow>	if (mmu->pae_root && mmu->pml4_root && (!need_pml5 || mmu->pml5_root))</yellow>
		return 0;

	/*
	 * The special roots should always be allocated in concert.  Yell and
	 * bail if KVM ends up in a state where only one of the roots is valid.
	 */
<yellow>	if (WARN_ON_ONCE(!tdp_enabled || mmu->pae_root || mmu->pml4_root ||</yellow>
			 (need_pml5 &amp;&amp; mmu-&gt;pml5_root)))
		return -EIO;

	/*
	 * Unlike 32-bit NPT, the PDP table doesn&#x27;t need to be in low mem, and
	 * doesn&#x27;t need to be decrypted.
	 */
<yellow>	pae_root = (void *)get_zeroed_page(GFP_KERNEL_ACCOUNT);</yellow>
	if (!pae_root)
		return -ENOMEM;

#ifdef CONFIG_X86_64
<yellow>	pml4_root = (void *)get_zeroed_page(GFP_KERNEL_ACCOUNT);</yellow>
	if (!pml4_root)
		goto err_pml4;

<yellow>	if (need_pml5) {</yellow>
<yellow>		pml5_root = (void *)get_zeroed_page(GFP_KERNEL_ACCOUNT);</yellow>
		if (!pml5_root)
			goto err_pml5;
	}
#endif

<yellow>	mmu->pae_root = pae_root;</yellow>
	mmu-&gt;pml4_root = pml4_root;
	mmu-&gt;pml5_root = pml5_root;

	return 0;

#ifdef CONFIG_X86_64
err_pml5:
<yellow>	free_page((unsigned long)pml4_root);</yellow>
err_pml4:
<yellow>	free_page((unsigned long)pae_root);</yellow>
	return -ENOMEM;
#endif
}

static bool is_unsync_root(hpa_t root)
{
	struct kvm_mmu_page *sp;

	if (!VALID_PAGE(root))
		return false;

	/*
	 * The read barrier orders the CPU&#x27;s read of SPTE.W during the page table
	 * walk before the reads of sp-&gt;unsync/sp-&gt;unsync_children here.
	 *
	 * Even if another CPU was marking the SP as unsync-ed simultaneously,
	 * any guest page table changes are not guaranteed to be visible anyway
	 * until this VCPU issues a TLB flush strictly after those changes are
	 * made.  We only need to ensure that the other CPU sets these flags
	 * before any actual changes to the page tables are made.  The comments
	 * in mmu_try_to_unsync_pages() describe what could go wrong if this
	 * requirement isn&#x27;t satisfied.
	 */
	smp_rmb();
<blue>	sp = to_shadow_page(root);</blue>

	/*
	 * PAE roots (somewhat arbitrarily) aren&#x27;t backed by shadow pages, the
	 * PDPTEs for a given PAE root need to be synchronized individually.
	 */
<yellow>	if (WARN_ON_ONCE(!sp))</yellow>
		return false;

<blue>	if (sp->unsync || sp->unsync_children)</blue>
		return true;

	return false;
}

void kvm_mmu_sync_roots(struct kvm_vcpu *vcpu)
{
	int i;
	struct kvm_mmu_page *sp;

<blue>	if (vcpu->arch.mmu->root_role.direct)</blue>
		return;

<blue>	if (!VALID_PAGE(vcpu->arch.mmu->root.hpa))</blue>
		return;

<blue>	vcpu_clear_mmio_info(vcpu, MMIO_GVA_ANY);</blue>

	if (vcpu-&gt;arch.mmu-&gt;cpu_role.base.level &gt;= PT64_ROOT_4LEVEL) {
<blue>		hpa_t root = vcpu->arch.mmu->root.hpa;</blue>
		sp = to_shadow_page(root);

<blue>		if (!is_unsync_root(root))</blue>
			return;

<yellow>		write_lock(&vcpu->kvm->mmu_lock);</yellow>
		mmu_sync_children(vcpu, sp, true);
		write_unlock(&amp;vcpu-&gt;kvm-&gt;mmu_lock);
		return;
	}

<yellow>	write_lock(&vcpu->kvm->mmu_lock);</yellow>

<yellow>	for (i = 0; i < 4; ++i) {</yellow>
<yellow>		hpa_t root = vcpu->arch.mmu->pae_root[i];</yellow>

		if (IS_VALID_PAE_ROOT(root)) {
<yellow>			root &= SPTE_BASE_ADDR_MASK;</yellow>
			sp = to_shadow_page(root);
			mmu_sync_children(vcpu, sp, true);
		}
	}

<yellow>	write_unlock(&vcpu->kvm->mmu_lock);</yellow>
<blue>}</blue>

void kvm_mmu_sync_prev_roots(struct kvm_vcpu *vcpu)
{
	unsigned long roots_to_free = 0;
	int i;

<yellow>	for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++)</yellow>
<yellow>		if (is_unsync_root(vcpu->arch.mmu->prev_roots[i].hpa))</yellow>
<yellow>			roots_to_free |= KVM_MMU_ROOT_PREVIOUS(i);</yellow>

	/* sync prev_roots by simply freeing them */
<yellow>	kvm_mmu_free_roots(vcpu->kvm, vcpu->arch.mmu, roots_to_free);</yellow>
}

static gpa_t nonpaging_gva_to_gpa(struct kvm_vcpu *vcpu, struct kvm_mmu *mmu,
				  gpa_t vaddr, u64 access,
				  struct x86_exception *exception)
{
<yellow>	if (exception)</yellow>
<yellow>		exception->error_code = 0;</yellow>
<yellow>	return kvm_translate_gpa(vcpu, mmu, vaddr, access, exception);</yellow>
<yellow>}</yellow>

static bool mmio_info_in_cache(struct kvm_vcpu *vcpu, u64 addr, bool direct)
{
	/*
	 * A nested guest cannot use the MMIO cache if it is using nested
	 * page tables, because cr2 is a nGPA while the cache stores GPAs.
	 */
<blue>	if (mmu_is_nested(vcpu))</blue>
		return false;

	if (direct)
<blue>		return vcpu_match_mmio_gpa(vcpu, addr);</blue>

<yellow>	return vcpu_match_mmio_gva(vcpu, addr);</yellow>
<blue>}</blue>

/*
 * Return the level of the lowest level SPTE added to sptes.
 * That SPTE may be non-present.
 *
 * Must be called between walk_shadow_page_lockless_{begin,end}.
 */
static int get_walk(struct kvm_vcpu *vcpu, u64 addr, u64 *sptes, int *root_level)
{
	struct kvm_shadow_walk_iterator iterator;
	int leaf = -1;
	u64 spte;

<blue>	for (shadow_walk_init(&iterator, vcpu, addr),</blue>
	     *root_level = iterator.level;
<blue>	     shadow_walk_okay(&iterator);</blue>
<blue>	     __shadow_walk_next(&iterator, spte)) {</blue>
		leaf = iterator.level;
<blue>		spte = mmu_spte_get_lockless(iterator.sptep);</blue>

		sptes[leaf] = spte;
	}

	return leaf;
}

/* return true if reserved bit(s) are detected on a valid, non-MMIO SPTE. */
static bool get_mmio_spte(struct kvm_vcpu *vcpu, u64 addr, u64 *sptep)
{
	u64 sptes[PT64_ROOT_MAX_LEVEL + 1];
	struct rsvd_bits_validate *rsvd_check;
	int root, leaf, level;
	bool reserved = false;

<blue>	walk_shadow_page_lockless_begin(vcpu);</blue>

<blue>	if (is_tdp_mmu(vcpu->arch.mmu))</blue>
<blue>		leaf = kvm_tdp_mmu_get_walk(vcpu, addr, sptes, &root);</blue>
	else
<blue>		leaf = get_walk(vcpu, addr, sptes, &root);</blue>

<blue>	walk_shadow_page_lockless_end(vcpu);</blue>

<blue>	if (unlikely(leaf < 0)) {</blue>
		*sptep = 0ull;
		return reserved;
	}

<blue>	*sptep = sptes[leaf];</blue>

	/*
	 * Skip reserved bits checks on the terminal leaf if it&#x27;s not a valid
	 * SPTE.  Note, this also (intentionally) skips MMIO SPTEs, which, by
	 * design, always have reserved bits set.  The purpose of the checks is
	 * to detect reserved bits on non-MMIO SPTEs. i.e. buggy SPTEs.
	 */
	if (!is_shadow_present_pte(sptes[leaf]))
<blue>		leaf++;</blue>

<blue>	rsvd_check = &vcpu->arch.mmu->shadow_zero_check;</blue>

<blue>	for (level = root; level >= leaf; level--)</blue>
<blue>		reserved |= is_rsvd_spte(rsvd_check, sptes[level], level);</blue>

<blue>	if (reserved) {</blue>
		pr_err(&quot;%s: reserved bits set on MMU-present spte, addr 0x%llx, hierarchy:\n&quot;,
		       __func__, addr);
		for (level = root; level &gt;= leaf; level--)
			pr_err(&quot;------ spte = 0x%llx level = %d, rsvd bits = 0x%llx&quot;,
			       sptes[level], level,
			       get_rsvd_bits(rsvd_check, sptes[level], level));
	}

	return reserved;
}

static int handle_mmio_page_fault(struct kvm_vcpu *vcpu, u64 addr, bool direct)
{
	u64 spte;
	bool reserved;

<blue>	if (mmio_info_in_cache(vcpu, addr, direct))</blue>
		return RET_PF_EMULATE;

<blue>	reserved = get_mmio_spte(vcpu, addr, &spte);</blue>
	if (WARN_ON(reserved))
		return -EINVAL;

<blue>	if (is_mmio_spte(spte)) {</blue>
<blue>		gfn_t gfn = get_mmio_spte_gfn(spte);</blue>
		unsigned int access = get_mmio_spte_access(spte);

<blue>		if (!check_mmio_spte(vcpu, spte))</blue>
			return RET_PF_INVALID;

<blue>		if (direct)</blue>
			addr = 0;

<yellow>		trace_handle_mmio_page_fault(addr, gfn, access);</yellow>
<blue>		vcpu_cache_mmio_info(vcpu, addr, gfn, access);</blue>
		return RET_PF_EMULATE;
	}

	/*
	 * If the page table is zapped by other cpus, let CPU fault again on
	 * the address.
	 */
	return RET_PF_RETRY;
}

static bool page_fault_handle_page_track(struct kvm_vcpu *vcpu,
					 struct kvm_page_fault *fault)
{
<blue>	if (unlikely(fault->rsvd))</blue>
		return false;

<blue>	if (!fault->present || !fault->write)</blue>
		return false;

	/*
	 * guest is writing the page which is write tracked which can
	 * not be fixed by page fault handler.
	 */
<blue>	if (kvm_slot_page_track_is_active(vcpu->kvm, fault->slot, fault->gfn, KVM_PAGE_TRACK_WRITE))</blue>
		return true;

	return false;
<blue>}</blue>

static void shadow_page_table_clear_flood(struct kvm_vcpu *vcpu, gva_t addr)
<yellow>{</yellow>
	struct kvm_shadow_walk_iterator iterator;
	u64 spte;

<yellow>	walk_shadow_page_lockless_begin(vcpu);</yellow>
<yellow>	for_each_shadow_entry_lockless(vcpu, addr, iterator, spte)</yellow>
<yellow>		clear_sp_write_flooding_count(iterator.sptep);</yellow>
<yellow>	walk_shadow_page_lockless_end(vcpu);</yellow>
}

static u32 alloc_apf_token(struct kvm_vcpu *vcpu)
{
	/* make sure the token value is not 0 */
	u32 id = vcpu-&gt;arch.apf.id;

	if (id &lt;&lt; 12 == 0)
<yellow>		vcpu->arch.apf.id = 1;</yellow>

<yellow>	return (vcpu->arch.apf.id++ << 12) | vcpu->vcpu_id;</yellow>
}

static bool kvm_arch_setup_async_pf(struct kvm_vcpu *vcpu, gpa_t cr2_or_gpa,
				    gfn_t gfn)
{
	struct kvm_arch_async_pf arch;

<yellow>	arch.token = alloc_apf_token(vcpu);</yellow>
	arch.gfn = gfn;
	arch.direct_map = vcpu-&gt;arch.mmu-&gt;root_role.direct;
	arch.cr3 = vcpu-&gt;arch.mmu-&gt;get_guest_pgd(vcpu);

	return kvm_setup_async_pf(vcpu, cr2_or_gpa,
				  kvm_vcpu_gfn_to_hva(vcpu, gfn), &amp;arch);
}

void kvm_arch_async_page_ready(struct kvm_vcpu *vcpu, struct kvm_async_pf *work)
<yellow>{</yellow>
	int r;

<yellow>	if ((vcpu->arch.mmu->root_role.direct != work->arch.direct_map) ||</yellow>
<yellow>	      work->wakeup_all)</yellow>
		return;

<yellow>	r = kvm_mmu_reload(vcpu);</yellow>
	if (unlikely(r))
		return;

<yellow>	if (!vcpu->arch.mmu->root_role.direct &&</yellow>
<yellow>	      work->arch.cr3 != vcpu->arch.mmu->get_guest_pgd(vcpu))</yellow>
		return;

<yellow>	kvm_mmu_do_page_fault(vcpu, work->cr2_or_gpa, 0, true);</yellow>
}

static int kvm_faultin_pfn(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault)
<blue>{</blue>
<blue>	struct kvm_memory_slot *slot = fault->slot;</blue>
	bool async;

	/*
	 * Retry the page fault if the gfn hit a memslot that is being deleted
	 * or moved.  This ensures any existing SPTEs for the old memslot will
	 * be zapped before KVM inserts a new MMIO SPTE for the gfn.
	 */
<blue>	if (slot && (slot->flags & KVM_MEMSLOT_INVALID))</blue>
		return RET_PF_RETRY;

<blue>	if (!kvm_is_visible_memslot(slot)) {</blue>
		/* Don&#x27;t expose private memslots to L2. */
<blue>		if (is_guest_mode(vcpu)) {</blue>
			fault-&gt;slot = NULL;
<blue>			fault->pfn = KVM_PFN_NOSLOT;</blue>
			fault-&gt;map_writable = false;
			return RET_PF_CONTINUE;
		}
		/*
		 * If the APIC access page exists but is disabled, go directly
		 * to emulation without caching the MMIO access or creating a
		 * MMIO SPTE.  That way the cache doesn&#x27;t need to be purged
		 * when the AVIC is re-enabled.
		 */
<blue>		if (slot && slot->id == APIC_ACCESS_PAGE_PRIVATE_MEMSLOT &&</blue>
<blue>		    !kvm_apicv_activated(vcpu->kvm))</blue>
			return RET_PF_EMULATE;
	}

	async = false;
<blue>	fault->pfn = __gfn_to_pfn_memslot(slot, fault->gfn, false, &async,</blue>
<blue>					  fault->write, &fault->map_writable,</blue>
					  &amp;fault-&gt;hva);
<blue>	if (!async)</blue>
		return RET_PF_CONTINUE; /* *pfn has correct page already */

<yellow>	if (!fault->prefetch && kvm_can_do_async_pf(vcpu)) {</yellow>
<yellow>		trace_kvm_try_async_get_page(fault->addr, fault->gfn);</yellow>
<yellow>		if (kvm_find_async_pf_gfn(vcpu, fault->gfn)) {</yellow>
<yellow>			trace_kvm_async_pf_repeated_fault(fault->addr, fault->gfn);</yellow>
<yellow>			kvm_make_request(KVM_REQ_APF_HALT, vcpu);</yellow>
			return RET_PF_RETRY;
<yellow>		} else if (kvm_arch_setup_async_pf(vcpu, fault->addr, fault->gfn)) {</yellow>
			return RET_PF_RETRY;
		}
	}

<yellow>	fault->pfn = __gfn_to_pfn_memslot(slot, fault->gfn, false, NULL,</yellow>
<yellow>					  fault->write, &fault->map_writable,</yellow>
					  &amp;fault-&gt;hva);
	return RET_PF_CONTINUE;
}

/*
 * Returns true if the page fault is stale and needs to be retried, i.e. if the
 * root was invalidated by a memslot update or a relevant mmu_notifier fired.
 */
static bool is_page_fault_stale(struct kvm_vcpu *vcpu,
				struct kvm_page_fault *fault, int mmu_seq)
{
<blue>	struct kvm_mmu_page *sp = to_shadow_page(vcpu->arch.mmu->root.hpa);</blue>

	/* Special roots, e.g. pae_root, are not backed by shadow pages. */
<blue>	if (sp && is_obsolete_sp(vcpu->kvm, sp))</blue>
		return true;

	/*
	 * Roots without an associated shadow page are considered invalid if
	 * there is a pending request to free obsolete roots.  The request is
	 * only a hint that the current root _may_ be obsolete and needs to be
	 * reloaded, e.g. if the guest frees a PGD that KVM is tracking as a
	 * previous root, then __kvm_mmu_prepare_zap_page() signals all vCPUs
	 * to reload even if no vCPU is actively using the root.
	 */
<yellow>	if (!sp && kvm_test_request(KVM_REQ_MMU_FREE_OBSOLETE_ROOTS, vcpu))</yellow>
		return true;

<blue>	return fault->slot &&</blue>
<blue>	       mmu_invalidate_retry_hva(vcpu->kvm, mmu_seq, fault->hva);</blue>
<blue>}</blue>

static int direct_page_fault(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault)
<blue>{</blue>
<blue>	bool is_tdp_mmu_fault = is_tdp_mmu(vcpu->arch.mmu);</blue>

	unsigned long mmu_seq;
	int r;

<blue>	fault->gfn = fault->addr >> PAGE_SHIFT;</blue>
	fault-&gt;slot = kvm_vcpu_gfn_to_memslot(vcpu, fault-&gt;gfn);

	if (page_fault_handle_page_track(vcpu, fault))
		return RET_PF_EMULATE;

<blue>	r = fast_page_fault(vcpu, fault);</blue>
	if (r != RET_PF_INVALID)
		return r;

<blue>	r = mmu_topup_memory_caches(vcpu, false);</blue>
	if (r)
		return r;

<blue>	mmu_seq = vcpu->kvm->mmu_invalidate_seq;</blue>
	smp_rmb();

	r = kvm_faultin_pfn(vcpu, fault);
	if (r != RET_PF_CONTINUE)
		return r;

<blue>	r = handle_abnormal_pfn(vcpu, fault, ACC_ALL);</blue>
	if (r != RET_PF_CONTINUE)
		return r;

	r = RET_PF_RETRY;

	if (is_tdp_mmu_fault)
<blue>		read_lock(&vcpu->kvm->mmu_lock);</blue>
	else
<yellow>		write_lock(&vcpu->kvm->mmu_lock);</yellow>

	if (is_page_fault_stale(vcpu, fault, mmu_seq))
		goto out_unlock;

	if (is_tdp_mmu_fault) {
<blue>		r = kvm_tdp_mmu_map(vcpu, fault);</blue>
	} else {
<yellow>		r = make_mmu_pages_available(vcpu);</yellow>
		if (r)
			goto out_unlock;
<yellow>		r = __direct_map(vcpu, fault);</yellow>
	}

out_unlock:
	if (is_tdp_mmu_fault)
<blue>		read_unlock(&vcpu->kvm->mmu_lock);</blue>
	else
<yellow>		write_unlock(&vcpu->kvm->mmu_lock);</yellow>
<blue>	kvm_release_pfn_clean(fault->pfn);</blue>
	return r;
}

static int nonpaging_page_fault(struct kvm_vcpu *vcpu,
				struct kvm_page_fault *fault)
{
	pgprintk(&quot;%s: gva %lx error %x\n&quot;, __func__, fault-&gt;addr, fault-&gt;error_code);

	/* This path builds a PAE pagetable, we can map 2mb pages at maximum. */
<yellow>	fault->max_level = PG_LEVEL_2M;</yellow>
	return direct_page_fault(vcpu, fault);
}

int kvm_handle_page_fault(struct kvm_vcpu *vcpu, u64 error_code,
				u64 fault_address, char *insn, int insn_len)
{
	int r = 1;
<yellow>	u32 flags = vcpu->arch.apf.host_apf_flags;</yellow>

#ifndef CONFIG_X86_64
	/* A 64-bit CR2 should be impossible on 32-bit KVM. */
	if (WARN_ON_ONCE(fault_address &gt;&gt; 32))
		return -EFAULT;
#endif

	vcpu-&gt;arch.l1tf_flush_l1d = true;
	if (!flags) {
<yellow>		trace_kvm_page_fault(vcpu, fault_address, error_code);</yellow>

<yellow>		if (kvm_event_needs_reinjection(vcpu))</yellow>
<yellow>			kvm_mmu_unprotect_page_virt(vcpu, fault_address);</yellow>
<yellow>		r = kvm_mmu_page_fault(vcpu, fault_address, error_code, insn,</yellow>
				insn_len);
<yellow>	} else if (flags & KVM_PV_REASON_PAGE_NOT_PRESENT) {</yellow>
<yellow>		vcpu->arch.apf.host_apf_flags = 0;</yellow>
		local_irq_disable();
		kvm_async_pf_task_wait_schedule(fault_address);
		local_irq_enable();
	} else {
<yellow>		WARN_ONCE(1, "Unexpected host async PF flags: %x\n", flags);</yellow>
	}

	return r;
<yellow>}</yellow>
EXPORT_SYMBOL_GPL(kvm_handle_page_fault);

int kvm_tdp_page_fault(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault)
{
	/*
	 * If the guest&#x27;s MTRRs may be used to compute the &quot;real&quot; memtype,
	 * restrict the mapping level to ensure KVM uses a consistent memtype
	 * across the entire mapping.  If the host MTRRs are ignored by TDP
	 * (shadow_memtype_mask is non-zero), and the VM has non-coherent DMA
	 * (DMA doesn&#x27;t snoop CPU caches), KVM&#x27;s ABI is to honor the memtype
	 * from the guest&#x27;s MTRRs so that guest accesses to memory that is
	 * DMA&#x27;d aren&#x27;t cached against the guest&#x27;s wishes.
	 *
	 * Note, KVM may still ultimately ignore guest MTRRs for certain PFNs,
	 * e.g. KVM will force UC memtype for host MMIO.
	 */
<blue>	if (shadow_memtype_mask && kvm_arch_has_noncoherent_dma(vcpu->kvm)) {</blue>
<yellow>		for ( ; fault->max_level > PG_LEVEL_4K; --fault->max_level) {</yellow>
<yellow>			int page_num = KVM_PAGES_PER_HPAGE(fault->max_level);</yellow>
			gfn_t base = (fault-&gt;addr &gt;&gt; PAGE_SHIFT) &amp; ~(page_num - 1);

			if (kvm_mtrr_check_gfn_range_consistency(vcpu, base, page_num))
				break;
		}
	}

<blue>	return direct_page_fault(vcpu, fault);</blue>
}

static void nonpaging_init_context(struct kvm_mmu *context)
{
	context-&gt;page_fault = nonpaging_page_fault;
	context-&gt;gva_to_gpa = nonpaging_gva_to_gpa;
	context-&gt;sync_page = nonpaging_sync_page;
	context-&gt;invlpg = NULL;
}

static inline bool is_root_usable(struct kvm_mmu_root_info *root, gpa_t pgd,
				  union kvm_mmu_page_role role)
{
<blue>	return (role.direct || pgd == root->pgd) &&</blue>
<blue>	       VALID_PAGE(root->hpa) &&</blue>
<blue>	       role.word == to_shadow_page(root->hpa)->role.word;</blue>
}

/*
 * Find out if a previously cached root matching the new pgd/role is available,
 * and insert the current root as the MRU in the cache.
 * If a matching root is found, it is assigned to kvm_mmu-&gt;root and
 * true is returned.
 * If no match is found, kvm_mmu-&gt;root is left invalid, the LRU root is
 * evicted to make room for the current root, and false is returned.
 */
static bool cached_root_find_and_keep_current(struct kvm *kvm, struct kvm_mmu *mmu,
					      gpa_t new_pgd,
					      union kvm_mmu_page_role new_role)
{
	uint i;

<blue>	if (is_root_usable(&mmu->root, new_pgd, new_role))</blue>
		return true;

<blue>	for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++) {</blue>
		/*
		 * The swaps end up rotating the cache like this:
		 *   C   0 1 2 3   (on entry to the function)
		 *   0   C 1 2 3
		 *   1   C 0 2 3
		 *   2   C 0 1 3
		 *   3   C 0 1 2   (on exit from the loop)
		 */
<blue>		swap(mmu->root, mmu->prev_roots[i]);</blue>
<blue>		if (is_root_usable(&mmu->root, new_pgd, new_role))</blue>
			return true;
	}

<blue>	kvm_mmu_free_roots(kvm, mmu, KVM_MMU_ROOT_CURRENT);</blue>
	return false;
}

/*
 * Find out if a previously cached root matching the new pgd/role is available.
 * On entry, mmu-&gt;root is invalid.
 * If a matching root is found, it is assigned to kvm_mmu-&gt;root, the LRU entry
 * of the cache becomes invalid, and true is returned.
 * If no match is found, kvm_mmu-&gt;root is left invalid and false is returned.
 */
static bool cached_root_find_without_current(struct kvm *kvm, struct kvm_mmu *mmu,
					     gpa_t new_pgd,
					     union kvm_mmu_page_role new_role)
{
	uint i;

<blue>	for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++)</blue>
<blue>		if (is_root_usable(&mmu->prev_roots[i], new_pgd, new_role))</blue>
			goto hit;

	return false;

hit:
<blue>	swap(mmu->root, mmu->prev_roots[i]);</blue>
	/* Bubble up the remaining roots.  */
	for (; i &lt; KVM_MMU_NUM_PREV_ROOTS - 1; i++)
<blue>		mmu->prev_roots[i] = mmu->prev_roots[i + 1];</blue>
<blue>	mmu->prev_roots[i].hpa = INVALID_PAGE;</blue>
	return true;
}

static bool fast_pgd_switch(struct kvm *kvm, struct kvm_mmu *mmu,
			    gpa_t new_pgd, union kvm_mmu_page_role new_role)
{
	/*
	 * For now, limit the caching to 64-bit hosts+VMs in order to avoid
	 * having to deal with PDPTEs. We may add support for 32-bit hosts/VMs
	 * later if necessary.
	 */
<blue>	if (VALID_PAGE(mmu->root.hpa) && !to_shadow_page(mmu->root.hpa))</blue>
<yellow>		kvm_mmu_free_roots(kvm, mmu, KVM_MMU_ROOT_CURRENT);</yellow>

	if (VALID_PAGE(mmu-&gt;root.hpa))
<blue>		return cached_root_find_and_keep_current(kvm, mmu, new_pgd, new_role);</blue>
	else
<blue>		return cached_root_find_without_current(kvm, mmu, new_pgd, new_role);</blue>
}

void kvm_mmu_new_pgd(struct kvm_vcpu *vcpu, gpa_t new_pgd)
{
<blue>	struct kvm_mmu *mmu = vcpu->arch.mmu;</blue>
	union kvm_mmu_page_role new_role = mmu-&gt;root_role;

<blue>	if (!fast_pgd_switch(vcpu->kvm, mmu, new_pgd, new_role)) {</blue>
		/* kvm_mmu_ensure_valid_pgd will set up a new root.  */
		return;
	}

	/*
	 * It&#x27;s possible that the cached previous root page is obsolete because
	 * of a change in the MMU generation number. However, changing the
	 * generation number is accompanied by KVM_REQ_MMU_FREE_OBSOLETE_ROOTS,
	 * which will free the root set here and allocate a new one.
	 */
<blue>	kvm_make_request(KVM_REQ_LOAD_MMU_PGD, vcpu);</blue>

<blue>	if (force_flush_and_sync_on_reuse) {</blue>
<yellow>		kvm_make_request(KVM_REQ_MMU_SYNC, vcpu);</yellow>
		kvm_make_request(KVM_REQ_TLB_FLUSH_CURRENT, vcpu);
	}

	/*
	 * The last MMIO access&#x27;s GVA and GPA are cached in the VCPU. When
	 * switching to a new CR3, that GVA-&gt;GPA mapping may no longer be
	 * valid. So clear any cached MMIO info even when we don&#x27;t need to sync
	 * the shadow page tables.
	 */
<blue>	vcpu_clear_mmio_info(vcpu, MMIO_GVA_ANY);</blue>

	/*
	 * If this is a direct root page, it doesn&#x27;t have a write flooding
	 * count. Otherwise, clear the write flooding count.
	 */
	if (!new_role.direct)
		__clear_sp_write_flooding_count(
<blue>				to_shadow_page(vcpu->arch.mmu->root.hpa));</blue>
<blue>}</blue>
EXPORT_SYMBOL_GPL(kvm_mmu_new_pgd);

static unsigned long get_cr3(struct kvm_vcpu *vcpu)
{
<blue>	return kvm_read_cr3(vcpu);</blue>
}

<yellow>static bool sync_mmio_spte(struct kvm_vcpu *vcpu, u64 *sptep, gfn_t gfn,</yellow>
			   unsigned int access)
{
<yellow>	if (unlikely(is_mmio_spte(*sptep))) {</yellow>
<yellow>		if (gfn != get_mmio_spte_gfn(*sptep)) {</yellow>
<yellow>			mmu_spte_clear_no_track(sptep);</yellow>
			return true;
		}

<yellow>		mark_mmio_spte(vcpu, sptep, gfn, access);</yellow>
		return true;
	}

	return false;
<yellow>}</yellow>

#define PTTYPE_EPT 18 /* arbitrary */
#define PTTYPE PTTYPE_EPT
#include &quot;paging_tmpl.h&quot;
#undef PTTYPE

#define PTTYPE 64
#include &quot;paging_tmpl.h&quot;
#undef PTTYPE

#define PTTYPE 32
#include &quot;paging_tmpl.h&quot;
#undef PTTYPE

static void
__reset_rsvds_bits_mask(struct rsvd_bits_validate *rsvd_check,
			u64 pa_bits_rsvd, int level, bool nx, bool gbpages,
			bool pse, bool amd)
{
	u64 gbpages_bit_rsvd = 0;
	u64 nonleaf_bit8_rsvd = 0;
	u64 high_bits_rsvd;

<blue>	rsvd_check->bad_mt_xwr = 0;</blue>

	if (!gbpages)
		gbpages_bit_rsvd = rsvd_bits(7, 7);

	if (level == PT32E_ROOT_LEVEL)
		high_bits_rsvd = pa_bits_rsvd &amp; rsvd_bits(0, 62);
	else
		high_bits_rsvd = pa_bits_rsvd &amp; rsvd_bits(0, 51);

	/* Note, NX doesn&#x27;t exist in PDPTEs, this is handled below. */
<blue>	if (!nx)</blue>
<blue>		high_bits_rsvd |= rsvd_bits(63, 63);</blue>

	/*
	 * Non-leaf PML4Es and PDPEs reserve bit 8 (which would be the G bit for
	 * leaf entries) on AMD CPUs only.
	 */
<blue>	if (amd)</blue>
		nonleaf_bit8_rsvd = rsvd_bits(8, 8);

	switch (level) {
	case PT32_ROOT_LEVEL:
		/* no rsvd bits for 2 level 4K page table entries */
<yellow>		rsvd_check->rsvd_bits_mask[0][1] = 0;</yellow>
		rsvd_check-&gt;rsvd_bits_mask[0][0] = 0;
		rsvd_check-&gt;rsvd_bits_mask[1][0] =
			rsvd_check-&gt;rsvd_bits_mask[0][0];

		if (!pse) {
<yellow>			rsvd_check->rsvd_bits_mask[1][1] = 0;</yellow>
			break;
		}

		if (is_cpuid_PSE36())
			/* 36bits PSE 4MB page */
<yellow>			rsvd_check->rsvd_bits_mask[1][1] = rsvd_bits(17, 21);</yellow>
		else
			/* 32 bits PSE 4MB page */
			rsvd_check-&gt;rsvd_bits_mask[1][1] = rsvd_bits(13, 21);
		break;
	case PT32E_ROOT_LEVEL:
<blue>		rsvd_check->rsvd_bits_mask[0][2] = rsvd_bits(63, 63) |</blue>
						   high_bits_rsvd |
						   rsvd_bits(5, 8) |
						   rsvd_bits(1, 2);	/* PDPTE */
		rsvd_check-&gt;rsvd_bits_mask[0][1] = high_bits_rsvd;	/* PDE */
		rsvd_check-&gt;rsvd_bits_mask[0][0] = high_bits_rsvd;	/* PTE */
		rsvd_check-&gt;rsvd_bits_mask[1][1] = high_bits_rsvd |
						   rsvd_bits(13, 20);	/* large page */
		rsvd_check-&gt;rsvd_bits_mask[1][0] =
			rsvd_check-&gt;rsvd_bits_mask[0][0];
		break;
	case PT64_ROOT_5LEVEL:
<blue>		rsvd_check->rsvd_bits_mask[0][4] = high_bits_rsvd |</blue>
						   nonleaf_bit8_rsvd |
						   rsvd_bits(7, 7);
		rsvd_check-&gt;rsvd_bits_mask[1][4] =
			rsvd_check-&gt;rsvd_bits_mask[0][4];
		fallthrough;
	case PT64_ROOT_4LEVEL:
<blue>		rsvd_check->rsvd_bits_mask[0][3] = high_bits_rsvd |</blue>
						   nonleaf_bit8_rsvd |
						   rsvd_bits(7, 7);
		rsvd_check-&gt;rsvd_bits_mask[0][2] = high_bits_rsvd |
						   gbpages_bit_rsvd;
		rsvd_check-&gt;rsvd_bits_mask[0][1] = high_bits_rsvd;
		rsvd_check-&gt;rsvd_bits_mask[0][0] = high_bits_rsvd;
		rsvd_check-&gt;rsvd_bits_mask[1][3] =
			rsvd_check-&gt;rsvd_bits_mask[0][3];
		rsvd_check-&gt;rsvd_bits_mask[1][2] = high_bits_rsvd |
						   gbpages_bit_rsvd |
						   rsvd_bits(13, 29);
		rsvd_check-&gt;rsvd_bits_mask[1][1] = high_bits_rsvd |
						   rsvd_bits(13, 20); /* large page */
		rsvd_check-&gt;rsvd_bits_mask[1][0] =
			rsvd_check-&gt;rsvd_bits_mask[0][0];
		break;
	}
<blue>}</blue>

<yellow>static bool guest_can_use_gbpages(struct kvm_vcpu *vcpu)</yellow>
{
	/*
	 * If TDP is enabled, let the guest use GBPAGES if they&#x27;re supported in
	 * hardware.  The hardware page walker doesn&#x27;t let KVM disable GBPAGES,
	 * i.e. won&#x27;t treat them as reserved, and KVM doesn&#x27;t redo the GVA-&gt;GPA
	 * walk for performance and complexity reasons.  Not to mention KVM
	 * _can&#x27;t_ solve the problem because GVA-&gt;GPA walks aren&#x27;t visible to
	 * KVM once a TDP translation is installed.  Mimic hardware behavior so
	 * that KVM&#x27;s is at least consistent, i.e. doesn&#x27;t randomly inject #PF.
	 */
<blue>	return tdp_enabled ? boot_cpu_has(X86_FEATURE_GBPAGES) :</blue>
<yellow>			     guest_cpuid_has(vcpu, X86_FEATURE_GBPAGES);</yellow>
<blue>}</blue>

static void reset_guest_rsvds_bits_mask(struct kvm_vcpu *vcpu,
					struct kvm_mmu *context)
{
	__reset_rsvds_bits_mask(&amp;context-&gt;guest_rsvd_check,
				vcpu-&gt;arch.reserved_gpa_bits,
				context-&gt;cpu_role.base.level, is_efer_nx(context),
				guest_can_use_gbpages(vcpu),
<blue>				is_cr4_pse(context),</blue>
<blue>				guest_cpuid_is_amd_or_hygon(vcpu));</blue>
}

static void
__reset_rsvds_bits_mask_ept(struct rsvd_bits_validate *rsvd_check,
			    u64 pa_bits_rsvd, bool execonly, int huge_page_level)
{
	u64 high_bits_rsvd = pa_bits_rsvd &amp; rsvd_bits(0, 51);
	u64 large_1g_rsvd = 0, large_2m_rsvd = 0;
	u64 bad_mt_xwr;

<blue>	if (huge_page_level < PG_LEVEL_1G)</blue>
		large_1g_rsvd = rsvd_bits(7, 7);
<yellow>	if (huge_page_level < PG_LEVEL_2M)</yellow>
		large_2m_rsvd = rsvd_bits(7, 7);

<blue>	rsvd_check->rsvd_bits_mask[0][4] = high_bits_rsvd | rsvd_bits(3, 7);</blue>
	rsvd_check-&gt;rsvd_bits_mask[0][3] = high_bits_rsvd | rsvd_bits(3, 7);
	rsvd_check-&gt;rsvd_bits_mask[0][2] = high_bits_rsvd | rsvd_bits(3, 6) | large_1g_rsvd;
	rsvd_check-&gt;rsvd_bits_mask[0][1] = high_bits_rsvd | rsvd_bits(3, 6) | large_2m_rsvd;
	rsvd_check-&gt;rsvd_bits_mask[0][0] = high_bits_rsvd;

	/* large page */
	rsvd_check-&gt;rsvd_bits_mask[1][4] = rsvd_check-&gt;rsvd_bits_mask[0][4];
	rsvd_check-&gt;rsvd_bits_mask[1][3] = rsvd_check-&gt;rsvd_bits_mask[0][3];
	rsvd_check-&gt;rsvd_bits_mask[1][2] = high_bits_rsvd | rsvd_bits(12, 29) | large_1g_rsvd;
	rsvd_check-&gt;rsvd_bits_mask[1][1] = high_bits_rsvd | rsvd_bits(12, 20) | large_2m_rsvd;
	rsvd_check-&gt;rsvd_bits_mask[1][0] = rsvd_check-&gt;rsvd_bits_mask[0][0];

	bad_mt_xwr = 0xFFull &lt;&lt; (2 * 8);	/* bits 3..5 must not be 2 */
	bad_mt_xwr |= 0xFFull &lt;&lt; (3 * 8);	/* bits 3..5 must not be 3 */
	bad_mt_xwr |= 0xFFull &lt;&lt; (7 * 8);	/* bits 3..5 must not be 7 */
	bad_mt_xwr |= REPEAT_BYTE(1ull &lt;&lt; 2);	/* bits 0..2 must not be 010 */
	bad_mt_xwr |= REPEAT_BYTE(1ull &lt;&lt; 6);	/* bits 0..2 must not be 110 */
	if (!execonly) {
		/* bits 0..2 must not be 100 unless VMX capabilities allow it */
		bad_mt_xwr |= REPEAT_BYTE(1ull &lt;&lt; 4);
	}
<blue>	rsvd_check->bad_mt_xwr = bad_mt_xwr;</blue>
}

static void reset_rsvds_bits_mask_ept(struct kvm_vcpu *vcpu,
		struct kvm_mmu *context, bool execonly, int huge_page_level)
{
	__reset_rsvds_bits_mask_ept(&amp;context-&gt;guest_rsvd_check,
				    vcpu-&gt;arch.reserved_gpa_bits, execonly,
				    huge_page_level);
}

static inline u64 reserved_hpa_bits(void)
{
<blue>	return rsvd_bits(shadow_phys_bits, 63);</blue>
}

/*
 * the page table on host is the shadow page table for the page
 * table in guest or amd nested guest, its mmu features completely
 * follow the features in guest.
 */
static void reset_shadow_zero_bits_mask(struct kvm_vcpu *vcpu,
					struct kvm_mmu *context)
{
	/* @amd adds a check on bit of SPTEs, which KVM shouldn&#x27;t use anyways. */
	bool is_amd = true;
	/* KVM doesn&#x27;t use 2-level page tables for the shadow MMU. */
	bool is_pse = false;
	struct rsvd_bits_validate *shadow_zero_check;
	int i;

<yellow>	WARN_ON_ONCE(context->root_role.level < PT32E_ROOT_LEVEL);</yellow>

<yellow>	shadow_zero_check = &context->shadow_zero_check;</yellow>
<yellow>	__reset_rsvds_bits_mask(shadow_zero_check, reserved_hpa_bits(),</yellow>
				context-&gt;root_role.level,
				context-&gt;root_role.efer_nx,
				guest_can_use_gbpages(vcpu), is_pse, is_amd);

	if (!shadow_me_mask)
		return;

<yellow>	for (i = context->root_role.level; --i >= 0;) {</yellow>
		/*
		 * So far shadow_me_value is a constant during KVM&#x27;s life
		 * time.  Bits in shadow_me_value are allowed to be set.
		 * Bits in shadow_me_mask but not in shadow_me_value are
		 * not allowed to be set.
		 */
<yellow>		shadow_zero_check->rsvd_bits_mask[0][i] |= shadow_me_mask;</yellow>
		shadow_zero_check-&gt;rsvd_bits_mask[1][i] |= shadow_me_mask;
<yellow>		shadow_zero_check->rsvd_bits_mask[0][i] &= ~shadow_me_value;</yellow>
		shadow_zero_check-&gt;rsvd_bits_mask[1][i] &amp;= ~shadow_me_value;
	}

}

static inline bool boot_cpu_is_amd(void)
{
<yellow>	WARN_ON_ONCE(!tdp_enabled);</yellow>
	return shadow_x_mask == 0;
}

/*
 * the direct page table on host, use as much mmu features as
 * possible, however, kvm currently does not do execution-protection.
 */
static void
reset_tdp_shadow_zero_bits_mask(struct kvm_mmu *context)
{
	struct rsvd_bits_validate *shadow_zero_check;
	int i;

	shadow_zero_check = &amp;context-&gt;shadow_zero_check;

<blue>	if (boot_cpu_is_amd())</blue>
<yellow>		__reset_rsvds_bits_mask(shadow_zero_check, reserved_hpa_bits(),</yellow>
					context-&gt;root_role.level, true,
<yellow>					boot_cpu_has(X86_FEATURE_GBPAGES),</yellow>
					false, true);
	else
<blue>		__reset_rsvds_bits_mask_ept(shadow_zero_check,</blue>
					    reserved_hpa_bits(), false,
					    max_huge_page_level);

<blue>	if (!shadow_me_mask)</blue>
		return;

<yellow>	for (i = context->root_role.level; --i >= 0;) {</yellow>
<yellow>		shadow_zero_check->rsvd_bits_mask[0][i] &= ~shadow_me_mask;</yellow>
		shadow_zero_check-&gt;rsvd_bits_mask[1][i] &amp;= ~shadow_me_mask;
	}
}

/*
 * as the comments in reset_shadow_zero_bits_mask() except it
 * is the shadow page table for intel nested guest.
 */
static void
reset_ept_shadow_zero_bits_mask(struct kvm_mmu *context, bool execonly)
{
<blue>	__reset_rsvds_bits_mask_ept(&context->shadow_zero_check,</blue>
				    reserved_hpa_bits(), execonly,
				    max_huge_page_level);
}

#define BYTE_MASK(access) \
	((1 &amp; (access) ? 2 : 0) | \
	 (2 &amp; (access) ? 4 : 0) | \
	 (3 &amp; (access) ? 8 : 0) | \
	 (4 &amp; (access) ? 16 : 0) | \
	 (5 &amp; (access) ? 32 : 0) | \
	 (6 &amp; (access) ? 64 : 0) | \
	 (7 &amp; (access) ? 128 : 0))


static void update_permission_bitmask(struct kvm_mmu *mmu, bool ept)
{
	unsigned byte;

	const u8 x = BYTE_MASK(ACC_EXEC_MASK);
	const u8 w = BYTE_MASK(ACC_WRITE_MASK);
	const u8 u = BYTE_MASK(ACC_USER_MASK);

<blue>	bool cr4_smep = is_cr4_smep(mmu);</blue>
	bool cr4_smap = is_cr4_smap(mmu);
	bool cr0_wp = is_cr0_wp(mmu);
	bool efer_nx = is_efer_nx(mmu);

	for (byte = 0; byte &lt; ARRAY_SIZE(mmu-&gt;permissions); ++byte) {
		unsigned pfec = byte &lt;&lt; 1;

		/*
		 * Each &quot;*f&quot; variable has a 1 bit for each UWX value
		 * that causes a fault with the given PFEC.
		 */

		/* Faults from writes to non-writable pages */
<blue>		u8 wf = (pfec & PFERR_WRITE_MASK) ? (u8)~w : 0;</blue>
		/* Faults from user mode accesses to supervisor pages */
<blue>		u8 uf = (pfec & PFERR_USER_MASK) ? (u8)~u : 0;</blue>
		/* Faults from fetches of non-executable pages*/
<blue>		u8 ff = (pfec & PFERR_FETCH_MASK) ? (u8)~x : 0;</blue>
		/* Faults from kernel mode fetches of user pages */
		u8 smepf = 0;
		/* Faults from kernel mode accesses of user pages */
<blue>		u8 smapf = 0;</blue>

<blue>		if (!ept) {</blue>
			/* Faults from kernel mode accesses to user pages */
<blue>			u8 kf = (pfec & PFERR_USER_MASK) ? 0 : u;</blue>

			/* Not really needed: !nx will cause pte.nx to fault */
<blue>			if (!efer_nx)</blue>
				ff = 0;

			/* Allow supervisor writes if !cr0.wp */
<blue>			if (!cr0_wp)</blue>
<blue>				wf = (pfec & PFERR_USER_MASK) ? wf : 0;</blue>

			/* Disallow supervisor fetches of user code if cr4.smep */
<blue>			if (cr4_smep)</blue>
<blue>				smepf = (pfec & PFERR_FETCH_MASK) ? kf : 0;</blue>

			/*
			 * SMAP:kernel-mode data accesses from user-mode
			 * mappings should fault. A fault is considered
			 * as a SMAP violation if all of the following
			 * conditions are true:
			 *   - X86_CR4_SMAP is set in CR4
			 *   - A user page is accessed
			 *   - The access is not a fetch
			 *   - The access is supervisor mode
			 *   - If implicit supervisor access or X86_EFLAGS_AC is clear
			 *
			 * Here, we cover the first four conditions.
			 * The fifth is computed dynamically in permission_fault();
			 * PFERR_RSVD_MASK bit will be set in PFEC if the access is
			 * *not* subject to SMAP restrictions.
			 */
<blue>			if (cr4_smap)</blue>
<blue>				smapf = (pfec & (PFERR_RSVD_MASK|PFERR_FETCH_MASK)) ? 0 : kf;</blue>
		}

<blue>		mmu->permissions[byte] = ff | uf | wf | smepf | smapf;</blue>
	}
<blue>}</blue>

/*
* PKU is an additional mechanism by which the paging controls access to
* user-mode addresses based on the value in the PKRU register.  Protection
* key violations are reported through a bit in the page fault error code.
* Unlike other bits of the error code, the PK bit is not known at the
* call site of e.g. gva_to_gpa; it must be computed directly in
* permission_fault based on two bits of PKRU, on some machine state (CR4,
* CR0, EFER, CPL), and on other bits of the error code and the page tables.
*
* In particular the following conditions come from the error code, the
* page tables and the machine state:
* - PK is always zero unless CR4.PKE=1 and EFER.LMA=1
* - PK is always zero if RSVD=1 (reserved bit set) or F=1 (instruction fetch)
* - PK is always zero if U=0 in the page tables
* - PKRU.WD is ignored if CR0.WP=0 and the access is a supervisor access.
*
* The PKRU bitmask caches the result of these four conditions.  The error
* code (minus the P bit) and the page table&#x27;s U bit form an index into the
* PKRU bitmask.  Two bits of the PKRU bitmask are then extracted and ANDed
* with the two bits of the PKRU register corresponding to the protection key.
* For the first three conditions above the bits will be 00, thus masking
* away both AD and WD.  For all reads or if the last condition holds, WD
* only will be masked away.
*/
static void update_pkru_bitmask(struct kvm_mmu *mmu)
{
	unsigned bit;
	bool wp;

	mmu-&gt;pkru_mask = 0;

	if (!is_cr4_pke(mmu))
		return;

<blue>	wp = is_cr0_wp(mmu);</blue>

<blue>	for (bit = 0; bit < ARRAY_SIZE(mmu->permissions); ++bit) {</blue>
		unsigned pfec, pkey_bits;
		bool check_pkey, check_write, ff, uf, wf, pte_user;

<blue>		pfec = bit << 1;</blue>
		ff = pfec &amp; PFERR_FETCH_MASK;
<blue>		uf = pfec & PFERR_USER_MASK;</blue>
<blue>		wf = pfec & PFERR_WRITE_MASK;</blue>

		/* PFEC.RSVD is replaced by ACC_USER_MASK. */
<blue>		pte_user = pfec & PFERR_RSVD_MASK;</blue>

		/*
		 * Only need to check the access which is not an
		 * instruction fetch and is to a user page.
		 */
		check_pkey = (!ff &amp;&amp; pte_user);
		/*
		 * write access is controlled by PKRU if it is a
		 * user access or CR0.WP = 1.
		 */
		check_write = check_pkey &amp;&amp; wf &amp;&amp; (uf || wp);

		/* PKRU.AD stops both read and write access. */
		pkey_bits = !!check_pkey;
		/* PKRU.WD stops write access. */
		pkey_bits |= (!!check_write) &lt;&lt; 1;

<blue>		mmu->pkru_mask |= (pkey_bits & 3) << pfec;</blue>
	}
}

<blue>static void reset_guest_paging_metadata(struct kvm_vcpu *vcpu,</blue>
					struct kvm_mmu *mmu)
{
<blue>	if (!is_cr0_pg(mmu))</blue>
		return;

<blue>	reset_guest_rsvds_bits_mask(vcpu, mmu);</blue>
	update_permission_bitmask(mmu, false);
<blue>	update_pkru_bitmask(mmu);</blue>
<blue>}</blue>

static void paging64_init_context(struct kvm_mmu *context)
{
	context-&gt;page_fault = paging64_page_fault;
	context-&gt;gva_to_gpa = paging64_gva_to_gpa;
	context-&gt;sync_page = paging64_sync_page;
	context-&gt;invlpg = paging64_invlpg;
}

static void paging32_init_context(struct kvm_mmu *context)
{
	context-&gt;page_fault = paging32_page_fault;
	context-&gt;gva_to_gpa = paging32_gva_to_gpa;
	context-&gt;sync_page = paging32_sync_page;
	context-&gt;invlpg = paging32_invlpg;
}

static union kvm_cpu_role
kvm_calc_cpu_role(struct kvm_vcpu *vcpu, const struct kvm_mmu_role_regs *regs)
{
	union kvm_cpu_role role = {0};

	role.base.access = ACC_ALL;
<blue>	role.base.smm = is_smm(vcpu);</blue>
	role.base.guest_mode = is_guest_mode(vcpu);
	role.ext.valid = 1;

	if (!____is_cr0_pg(regs)) {
<blue>		role.base.direct = 1;</blue>
		return role;
	}

<blue>	role.base.efer_nx = ____is_efer_nx(regs);</blue>
	role.base.cr0_wp = ____is_cr0_wp(regs);
<blue>	role.base.smep_andnot_wp = ____is_cr4_smep(regs) && !____is_cr0_wp(regs);</blue>
<blue>	role.base.smap_andnot_wp = ____is_cr4_smap(regs) && !____is_cr0_wp(regs);</blue>
<blue>	role.base.has_4_byte_gpte = !____is_cr4_pae(regs);</blue>

	if (____is_efer_lma(regs))
<blue>		role.base.level = ____is_cr4_la57(regs) ? PT64_ROOT_5LEVEL</blue>
							: PT64_ROOT_4LEVEL;
<blue>	else if (____is_cr4_pae(regs))</blue>
		role.base.level = PT32E_ROOT_LEVEL;
	else
		role.base.level = PT32_ROOT_LEVEL;

<blue>	role.ext.cr4_smep = ____is_cr4_smep(regs);</blue>
	role.ext.cr4_smap = ____is_cr4_smap(regs);
	role.ext.cr4_pse = ____is_cr4_pse(regs);

	/* PKEY and LA57 are active iff long mode is active. */
	role.ext.cr4_pke = ____is_efer_lma(regs) &amp;&amp; ____is_cr4_pke(regs);
	role.ext.cr4_la57 = ____is_efer_lma(regs) &amp;&amp; ____is_cr4_la57(regs);
<blue>	role.ext.efer_lma = ____is_efer_lma(regs);</blue>
	return role;
<blue>}</blue>

<blue>static inline int kvm_mmu_get_tdp_level(struct kvm_vcpu *vcpu)</blue>
{
	/* tdp_root_level is architecture forced level, use it if nonzero */
<blue>	if (tdp_root_level)</blue>
		return tdp_root_level;

	/* Use 5-level TDP if and only if it&#x27;s useful/necessary. */
<blue>	if (max_tdp_level == 5 && cpuid_maxphyaddr(vcpu) <= 48)</blue>
		return 4;

	return max_tdp_level;
}

static union kvm_mmu_page_role
kvm_calc_tdp_mmu_root_page_role(struct kvm_vcpu *vcpu,
				union kvm_cpu_role cpu_role)
{
	union kvm_mmu_page_role role = {0};

	role.access = ACC_ALL;
	role.cr0_wp = true;
	role.efer_nx = true;
<blue>	role.smm = cpu_role.base.smm;</blue>
	role.guest_mode = cpu_role.base.guest_mode;
	role.ad_disabled = !kvm_ad_enabled();
<blue>	role.level = kvm_mmu_get_tdp_level(vcpu);</blue>
	role.direct = true;
	role.has_4_byte_gpte = false;

	return role;
}

static void init_kvm_tdp_mmu(struct kvm_vcpu *vcpu,
			     union kvm_cpu_role cpu_role)
{
	struct kvm_mmu *context = &amp;vcpu-&gt;arch.root_mmu;
<blue>	union kvm_mmu_page_role root_role = kvm_calc_tdp_mmu_root_page_role(vcpu, cpu_role);</blue>

	if (cpu_role.as_u64 == context-&gt;cpu_role.as_u64 &amp;&amp;
<blue>	    root_role.word == context->root_role.word)</blue>
		return;

	context-&gt;cpu_role.as_u64 = cpu_role.as_u64;
<blue>	context->root_role.word = root_role.word;</blue>
	context-&gt;page_fault = kvm_tdp_page_fault;
	context-&gt;sync_page = nonpaging_sync_page;
	context-&gt;invlpg = NULL;
	context-&gt;get_guest_pgd = get_cr3;
	context-&gt;get_pdptr = kvm_pdptr_read;
	context-&gt;inject_page_fault = kvm_inject_page_fault;

<blue>	if (!is_cr0_pg(context))</blue>
		context-&gt;gva_to_gpa = nonpaging_gva_to_gpa;
<blue>	else if (is_cr4_pae(context))</blue>
		context-&gt;gva_to_gpa = paging64_gva_to_gpa;
	else
		context-&gt;gva_to_gpa = paging32_gva_to_gpa;

	reset_guest_paging_metadata(vcpu, context);
<blue>	reset_tdp_shadow_zero_bits_mask(context);</blue>
}

static void shadow_mmu_init_context(struct kvm_vcpu *vcpu, struct kvm_mmu *context,
				    union kvm_cpu_role cpu_role,
				    union kvm_mmu_page_role root_role)
<yellow>{</yellow>
<yellow>	if (cpu_role.as_u64 == context->cpu_role.as_u64 &&</yellow>
<yellow>	    root_role.word == context->root_role.word)</yellow>
		return;

	context-&gt;cpu_role.as_u64 = cpu_role.as_u64;
<yellow>	context->root_role.word = root_role.word;</yellow>

<yellow>	if (!is_cr0_pg(context))</yellow>
		nonpaging_init_context(context);
<yellow>	else if (is_cr4_pae(context))</yellow>
		paging64_init_context(context);
	else
		paging32_init_context(context);

	reset_guest_paging_metadata(vcpu, context);
<yellow>	reset_shadow_zero_bits_mask(vcpu, context);</yellow>
}

static void kvm_init_shadow_mmu(struct kvm_vcpu *vcpu,
				union kvm_cpu_role cpu_role)
{
	struct kvm_mmu *context = &amp;vcpu-&gt;arch.root_mmu;
	union kvm_mmu_page_role root_role;

	root_role = cpu_role.base;

	/* KVM uses PAE paging whenever the guest isn&#x27;t using 64-bit paging. */
	root_role.level = max_t(u32, root_role.level, PT32E_ROOT_LEVEL);

	/*
	 * KVM forces EFER.NX=1 when TDP is disabled, reflect it in the MMU role.
	 * KVM uses NX when TDP is disabled to handle a variety of scenarios,
	 * notably for huge SPTEs if iTLB multi-hit mitigation is enabled and
	 * to generate correct permissions for CR0.WP=0/CR4.SMEP=1/EFER.NX=0.
	 * The iTLB multi-hit workaround can be toggled at any time, so assume
	 * NX can be used by any non-nested shadow MMU to avoid having to reset
	 * MMU contexts.
	 */
	root_role.efer_nx = true;

	shadow_mmu_init_context(vcpu, context, cpu_role, root_role);
}

void kvm_init_shadow_npt_mmu(struct kvm_vcpu *vcpu, unsigned long cr0,
			     unsigned long cr4, u64 efer, gpa_t nested_cr3)
{
	struct kvm_mmu *context = &amp;vcpu-&gt;arch.guest_mmu;
<yellow>	struct kvm_mmu_role_regs regs = {</yellow>
		.cr0 = cr0,
		.cr4 = cr4 &amp; ~X86_CR4_PKE,
		.efer = efer,
	};
	union kvm_cpu_role cpu_role = kvm_calc_cpu_role(vcpu, &amp;regs);
	union kvm_mmu_page_role root_role;

	/* NPT requires CR0.PG=1. */
<yellow>	WARN_ON_ONCE(cpu_role.base.direct);</yellow>

	root_role = cpu_role.base;
<yellow>	root_role.level = kvm_mmu_get_tdp_level(vcpu);</yellow>
<yellow>	if (root_role.level == PT64_ROOT_5LEVEL &&</yellow>
<yellow>	    cpu_role.base.level == PT64_ROOT_4LEVEL)</yellow>
		root_role.passthrough = 1;

<yellow>	shadow_mmu_init_context(vcpu, context, cpu_role, root_role);</yellow>
	kvm_mmu_new_pgd(vcpu, nested_cr3);
}
EXPORT_SYMBOL_GPL(kvm_init_shadow_npt_mmu);

static union kvm_cpu_role
kvm_calc_shadow_ept_root_page_role(struct kvm_vcpu *vcpu, bool accessed_dirty,
				   bool execonly, u8 level)
{
	union kvm_cpu_role role = {0};

	/*
	 * KVM does not support SMM transfer monitors, and consequently does not
	 * support the &quot;entry to SMM&quot; control either.  role.base.smm is always 0.
	 */
<yellow>	WARN_ON_ONCE(is_smm(vcpu));</yellow>
	role.base.level = level;
	role.base.has_4_byte_gpte = false;
	role.base.direct = false;
<blue>	role.base.ad_disabled = !accessed_dirty;</blue>
	role.base.guest_mode = true;
	role.base.access = ACC_ALL;

	role.ext.word = 0;
	role.ext.execonly = execonly;
	role.ext.valid = 1;

	return role;
}

void kvm_init_shadow_ept_mmu(struct kvm_vcpu *vcpu, bool execonly,
			     int huge_page_level, bool accessed_dirty,
			     gpa_t new_eptp)
{
	struct kvm_mmu *context = &amp;vcpu-&gt;arch.guest_mmu;
<blue>	u8 level = vmx_eptp_page_walk_level(new_eptp);</blue>
	union kvm_cpu_role new_mode =
<blue>		kvm_calc_shadow_ept_root_page_role(vcpu, accessed_dirty,</blue>
						   execonly, level);

	if (new_mode.as_u64 != context-&gt;cpu_role.as_u64) {
		/* EPT, and thus nested EPT, does not consume CR0, CR4, nor EFER. */
		context-&gt;cpu_role.as_u64 = new_mode.as_u64;
<blue>		context->root_role.word = new_mode.base.word;</blue>

		context-&gt;page_fault = ept_page_fault;
		context-&gt;gva_to_gpa = ept_gva_to_gpa;
		context-&gt;sync_page = ept_sync_page;
		context-&gt;invlpg = ept_invlpg;

		update_permission_bitmask(context, true);
		context-&gt;pkru_mask = 0;
		reset_rsvds_bits_mask_ept(vcpu, context, execonly, huge_page_level);
<blue>		reset_ept_shadow_zero_bits_mask(context, execonly);</blue>
	}

<blue>	kvm_mmu_new_pgd(vcpu, new_eptp);</blue>
}
EXPORT_SYMBOL_GPL(kvm_init_shadow_ept_mmu);

static void init_kvm_softmmu(struct kvm_vcpu *vcpu,
			     union kvm_cpu_role cpu_role)
{
	struct kvm_mmu *context = &amp;vcpu-&gt;arch.root_mmu;

	kvm_init_shadow_mmu(vcpu, cpu_role);

	context-&gt;get_guest_pgd     = get_cr3;
	context-&gt;get_pdptr         = kvm_pdptr_read;
	context-&gt;inject_page_fault = kvm_inject_page_fault;
}

static void init_kvm_nested_mmu(struct kvm_vcpu *vcpu,
				union kvm_cpu_role new_mode)
{
	struct kvm_mmu *g_context = &amp;vcpu-&gt;arch.nested_mmu;

<blue>	if (new_mode.as_u64 == g_context->cpu_role.as_u64)</blue>
		return;

	g_context-&gt;cpu_role.as_u64   = new_mode.as_u64;
<blue>	g_context->get_guest_pgd     = get_cr3;</blue>
	g_context-&gt;get_pdptr         = kvm_pdptr_read;
	g_context-&gt;inject_page_fault = kvm_inject_page_fault;

	/*
	 * L2 page tables are never shadowed, so there is no need to sync
	 * SPTEs.
	 */
	g_context-&gt;invlpg            = NULL;

	/*
	 * Note that arch.mmu-&gt;gva_to_gpa translates l2_gpa to l1_gpa using
	 * L1&#x27;s nested page tables (e.g. EPT12). The nested translation
	 * of l2_gva to l1_gpa is done by arch.nested_mmu.gva_to_gpa using
	 * L2&#x27;s page tables as the first level of translation and L1&#x27;s
	 * nested page tables as the second level of translation. Basically
	 * the gva_to_gpa functions between mmu and nested_mmu are swapped.
	 */
<blue>	if (!is_paging(vcpu))</blue>
		g_context-&gt;gva_to_gpa = nonpaging_gva_to_gpa;
<blue>	else if (is_long_mode(vcpu))</blue>
		g_context-&gt;gva_to_gpa = paging64_gva_to_gpa;
<blue>	else if (is_pae(vcpu))</blue>
		g_context-&gt;gva_to_gpa = paging64_gva_to_gpa;
	else
		g_context-&gt;gva_to_gpa = paging32_gva_to_gpa;

	reset_guest_paging_metadata(vcpu, g_context);
}

void kvm_init_mmu(struct kvm_vcpu *vcpu)
<blue>{</blue>
<blue>	struct kvm_mmu_role_regs regs = vcpu_to_role_regs(vcpu);</blue>
	union kvm_cpu_role cpu_role = kvm_calc_cpu_role(vcpu, &amp;regs);

	if (mmu_is_nested(vcpu))
<blue>		init_kvm_nested_mmu(vcpu, cpu_role);</blue>
<blue>	else if (tdp_enabled)</blue>
<blue>		init_kvm_tdp_mmu(vcpu, cpu_role);</blue>
	else
<yellow>		init_kvm_softmmu(vcpu, cpu_role);</yellow>
}
EXPORT_SYMBOL_GPL(kvm_init_mmu);

void kvm_mmu_after_set_cpuid(struct kvm_vcpu *vcpu)
{
	/*
	 * Invalidate all MMU roles to force them to reinitialize as CPUID
	 * information is factored into reserved bit calculations.
	 *
	 * Correctly handling multiple vCPU models with respect to paging and
	 * physical address properties) in a single VM would require tracking
	 * all relevant CPUID information in kvm_mmu_page_role. That is very
	 * undesirable as it would increase the memory requirements for
	 * gfn_track (see struct kvm_mmu_page_role comments).  For now that
	 * problem is swept under the rug; KVM&#x27;s CPUID API is horrific and
	 * it&#x27;s all but impossible to solve it without introducing a new API.
	 */
<blue>	vcpu->arch.root_mmu.root_role.word = 0;</blue>
	vcpu-&gt;arch.guest_mmu.root_role.word = 0;
	vcpu-&gt;arch.nested_mmu.root_role.word = 0;
	vcpu-&gt;arch.root_mmu.cpu_role.ext.valid = 0;
	vcpu-&gt;arch.guest_mmu.cpu_role.ext.valid = 0;
	vcpu-&gt;arch.nested_mmu.cpu_role.ext.valid = 0;
<blue>	kvm_mmu_reset_context(vcpu);</blue>

	/*
	 * Changing guest CPUID after KVM_RUN is forbidden, see the comment in
	 * kvm_arch_vcpu_ioctl().
	 */
<yellow>	KVM_BUG_ON(vcpu->arch.last_vmentry_cpu != -1, vcpu->kvm);</yellow>
<blue>}</blue>

void kvm_mmu_reset_context(struct kvm_vcpu *vcpu)
{
<blue>	kvm_mmu_unload(vcpu);</blue>
	kvm_init_mmu(vcpu);
}
EXPORT_SYMBOL_GPL(kvm_mmu_reset_context);

<blue>int kvm_mmu_load(struct kvm_vcpu *vcpu)</blue>
<blue>{</blue>
	int r;

<blue>	r = mmu_topup_memory_caches(vcpu, !vcpu->arch.mmu->root_role.direct);</blue>
	if (r)
		goto out;
<blue>	r = mmu_alloc_special_roots(vcpu);</blue>
	if (r)
		goto out;
<blue>	if (vcpu->arch.mmu->root_role.direct)</blue>
<blue>		r = mmu_alloc_direct_roots(vcpu);</blue>
	else
<blue>		r = mmu_alloc_shadow_roots(vcpu);</blue>
	if (r)
		goto out;

<blue>	kvm_mmu_sync_roots(vcpu);</blue>

<blue>	kvm_mmu_load_pgd(vcpu);</blue>

	/*
	 * Flush any TLB entries for the new root, the provenance of the root
	 * is unknown.  Even if KVM ensures there are no stale TLB entries
	 * for a freed root, in theory another hypervisor could have left
	 * stale entries.  Flushing on alloc also allows KVM to skip the TLB
	 * flush when freeing a root (see kvm_tdp_mmu_put_root()).
	 */
<blue>	static_call(kvm_x86_flush_tlb_current)(vcpu);</blue>
out:
	return r;
}

void kvm_mmu_unload(struct kvm_vcpu *vcpu)
{
<blue>	struct kvm *kvm = vcpu->kvm;</blue>

	kvm_mmu_free_roots(kvm, &amp;vcpu-&gt;arch.root_mmu, KVM_MMU_ROOTS_ALL);
<yellow>	WARN_ON(VALID_PAGE(vcpu->arch.root_mmu.root.hpa));</yellow>
<blue>	kvm_mmu_free_roots(kvm, &vcpu->arch.guest_mmu, KVM_MMU_ROOTS_ALL);</blue>
<yellow>	WARN_ON(VALID_PAGE(vcpu->arch.guest_mmu.root.hpa));</yellow>
<blue>	vcpu_clear_mmio_info(vcpu, MMIO_GVA_ANY);</blue>
}

static bool is_obsolete_root(struct kvm *kvm, hpa_t root_hpa)
{
	struct kvm_mmu_page *sp;

	if (!VALID_PAGE(root_hpa))
		return false;

	/*
	 * When freeing obsolete roots, treat roots as obsolete if they don&#x27;t
	 * have an associated shadow page.  This does mean KVM will get false
	 * positives and free roots that don&#x27;t strictly need to be freed, but
	 * such false positives are relatively rare:
	 *
	 *  (a) only PAE paging and nested NPT has roots without shadow pages
	 *  (b) remote reloads due to a memslot update obsoletes _all_ roots
	 *  (c) KVM doesn&#x27;t track previous roots for PAE paging, and the guest
	 *      is unlikely to zap an in-use PGD.
	 */
<blue>	sp = to_shadow_page(root_hpa);</blue>
<blue>	return !sp || is_obsolete_sp(kvm, sp);</blue>
}

static void __kvm_mmu_free_obsolete_roots(struct kvm *kvm, struct kvm_mmu *mmu)
{
	unsigned long roots_to_free = 0;
	int i;

<blue>	if (is_obsolete_root(kvm, mmu->root.hpa))</blue>
		roots_to_free |= KVM_MMU_ROOT_CURRENT;

<blue>	for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++) {</blue>
<blue>		if (is_obsolete_root(kvm, mmu->prev_roots[i].hpa))</blue>
<blue>			roots_to_free |= KVM_MMU_ROOT_PREVIOUS(i);</blue>
	}

<blue>	if (roots_to_free)</blue>
<blue>		kvm_mmu_free_roots(kvm, mmu, roots_to_free);</blue>
<blue>}</blue>

void kvm_mmu_free_obsolete_roots(struct kvm_vcpu *vcpu)
{
<blue>	__kvm_mmu_free_obsolete_roots(vcpu->kvm, &vcpu->arch.root_mmu);</blue>
	__kvm_mmu_free_obsolete_roots(vcpu-&gt;kvm, &amp;vcpu-&gt;arch.guest_mmu);
}

static u64 mmu_pte_write_fetch_gpte(struct kvm_vcpu *vcpu, gpa_t *gpa,
				    int *bytes)
{
	u64 gentry = 0;
	int r;

	/*
	 * Assume that the pte write on a page table of the same type
	 * as the current vcpu paging mode since we update the sptes only
	 * when they have the same mode.
	 */
<blue>	if (is_pae(vcpu) && *bytes == 4) {</blue>
		/* Handle a 32-bit guest writing two halves of a 64-bit gpte */
<blue>		*gpa &= ~(gpa_t)7;</blue>
		*bytes = 8;
	}

<blue>	if (*bytes == 4 || *bytes == 8) {</blue>
<blue>		r = kvm_vcpu_read_guest_atomic(vcpu, *gpa, &gentry, *bytes);</blue>
		if (r)
<yellow>			gentry = 0;</yellow>
	}

<blue>	return gentry;</blue>
}

/*
 * If we&#x27;re seeing too many writes to a page, it may no longer be a page table,
 * or we may be forking, in which case it is better to unmap the page.
 */
static bool detect_write_flooding(struct kvm_mmu_page *sp)
{
	/*
	 * Skip write-flooding detected for the sp whose level is 1, because
	 * it can become unsync, then the guest page is not write-protected.
	 */
<blue>	if (sp->role.level == PG_LEVEL_4K)</blue>
		return false;

<blue>	atomic_inc(&sp->write_flooding_count);</blue>
	return atomic_read(&amp;sp-&gt;write_flooding_count) &gt;= 3;
}

/*
 * Misaligned accesses are too much trouble to fix up; also, they usually
 * indicate a page is not used as a page table.
 */
static bool detect_write_misaligned(struct kvm_mmu_page *sp, gpa_t gpa,
				    int bytes)
{
	unsigned offset, pte_size, misaligned;

	pgprintk(&quot;misaligned: gpa %llx bytes %d role %x\n&quot;,
		 gpa, bytes, sp-&gt;role.word);

<blue>	offset = offset_in_page(gpa);</blue>
<blue>	pte_size = sp->role.has_4_byte_gpte ? 4 : 8;</blue>

	/*
	 * Sometimes, the OS only writes the last one bytes to update status
	 * bits, for example, in linux, andb instruction is used in clear_bit().
	 */
<blue>	if (!(offset & (pte_size - 1)) && bytes == 1)</blue>
		return false;

<blue>	misaligned = (offset ^ (offset + bytes - 1)) & ~(pte_size - 1);</blue>
	misaligned |= bytes &lt; 4;

	return misaligned;
}

static u64 *get_written_sptes(struct kvm_mmu_page *sp, gpa_t gpa, int *nspte)
{
	unsigned page_offset, quadrant;
	u64 *spte;
	int level;

	page_offset = offset_in_page(gpa);
<blue>	level = sp->role.level;</blue>
	*nspte = 1;
<blue>	if (sp->role.has_4_byte_gpte) {</blue>
		page_offset &lt;&lt;= 1;	/* 32-&gt;64 */
		/*
		 * A 32-bit pde maps 4MB while the shadow pdes map
		 * only 2MB.  So we need to double the offset again
		 * and zap two pdes instead of one.
		 */
<yellow>		if (level == PT32_ROOT_LEVEL) {</yellow>
			page_offset &amp;= ~7; /* kill rounding error */
			page_offset &lt;&lt;= 1;
			*nspte = 2;
		}
		quadrant = page_offset &gt;&gt; PAGE_SHIFT;
<yellow>		page_offset &= ~PAGE_MASK;</yellow>
<yellow>		if (quadrant != sp->role.quadrant)</yellow>
			return NULL;
	}

<blue>	spte = &sp->spt[page_offset / sizeof(*spte)];</blue>
	return spte;
}

static void kvm_mmu_pte_write(struct kvm_vcpu *vcpu, gpa_t gpa,
			      const u8 *new, int bytes,
			      struct kvm_page_track_notifier_node *node)
<blue>{</blue>
	gfn_t gfn = gpa &gt;&gt; PAGE_SHIFT;
	struct kvm_mmu_page *sp;
<blue>	LIST_HEAD(invalid_list);</blue>
	u64 entry, gentry, *spte;
	int npte;
	bool flush = false;

	/*
	 * If we don&#x27;t have indirect shadow pages, it means no page is
	 * write-protected, so we can exit simply.
	 */
	if (!READ_ONCE(vcpu-&gt;kvm-&gt;arch.indirect_shadow_pages))
		return;

	pgprintk(&quot;%s: gpa %llx bytes %d\n&quot;, __func__, gpa, bytes);

<blue>	write_lock(&vcpu->kvm->mmu_lock);</blue>

<blue>	gentry = mmu_pte_write_fetch_gpte(vcpu, &gpa, &bytes);</blue>

<blue>	++vcpu->kvm->stat.mmu_pte_write;</blue>

<blue>	for_each_gfn_valid_sp_with_gptes(vcpu->kvm, sp, gfn) {</blue>
<blue>		if (detect_write_misaligned(sp, gpa, bytes) ||</blue>
<blue>		      detect_write_flooding(sp)) {</blue>
<blue>			kvm_mmu_prepare_zap_page(vcpu->kvm, sp, &invalid_list);</blue>
			++vcpu-&gt;kvm-&gt;stat.mmu_flooded;
			continue;
		}

<blue>		spte = get_written_sptes(sp, gpa, &npte);</blue>
		if (!spte)
			continue;

<blue>		while (npte--) {</blue>
<blue>			entry = *spte;</blue>
			mmu_page_zap_pte(vcpu-&gt;kvm, sp, spte, NULL);
<blue>			if (gentry && sp->role.level != PG_LEVEL_4K)</blue>
<blue>				++vcpu->kvm->stat.mmu_pde_zapped;</blue>
<blue>			if (is_shadow_present_pte(entry))</blue>
				flush = true;
			++spte;
		}
	}
<blue>	kvm_mmu_remote_flush_or_zap(vcpu->kvm, &invalid_list, flush);</blue>
<blue>	write_unlock(&vcpu->kvm->mmu_lock);</blue>
}

int noinline kvm_mmu_page_fault(struct kvm_vcpu *vcpu, gpa_t cr2_or_gpa, u64 error_code,
		       void *insn, int insn_len)
<blue>{</blue>
	int r, emulation_type = EMULTYPE_PF;
<blue>	bool direct = vcpu->arch.mmu->root_role.direct;</blue>

<yellow>	if (WARN_ON(!VALID_PAGE(vcpu->arch.mmu->root.hpa)))</yellow>
		return RET_PF_RETRY;

	r = RET_PF_INVALID;
<blue>	if (unlikely(error_code & PFERR_RSVD_MASK)) {</blue>
<blue>		r = handle_mmio_page_fault(vcpu, cr2_or_gpa, direct);</blue>
		if (r == RET_PF_EMULATE)
			goto emulate;
	}

	if (r == RET_PF_INVALID) {
<blue>		r = kvm_mmu_do_page_fault(vcpu, cr2_or_gpa,</blue>
					  lower_32_bits(error_code), false);
<blue>		if (KVM_BUG_ON(r == RET_PF_INVALID, vcpu->kvm))</blue>
			return -EIO;
	}

<blue>	if (r < 0)</blue>
		return r;
<blue>	if (r != RET_PF_EMULATE)</blue>
		return 1;

	/*
	 * Before emulating the instruction, check if the error code
	 * was due to a RO violation while translating the guest page.
	 * This can occur when using nested virtualization with nested
	 * paging in both guests. If true, we simply unprotect the page
	 * and resume the guest.
	 */
<blue>	if (vcpu->arch.mmu->root_role.direct &&</blue>
<blue>	    (error_code & PFERR_NESTED_GUEST_PAGE) == PFERR_NESTED_GUEST_PAGE) {</blue>
<yellow>		kvm_mmu_unprotect_page(vcpu->kvm, gpa_to_gfn(cr2_or_gpa));</yellow>
		return 1;
	}

	/*
	 * vcpu-&gt;arch.mmu.page_fault returned RET_PF_EMULATE, but we can still
	 * optimistically try to just unprotect the page and let the processor
	 * re-execute the instruction that caused the page fault.  Do not allow
	 * retrying MMIO emulation, as it&#x27;s not only pointless but could also
	 * cause us to enter an infinite loop because the processor will keep
	 * faulting on the non-existent MMIO address.  Retrying an instruction
	 * from a nested guest is also pointless and dangerous as we are only
	 * explicitly shadowing L1&#x27;s page tables, i.e. unprotecting something
	 * for L1 isn&#x27;t going to magically fix whatever issue cause L2 to fail.
	 */
<blue>	if (!mmio_info_in_cache(vcpu, cr2_or_gpa, direct) && !is_guest_mode(vcpu))</blue>
		emulation_type |= EMULTYPE_ALLOW_RETRY_PF;
emulate:
<blue>	return x86_emulate_instruction(vcpu, cr2_or_gpa, emulation_type, insn,</blue>
				       insn_len);
}
EXPORT_SYMBOL_GPL(kvm_mmu_page_fault);

void kvm_mmu_invalidate_gva(struct kvm_vcpu *vcpu, struct kvm_mmu *mmu,
			    gva_t gva, hpa_t root_hpa)
{
	int i;

	/* It&#x27;s actually a GPA for vcpu-&gt;arch.guest_mmu.  */
<yellow>	if (mmu != &vcpu->arch.guest_mmu) {</yellow>
		/* INVLPG on a non-canonical address is a NOP according to the SDM.  */
<yellow>		if (is_noncanonical_address(gva, vcpu))</yellow>
			return;

<yellow>		static_call(kvm_x86_flush_tlb_gva)(vcpu, gva);</yellow>
	}

<yellow>	if (!mmu->invlpg)</yellow>
		return;

<yellow>	if (root_hpa == INVALID_PAGE) {</yellow>
<yellow>		mmu->invlpg(vcpu, gva, mmu->root.hpa);</yellow>

		/*
		 * INVLPG is required to invalidate any global mappings for the VA,
		 * irrespective of PCID. Since it would take us roughly similar amount
		 * of work to determine whether any of the prev_root mappings of the VA
		 * is marked global, or to just sync it blindly, so we might as well
		 * just always sync it.
		 *
		 * Mappings not reachable via the current cr3 or the prev_roots will be
		 * synced when switching to that cr3, so nothing needs to be done here
		 * for them.
		 */
<yellow>		for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++)</yellow>
<yellow>			if (VALID_PAGE(mmu->prev_roots[i].hpa))</yellow>
<yellow>				mmu->invlpg(vcpu, gva, mmu->prev_roots[i].hpa);</yellow>
	} else {
<yellow>		mmu->invlpg(vcpu, gva, root_hpa);</yellow>
	}
<yellow>}</yellow>

void kvm_mmu_invlpg(struct kvm_vcpu *vcpu, gva_t gva)
{
<yellow>	kvm_mmu_invalidate_gva(vcpu, vcpu->arch.walk_mmu, gva, INVALID_PAGE);</yellow>
	++vcpu-&gt;stat.invlpg;
}
EXPORT_SYMBOL_GPL(kvm_mmu_invlpg);


void kvm_mmu_invpcid_gva(struct kvm_vcpu *vcpu, gva_t gva, unsigned long pcid)
{
<yellow>	struct kvm_mmu *mmu = vcpu->arch.mmu;</yellow>
	bool tlb_flush = false;
	uint i;

<yellow>	if (pcid == kvm_get_active_pcid(vcpu)) {</yellow>
<yellow>		if (mmu->invlpg)</yellow>
<yellow>			mmu->invlpg(vcpu, gva, mmu->root.hpa);</yellow>
		tlb_flush = true;
	}

<yellow>	for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++) {</yellow>
<yellow>		if (VALID_PAGE(mmu->prev_roots[i].hpa) &&</yellow>
<yellow>		    pcid == kvm_get_pcid(vcpu, mmu->prev_roots[i].pgd)) {</yellow>
<yellow>			if (mmu->invlpg)</yellow>
<yellow>				mmu->invlpg(vcpu, gva, mmu->prev_roots[i].hpa);</yellow>
			tlb_flush = true;
		}
	}

<yellow>	if (tlb_flush)</yellow>
<yellow>		static_call(kvm_x86_flush_tlb_gva)(vcpu, gva);</yellow>

<yellow>	++vcpu->stat.invlpg;</yellow>

	/*
	 * Mappings not reachable via the current cr3 or the prev_roots will be
	 * synced when switching to that cr3, so nothing needs to be done here
	 * for them.
	 */
}

<yellow>void kvm_configure_mmu(bool enable_tdp, int tdp_forced_root_level,</yellow>
		       int tdp_max_root_level, int tdp_huge_page_level)
{
<yellow>	tdp_enabled = enable_tdp;</yellow>
	tdp_root_level = tdp_forced_root_level;
	max_tdp_level = tdp_max_root_level;

	/*
	 * max_huge_page_level reflects KVM&#x27;s MMU capabilities irrespective
	 * of kernel support, e.g. KVM may be capable of using 1GB pages when
	 * the kernel is not.  But, KVM never creates a page size greater than
	 * what is used by the kernel for any given HVA, i.e. the kernel&#x27;s
	 * capabilities are ultimately consulted by kvm_mmu_hugepage_adjust().
	 */
<yellow>	if (tdp_enabled)</yellow>
<yellow>		max_huge_page_level = tdp_huge_page_level;</yellow>
<yellow>	else if (boot_cpu_has(X86_FEATURE_GBPAGES))</yellow>
		max_huge_page_level = PG_LEVEL_1G;
	else
		max_huge_page_level = PG_LEVEL_2M;
}
EXPORT_SYMBOL_GPL(kvm_configure_mmu);

/* The return value indicates if tlb flush on all vcpus is needed. */
typedef bool (*slot_level_handler) (struct kvm *kvm,
				    struct kvm_rmap_head *rmap_head,
				    const struct kvm_memory_slot *slot);

/* The caller should hold mmu-lock before calling this function. */
static __always_inline bool
slot_handle_level_range(struct kvm *kvm, const struct kvm_memory_slot *memslot,
			slot_level_handler fn, int start_level, int end_level,
			gfn_t start_gfn, gfn_t end_gfn, bool flush_on_yield,
			bool flush)
{
	struct slot_rmap_walk_iterator iterator;

<yellow>	for_each_slot_rmap_range(memslot, start_level, end_level, start_gfn,</yellow>
			end_gfn, &amp;iterator) {
		if (iterator.rmap)
<yellow>			flush |= fn(kvm, iterator.rmap, memslot);</yellow>

<yellow>		if (need_resched() || rwlock_needbreak(&kvm->mmu_lock)) {</yellow>
<yellow>			if (flush && flush_on_yield) {</yellow>
<yellow>				kvm_flush_remote_tlbs_with_address(kvm,</yellow>
						start_gfn,
						iterator.gfn - start_gfn + 1);
				flush = false;
			}
<yellow>			cond_resched_rwlock_write(&kvm->mmu_lock);</yellow>
		}
	}

	return flush;
}

static __always_inline bool
slot_handle_level(struct kvm *kvm, const struct kvm_memory_slot *memslot,
		  slot_level_handler fn, int start_level, int end_level,
		  bool flush_on_yield)
{
<yellow>	return slot_handle_level_range(kvm, memslot, fn, start_level,</yellow>
			end_level, memslot-&gt;base_gfn,
<yellow>			memslot->base_gfn + memslot->npages - 1,</yellow>
			flush_on_yield, false);
}

static __always_inline bool
slot_handle_level_4k(struct kvm *kvm, const struct kvm_memory_slot *memslot,
		     slot_level_handler fn, bool flush_on_yield)
{
<yellow>	return slot_handle_level(kvm, memslot, fn, PG_LEVEL_4K,</yellow>
				 PG_LEVEL_4K, flush_on_yield);
}

static void free_mmu_pages(struct kvm_mmu *mmu)
{
<yellow>	if (!tdp_enabled && mmu->pae_root)</yellow>
<yellow>		set_memory_encrypted((unsigned long)mmu->pae_root, 1);</yellow>
<yellow>	free_page((unsigned long)mmu->pae_root);</yellow>
	free_page((unsigned long)mmu-&gt;pml4_root);
	free_page((unsigned long)mmu-&gt;pml5_root);
}

static int __kvm_mmu_create(struct kvm_vcpu *vcpu, struct kvm_mmu *mmu)
{
	struct page *page;
	int i;

<blue>	mmu->root.hpa = INVALID_PAGE;</blue>
	mmu-&gt;root.pgd = 0;
	for (i = 0; i &lt; KVM_MMU_NUM_PREV_ROOTS; i++)
		mmu-&gt;prev_roots[i] = KVM_MMU_ROOT_INFO_INVALID;

	/* vcpu-&gt;arch.guest_mmu isn&#x27;t used when !tdp_enabled. */
<blue>	if (!tdp_enabled && mmu == &vcpu->arch.guest_mmu)</blue>
		return 0;

	/*
	 * When using PAE paging, the four PDPTEs are treated as &#x27;root&#x27; pages,
	 * while the PDP table is a per-vCPU construct that&#x27;s allocated at MMU
	 * creation.  When emulating 32-bit mode, cr3 is only 32 bits even on
	 * x86_64.  Therefore we need to allocate the PDP table in the first
	 * 4GB of memory, which happens to fit the DMA32 zone.  TDP paging
	 * generally doesn&#x27;t use PAE paging and can skip allocating the PDP
	 * table.  The main exception, handled here, is SVM&#x27;s 32-bit NPT.  The
	 * other exception is for shadowing L1&#x27;s 32-bit or PAE NPT on 64-bit
	 * KVM; that horror is handled on-demand by mmu_alloc_special_roots().
	 */
<blue>	if (tdp_enabled && kvm_mmu_get_tdp_level(vcpu) > PT32E_ROOT_LEVEL)</blue>
		return 0;

<yellow>	page = alloc_page(GFP_KERNEL_ACCOUNT | __GFP_DMA32);</yellow>
	if (!page)
		return -ENOMEM;

<yellow>	mmu->pae_root = page_address(page);</yellow>

	/*
	 * CR3 is only 32 bits when PAE paging is used, thus it&#x27;s impossible to
	 * get the CPU to treat the PDPTEs as encrypted.  Decrypt the page so
	 * that KVM&#x27;s writes and the CPU&#x27;s reads get along.  Note, this is
	 * only necessary when using shadow paging, as 64-bit NPT can get at
	 * the C-bit even when shadowing 32-bit NPT, and SME isn&#x27;t supported
	 * by 32-bit kernels (when KVM itself uses 32-bit NPT).
	 */
<yellow>	if (!tdp_enabled)</yellow>
<yellow>		set_memory_decrypted((unsigned long)mmu->pae_root, 1);</yellow>
	else
<yellow>		WARN_ON_ONCE(shadow_me_value);</yellow>

	for (i = 0; i &lt; 4; ++i)
<yellow>		mmu->pae_root[i] = INVALID_PAE_ROOT;</yellow>

	return 0;
<blue>}</blue>

int kvm_mmu_create(struct kvm_vcpu *vcpu)
{
	int ret;

<blue>	vcpu->arch.mmu_pte_list_desc_cache.kmem_cache = pte_list_desc_cache;</blue>
	vcpu-&gt;arch.mmu_pte_list_desc_cache.gfp_zero = __GFP_ZERO;

	vcpu-&gt;arch.mmu_page_header_cache.kmem_cache = mmu_page_header_cache;
	vcpu-&gt;arch.mmu_page_header_cache.gfp_zero = __GFP_ZERO;

	vcpu-&gt;arch.mmu_shadow_page_cache.gfp_zero = __GFP_ZERO;

	vcpu-&gt;arch.mmu = &amp;vcpu-&gt;arch.root_mmu;
	vcpu-&gt;arch.walk_mmu = &amp;vcpu-&gt;arch.root_mmu;

	ret = __kvm_mmu_create(vcpu, &amp;vcpu-&gt;arch.guest_mmu);
	if (ret)
		return ret;

<blue>	ret = __kvm_mmu_create(vcpu, &vcpu->arch.root_mmu);</blue>
	if (ret)
		goto fail_allocate_root;

	return ret;
 fail_allocate_root:
<yellow>	free_mmu_pages(&vcpu->arch.guest_mmu);</yellow>
	return ret;
<blue>}</blue>

#define BATCH_ZAP_PAGES	10
static void kvm_zap_obsolete_pages(struct kvm *kvm)
{
	struct kvm_mmu_page *sp, *node;
	int nr_zapped, batch = 0;
	bool unstable;

restart:
<blue>	list_for_each_entry_safe_reverse(sp, node,</blue>
	      &amp;kvm-&gt;arch.active_mmu_pages, link) {
		/*
		 * No obsolete valid page exists before a newly created page
		 * since active_mmu_pages is a FIFO list.
		 */
<yellow>		if (!is_obsolete_sp(kvm, sp))</yellow>
			break;

		/*
		 * Invalid pages should never land back on the list of active
		 * pages.  Skip the bogus page, otherwise we&#x27;ll get stuck in an
		 * infinite loop if the page gets put back on the list (again).
		 */
<yellow>		if (WARN_ON(sp->role.invalid))</yellow>
			continue;

		/*
		 * No need to flush the TLB since we&#x27;re only zapping shadow
		 * pages with an obsolete generation number and all vCPUS have
		 * loaded a new root, i.e. the shadow pages being zapped cannot
		 * be in active use by the guest.
		 */
<yellow>		if (batch >= BATCH_ZAP_PAGES &&</yellow>
<yellow>		    cond_resched_rwlock_write(&kvm->mmu_lock)) {</yellow>
			batch = 0;
			goto restart;
		}

<yellow>		unstable = __kvm_mmu_prepare_zap_page(kvm, sp,</yellow>
				&amp;kvm-&gt;arch.zapped_obsolete_pages, &amp;nr_zapped);
		batch += nr_zapped;

		if (unstable)
			goto restart;
	}

	/*
	 * Kick all vCPUs (via remote TLB flush) before freeing the page tables
	 * to ensure KVM is not in the middle of a lockless shadow page table
	 * walk, which may reference the pages.  The remote TLB flush itself is
	 * not required and is simply a convenient way to kick vCPUs as needed.
	 * KVM performs a local TLB flush when allocating a new root (see
	 * kvm_mmu_load()), and the reload in the caller ensure no vCPUs are
	 * running with an obsolete MMU.
	 */
<blue>	kvm_mmu_commit_zap_page(kvm, &kvm->arch.zapped_obsolete_pages);</blue>
}

/*
 * Fast invalidate all shadow pages and use lock-break technique
 * to zap obsolete pages.
 *
 * It&#x27;s required when memslot is being deleted or VM is being
 * destroyed, in these cases, we should ensure that KVM MMU does
 * not use any resource of the being-deleted slot or all slots
 * after calling the function.
 */
static void kvm_mmu_zap_all_fast(struct kvm *kvm)
<blue>{</blue>
	lockdep_assert_held(&amp;kvm-&gt;slots_lock);

<blue>	write_lock(&kvm->mmu_lock);</blue>
<yellow>	trace_kvm_mmu_zap_all_fast(kvm);</yellow>

	/*
	 * Toggle mmu_valid_gen between &#x27;0&#x27; and &#x27;1&#x27;.  Because slots_lock is
	 * held for the entire duration of zapping obsolete pages, it&#x27;s
	 * impossible for there to be multiple invalid generations associated
	 * with *valid* shadow pages at any given time, i.e. there is exactly
	 * one valid generation and (at most) one invalid generation.
	 */
<blue>	kvm->arch.mmu_valid_gen = kvm->arch.mmu_valid_gen ? 0 : 1;</blue>

	/*
	 * In order to ensure all vCPUs drop their soon-to-be invalid roots,
	 * invalidating TDP MMU roots must be done while holding mmu_lock for
	 * write and in the same critical section as making the reload request,
	 * e.g. before kvm_zap_obsolete_pages() could drop mmu_lock and yield.
	 */
<blue>	if (is_tdp_mmu_enabled(kvm))</blue>
<blue>		kvm_tdp_mmu_invalidate_all_roots(kvm);</blue>

	/*
	 * Notify all vcpus to reload its shadow page table and flush TLB.
	 * Then all vcpus will switch to new shadow page table with the new
	 * mmu_valid_gen.
	 *
	 * Note: we need to do this under the protection of mmu_lock,
	 * otherwise, vcpu would purge shadow page but miss tlb flush.
	 */
<blue>	kvm_make_all_cpus_request(kvm, KVM_REQ_MMU_FREE_OBSOLETE_ROOTS);</blue>

<blue>	kvm_zap_obsolete_pages(kvm);</blue>

<blue>	write_unlock(&kvm->mmu_lock);</blue>

	/*
	 * Zap the invalidated TDP MMU roots, all SPTEs must be dropped before
	 * returning to the caller, e.g. if the zap is in response to a memslot
	 * deletion, mmu_notifier callbacks will be unable to reach the SPTEs
	 * associated with the deleted memslot once the update completes, and
	 * Deferring the zap until the final reference to the root is put would
	 * lead to use-after-free.
	 */
<blue>	if (is_tdp_mmu_enabled(kvm))</blue>
<blue>		kvm_tdp_mmu_zap_invalidated_roots(kvm);</blue>
}

static bool kvm_has_zapped_obsolete_pages(struct kvm *kvm)
{
<yellow>	return unlikely(!list_empty_careful(&kvm->arch.zapped_obsolete_pages));</yellow>
}

static void kvm_mmu_invalidate_zap_pages_in_memslot(struct kvm *kvm,
			struct kvm_memory_slot *slot,
			struct kvm_page_track_notifier_node *node)
{
<blue>	kvm_mmu_zap_all_fast(kvm);</blue>
}

int kvm_mmu_init_vm(struct kvm *kvm)
{
	struct kvm_page_track_notifier_node *node = &amp;kvm-&gt;arch.mmu_sp_tracker;
	int r;

<blue>	INIT_LIST_HEAD(&kvm->arch.active_mmu_pages);</blue>
	INIT_LIST_HEAD(&amp;kvm-&gt;arch.zapped_obsolete_pages);
	INIT_LIST_HEAD(&amp;kvm-&gt;arch.lpage_disallowed_mmu_pages);
	spin_lock_init(&amp;kvm-&gt;arch.mmu_unsync_pages_lock);

	r = kvm_mmu_init_tdp_mmu(kvm);
	if (r &lt; 0)
		return r;

<blue>	node->track_write = kvm_mmu_pte_write;</blue>
	node-&gt;track_flush_slot = kvm_mmu_invalidate_zap_pages_in_memslot;
	kvm_page_track_register_notifier(kvm, node);

	kvm-&gt;arch.split_page_header_cache.kmem_cache = mmu_page_header_cache;
	kvm-&gt;arch.split_page_header_cache.gfp_zero = __GFP_ZERO;

	kvm-&gt;arch.split_shadow_page_cache.gfp_zero = __GFP_ZERO;

	kvm-&gt;arch.split_desc_cache.kmem_cache = pte_list_desc_cache;
	kvm-&gt;arch.split_desc_cache.gfp_zero = __GFP_ZERO;

	return 0;
<blue>}</blue>

static void mmu_free_vm_memory_caches(struct kvm *kvm)
{
	kvm_mmu_free_memory_cache(&amp;kvm-&gt;arch.split_desc_cache);
	kvm_mmu_free_memory_cache(&amp;kvm-&gt;arch.split_page_header_cache);
	kvm_mmu_free_memory_cache(&amp;kvm-&gt;arch.split_shadow_page_cache);
}

void kvm_mmu_uninit_vm(struct kvm *kvm)
{
<yellow>	struct kvm_page_track_notifier_node *node = &kvm->arch.mmu_sp_tracker;</yellow>

	kvm_page_track_unregister_notifier(kvm, node);

	kvm_mmu_uninit_tdp_mmu(kvm);

	mmu_free_vm_memory_caches(kvm);
}

static bool kvm_rmap_zap_gfn_range(struct kvm *kvm, gfn_t gfn_start, gfn_t gfn_end)
<yellow>{</yellow>
	const struct kvm_memory_slot *memslot;
	struct kvm_memslots *slots;
	struct kvm_memslot_iter iter;
	bool flush = false;
	gfn_t start, end;
	int i;

<yellow>	if (!kvm_memslots_have_rmaps(kvm))</yellow>
		return flush;

<yellow>	for (i = 0; i < KVM_ADDRESS_SPACE_NUM; i++) {</yellow>
<yellow>		slots = __kvm_memslots(kvm, i);</yellow>

<yellow>		kvm_for_each_memslot_in_gfn_range(&iter, slots, gfn_start, gfn_end) {</yellow>
			memslot = iter.slot;
<yellow>			start = max(gfn_start, memslot->base_gfn);</yellow>
			end = min(gfn_end, memslot-&gt;base_gfn + memslot-&gt;npages);
<yellow>			if (WARN_ON_ONCE(start >= end))</yellow>
				continue;

<yellow>			flush = slot_handle_level_range(kvm, memslot, __kvm_zap_rmap,</yellow>
							PG_LEVEL_4K, KVM_MAX_HUGEPAGE_LEVEL,
							start, end - 1, true, flush);
		}
	}

	return flush;
}

/*
 * Invalidate (zap) SPTEs that cover GFNs from gfn_start and up to gfn_end
 * (not including it)
 */
void kvm_zap_gfn_range(struct kvm *kvm, gfn_t gfn_start, gfn_t gfn_end)
<yellow>{</yellow>
	bool flush;
	int i;

<yellow>	if (WARN_ON_ONCE(gfn_end <= gfn_start))</yellow>
		return;

<yellow>	write_lock(&kvm->mmu_lock);</yellow>

	kvm_mmu_invalidate_begin(kvm, 0, -1ul);

	flush = kvm_rmap_zap_gfn_range(kvm, gfn_start, gfn_end);

<yellow>	if (is_tdp_mmu_enabled(kvm)) {</yellow>
		for (i = 0; i &lt; KVM_ADDRESS_SPACE_NUM; i++)
<yellow>			flush = kvm_tdp_mmu_zap_leafs(kvm, i, gfn_start,</yellow>
						      gfn_end, true, flush);
	}

<yellow>	if (flush)</yellow>
<yellow>		kvm_flush_remote_tlbs_with_address(kvm, gfn_start,</yellow>
						   gfn_end - gfn_start);

<yellow>	kvm_mmu_invalidate_end(kvm, 0, -1ul);</yellow>

	write_unlock(&amp;kvm-&gt;mmu_lock);
}

static bool slot_rmap_write_protect(struct kvm *kvm,
				    struct kvm_rmap_head *rmap_head,
				    const struct kvm_memory_slot *slot)
{
<yellow>	return rmap_write_protect(rmap_head, false);</yellow>
}

void kvm_mmu_slot_remove_write_access(struct kvm *kvm,
				      const struct kvm_memory_slot *memslot,
				      int start_level)
<yellow>{</yellow>
<yellow>	if (kvm_memslots_have_rmaps(kvm)) {</yellow>
<yellow>		write_lock(&kvm->mmu_lock);</yellow>
<yellow>		slot_handle_level(kvm, memslot, slot_rmap_write_protect,</yellow>
				  start_level, KVM_MAX_HUGEPAGE_LEVEL, false);
<yellow>		write_unlock(&kvm->mmu_lock);</yellow>
	}

<yellow>	if (is_tdp_mmu_enabled(kvm)) {</yellow>
<yellow>		read_lock(&kvm->mmu_lock);</yellow>
		kvm_tdp_mmu_wrprot_slot(kvm, memslot, start_level);
		read_unlock(&amp;kvm-&gt;mmu_lock);
	}
}

static inline bool need_topup(struct kvm_mmu_memory_cache *cache, int min)
{
<yellow>	return kvm_mmu_memory_cache_nr_free_objects(cache) < min;</yellow>
}

static bool need_topup_split_caches_or_resched(struct kvm *kvm)
{
<yellow>	if (need_resched() || rwlock_needbreak(&kvm->mmu_lock))</yellow>
		return true;

	/*
	 * In the worst case, SPLIT_DESC_CACHE_MIN_NR_OBJECTS descriptors are needed
	 * to split a single huge page. Calculating how many are actually needed
	 * is possible but not worth the complexity.
	 */
<yellow>	return need_topup(&kvm->arch.split_desc_cache, SPLIT_DESC_CACHE_MIN_NR_OBJECTS) ||</yellow>
<yellow>	       need_topup(&kvm->arch.split_page_header_cache, 1) ||</yellow>
<yellow>	       need_topup(&kvm->arch.split_shadow_page_cache, 1);</yellow>
}

static int topup_split_caches(struct kvm *kvm)
{
	/*
	 * Allocating rmap list entries when splitting huge pages for nested
	 * MMUs is uncommon as KVM needs to use a list if and only if there is
	 * more than one rmap entry for a gfn, i.e. requires an L1 gfn to be
	 * aliased by multiple L2 gfns and/or from multiple nested roots with
	 * different roles.  Aliasing gfns when using TDP is atypical for VMMs;
	 * a few gfns are often aliased during boot, e.g. when remapping BIOS,
	 * but aliasing rarely occurs post-boot or for many gfns.  If there is
	 * only one rmap entry, rmap-&gt;val points directly at that one entry and
	 * doesn&#x27;t need to allocate a list.  Buffer the cache by the default
	 * capacity so that KVM doesn&#x27;t have to drop mmu_lock to topup if KVM
	 * encounters an aliased gfn or two.
	 */
	const int capacity = SPLIT_DESC_CACHE_MIN_NR_OBJECTS +
			     KVM_ARCH_NR_OBJS_PER_MEMORY_CACHE;
	int r;

	lockdep_assert_held(&amp;kvm-&gt;slots_lock);

	r = __kvm_mmu_topup_memory_cache(&amp;kvm-&gt;arch.split_desc_cache, capacity,
					 SPLIT_DESC_CACHE_MIN_NR_OBJECTS);
	if (r)
		return r;

<yellow>	r = kvm_mmu_topup_memory_cache(&kvm->arch.split_page_header_cache, 1);</yellow>
	if (r)
		return r;

<yellow>	return kvm_mmu_topup_memory_cache(&kvm->arch.split_shadow_page_cache, 1);</yellow>
}

static struct kvm_mmu_page *shadow_mmu_get_sp_for_split(struct kvm *kvm, u64 *huge_sptep)
{
<yellow>	struct kvm_mmu_page *huge_sp = sptep_to_sp(huge_sptep);</yellow>
	struct shadow_page_caches caches = {};
	union kvm_mmu_page_role role;
	unsigned int access;
	gfn_t gfn;

	gfn = kvm_mmu_page_get_gfn(huge_sp, spte_index(huge_sptep));
<yellow>	access = kvm_mmu_page_get_access(huge_sp, spte_index(huge_sptep));</yellow>

	/*
	 * Note, huge page splitting always uses direct shadow pages, regardless
	 * of whether the huge page itself is mapped by a direct or indirect
	 * shadow page, since the huge page region itself is being directly
	 * mapped with smaller pages.
	 */
<yellow>	role = kvm_mmu_child_role(huge_sptep, /*direct=*/true, access);</yellow>

	/* Direct SPs do not require a shadowed_info_cache. */
	caches.page_header_cache = &amp;kvm-&gt;arch.split_page_header_cache;
	caches.shadow_page_cache = &amp;kvm-&gt;arch.split_shadow_page_cache;

	/* Safe to pass NULL for vCPU since requesting a direct SP. */
	return __kvm_mmu_get_shadow_page(kvm, NULL, &amp;caches, gfn, role);
}

static void shadow_mmu_split_huge_page(struct kvm *kvm,
				       const struct kvm_memory_slot *slot,
				       u64 *huge_sptep)

{
	struct kvm_mmu_memory_cache *cache = &amp;kvm-&gt;arch.split_desc_cache;
<yellow>	u64 huge_spte = READ_ONCE(*huge_sptep);</yellow>
	struct kvm_mmu_page *sp;
	bool flush = false;
	u64 *sptep, spte;
	gfn_t gfn;
	int index;

<yellow>	sp = shadow_mmu_get_sp_for_split(kvm, huge_sptep);</yellow>

<yellow>	for (index = 0; index < SPTE_ENT_PER_PAGE; index++) {</yellow>
<yellow>		sptep = &sp->spt[index];</yellow>
		gfn = kvm_mmu_page_get_gfn(sp, index);

		/*
		 * The SP may already have populated SPTEs, e.g. if this huge
		 * page is aliased by multiple sptes with the same access
		 * permissions. These entries are guaranteed to map the same
		 * gfn-to-pfn translation since the SP is direct, so no need to
		 * modify them.
		 *
		 * However, if a given SPTE points to a lower level page table,
		 * that lower level page table may only be partially populated.
		 * Installing such SPTEs would effectively unmap a potion of the
		 * huge page. Unmapping guest memory always requires a TLB flush
		 * since a subsequent operation on the unmapped regions would
		 * fail to detect the need to flush.
		 */
		if (is_shadow_present_pte(*sptep)) {
<yellow>			flush |= !is_last_spte(*sptep, sp->role.level);</yellow>
			continue;
		}

<yellow>		spte = make_huge_page_split_spte(kvm, huge_spte, sp->role, index);</yellow>
<yellow>		mmu_spte_set(sptep, spte);</yellow>
		__rmap_add(kvm, cache, slot, sptep, gfn, sp-&gt;role.access);
	}

<yellow>	__link_shadow_page(kvm, cache, huge_sptep, sp, flush);</yellow>
}

static int shadow_mmu_try_split_huge_page(struct kvm *kvm,
					  const struct kvm_memory_slot *slot,
					  u64 *huge_sptep)
{
<yellow>	struct kvm_mmu_page *huge_sp = sptep_to_sp(huge_sptep);</yellow>
	int level, r = 0;
	gfn_t gfn;
	u64 spte;

	/* Grab information for the tracepoint before dropping the MMU lock. */
	gfn = kvm_mmu_page_get_gfn(huge_sp, spte_index(huge_sptep));
	level = huge_sp-&gt;role.level;
	spte = *huge_sptep;

<yellow>	if (kvm_mmu_available_pages(kvm) <= KVM_MIN_FREE_MMU_PAGES) {</yellow>
		r = -ENOSPC;
		goto out;
	}

<yellow>	if (need_topup_split_caches_or_resched(kvm)) {</yellow>
<yellow>		write_unlock(&kvm->mmu_lock);</yellow>
		cond_resched();
		/*
		 * If the topup succeeds, return -EAGAIN to indicate that the
		 * rmap iterator should be restarted because the MMU lock was
		 * dropped.
		 */
<yellow>		r = topup_split_caches(kvm) ?: -EAGAIN;</yellow>
<yellow>		write_lock(&kvm->mmu_lock);</yellow>
		goto out;
	}

<yellow>	shadow_mmu_split_huge_page(kvm, slot, huge_sptep);</yellow>

out:
<yellow>	trace_kvm_mmu_split_huge_page(gfn, spte, level, r);</yellow>
	return r;
}

static bool shadow_mmu_try_split_huge_pages(struct kvm *kvm,
					    struct kvm_rmap_head *rmap_head,
					    const struct kvm_memory_slot *slot)
{
	struct rmap_iterator iter;
	struct kvm_mmu_page *sp;
	u64 *huge_sptep;
	int r;

restart:
<yellow>	for_each_rmap_spte(rmap_head, &iter, huge_sptep) {</yellow>
<yellow>		sp = sptep_to_sp(huge_sptep);</yellow>

		/* TDP MMU is enabled, so rmap only contains nested MMU SPs. */
<yellow>		if (WARN_ON_ONCE(!sp->role.guest_mode))</yellow>
			continue;

		/* The rmaps should never contain non-leaf SPTEs. */
<yellow>		if (WARN_ON_ONCE(!is_large_pte(*huge_sptep)))</yellow>
			continue;

		/* SPs with level &gt;PG_LEVEL_4K should never by unsync. */
<yellow>		if (WARN_ON_ONCE(sp->unsync))</yellow>
			continue;

		/* Don&#x27;t bother splitting huge pages on invalid SPs. */
<yellow>		if (sp->role.invalid)</yellow>
			continue;

<yellow>		r = shadow_mmu_try_split_huge_page(kvm, slot, huge_sptep);</yellow>

		/*
		 * The split succeeded or needs to be retried because the MMU
		 * lock was dropped. Either way, restart the iterator to get it
		 * back into a consistent state.
		 */
<yellow>		if (!r || r == -EAGAIN)</yellow>
			goto restart;

		/* The split failed and shouldn&#x27;t be retried (e.g. -ENOMEM). */
		break;
	}

	return false;
}

static void kvm_shadow_mmu_try_split_huge_pages(struct kvm *kvm,
						const struct kvm_memory_slot *slot,
						gfn_t start, gfn_t end,
						int target_level)
<yellow>{</yellow>
	int level;

	/*
	 * Split huge pages starting with KVM_MAX_HUGEPAGE_LEVEL and working
	 * down to the target level. This ensures pages are recursively split
	 * all the way to the target level. There&#x27;s no need to split pages
	 * already at the target level.
	 */
<yellow>	for (level = KVM_MAX_HUGEPAGE_LEVEL; level > target_level; level--) {</yellow>
<yellow>		slot_handle_level_range(kvm, slot, shadow_mmu_try_split_huge_pages,</yellow>
					level, level, start, end - 1, true, false);
	}
}

/* Must be called with the mmu_lock held in write-mode. */
<yellow>void kvm_mmu_try_split_huge_pages(struct kvm *kvm,</yellow>
				   const struct kvm_memory_slot *memslot,
				   u64 start, u64 end,
				   int target_level)
{
<yellow>	if (!is_tdp_mmu_enabled(kvm))</yellow>
		return;

<yellow>	if (kvm_memslots_have_rmaps(kvm))</yellow>
<yellow>		kvm_shadow_mmu_try_split_huge_pages(kvm, memslot, start, end, target_level);</yellow>

<yellow>	kvm_tdp_mmu_try_split_huge_pages(kvm, memslot, start, end, target_level, false);</yellow>

	/*
	 * A TLB flush is unnecessary at this point for the same resons as in
	 * kvm_mmu_slot_try_split_huge_pages().
	 */
<yellow>}</yellow>

void kvm_mmu_slot_try_split_huge_pages(struct kvm *kvm,
					const struct kvm_memory_slot *memslot,
					int target_level)
{
<yellow>	u64 start = memslot->base_gfn;</yellow>
<yellow>	u64 end = start + memslot->npages;</yellow>

<yellow>	if (!is_tdp_mmu_enabled(kvm))</yellow>
		return;

<yellow>	if (kvm_memslots_have_rmaps(kvm)) {</yellow>
<yellow>		write_lock(&kvm->mmu_lock);</yellow>
		kvm_shadow_mmu_try_split_huge_pages(kvm, memslot, start, end, target_level);
		write_unlock(&amp;kvm-&gt;mmu_lock);
	}

<yellow>	read_lock(&kvm->mmu_lock);</yellow>
	kvm_tdp_mmu_try_split_huge_pages(kvm, memslot, start, end, target_level, true);
	read_unlock(&amp;kvm-&gt;mmu_lock);

	/*
	 * No TLB flush is necessary here. KVM will flush TLBs after
	 * write-protecting and/or clearing dirty on the newly split SPTEs to
	 * ensure that guest writes are reflected in the dirty log before the
	 * ioctl to enable dirty logging on this memslot completes. Since the
	 * split SPTEs retain the write and dirty bits of the huge SPTE, it is
	 * safe for KVM to decide if a TLB flush is necessary based on the split
	 * SPTEs.
	 */
<yellow>}</yellow>

static bool kvm_mmu_zap_collapsible_spte(struct kvm *kvm,
					 struct kvm_rmap_head *rmap_head,
					 const struct kvm_memory_slot *slot)
{
	u64 *sptep;
	struct rmap_iterator iter;
	int need_tlb_flush = 0;
	struct kvm_mmu_page *sp;

restart:
<yellow>	for_each_rmap_spte(rmap_head, &iter, sptep) {</yellow>
<yellow>		sp = sptep_to_sp(sptep);</yellow>

		/*
		 * We cannot do huge page mapping for indirect shadow pages,
		 * which are found on the last rmap (level = 1) when not using
		 * tdp; such shadow pages are synced with the page table in
		 * the guest, and the guest page table is using 4K page size
		 * mapping if the indirect sp has level = 1.
		 */
		if (sp-&gt;role.direct &amp;&amp;
<yellow>		    sp->role.level < kvm_mmu_max_mapping_level(kvm, slot, sp->gfn,</yellow>
							       PG_LEVEL_NUM)) {
<yellow>			kvm_zap_one_rmap_spte(kvm, rmap_head, sptep);</yellow>

			if (kvm_available_flush_tlb_with_range())
<yellow>				kvm_flush_remote_tlbs_with_address(kvm, sp->gfn,</yellow>
<yellow>					KVM_PAGES_PER_HPAGE(sp->role.level));</yellow>
			else
				need_tlb_flush = 1;

			goto restart;
		}
	}

<yellow>	return need_tlb_flush;</yellow>
}

static void kvm_rmap_zap_collapsible_sptes(struct kvm *kvm,
					   const struct kvm_memory_slot *slot)
<yellow>{</yellow>
	/*
	 * Note, use KVM_MAX_HUGEPAGE_LEVEL - 1 since there&#x27;s no need to zap
	 * pages that are already mapped at the maximum hugepage level.
	 */
<yellow>	if (slot_handle_level(kvm, slot, kvm_mmu_zap_collapsible_spte,</yellow>
			      PG_LEVEL_4K, KVM_MAX_HUGEPAGE_LEVEL - 1, true))
<yellow>		kvm_arch_flush_remote_tlbs_memslot(kvm, slot);</yellow>
<yellow>}</yellow>

void kvm_mmu_zap_collapsible_sptes(struct kvm *kvm,
				   const struct kvm_memory_slot *slot)
{
<yellow>	if (kvm_memslots_have_rmaps(kvm)) {</yellow>
<yellow>		write_lock(&kvm->mmu_lock);</yellow>
		kvm_rmap_zap_collapsible_sptes(kvm, slot);
		write_unlock(&amp;kvm-&gt;mmu_lock);
	}

<yellow>	if (is_tdp_mmu_enabled(kvm)) {</yellow>
<yellow>		read_lock(&kvm->mmu_lock);</yellow>
		kvm_tdp_mmu_zap_collapsible_sptes(kvm, slot);
		read_unlock(&amp;kvm-&gt;mmu_lock);
	}
<yellow>}</yellow>

void kvm_arch_flush_remote_tlbs_memslot(struct kvm *kvm,
					const struct kvm_memory_slot *memslot)
<yellow>{</yellow>
	/*
	 * All current use cases for flushing the TLBs for a specific memslot
	 * related to dirty logging, and many do the TLB flush out of mmu_lock.
	 * The interaction between the various operations on memslot must be
	 * serialized by slots_locks to ensure the TLB flush from one operation
	 * is observed by any other operation on the same memslot.
	 */
	lockdep_assert_held(&amp;kvm-&gt;slots_lock);
<yellow>	kvm_flush_remote_tlbs_with_address(kvm, memslot->base_gfn,</yellow>
<yellow>					   memslot->npages);</yellow>
}

void kvm_mmu_slot_leaf_clear_dirty(struct kvm *kvm,
				   const struct kvm_memory_slot *memslot)
<yellow>{</yellow>
<yellow>	if (kvm_memslots_have_rmaps(kvm)) {</yellow>
<yellow>		write_lock(&kvm->mmu_lock);</yellow>
		/*
		 * Clear dirty bits only on 4k SPTEs since the legacy MMU only
		 * support dirty logging at a 4k granularity.
		 */
<yellow>		slot_handle_level_4k(kvm, memslot, __rmap_clear_dirty, false);</yellow>
<yellow>		write_unlock(&kvm->mmu_lock);</yellow>
	}

<yellow>	if (is_tdp_mmu_enabled(kvm)) {</yellow>
<yellow>		read_lock(&kvm->mmu_lock);</yellow>
		kvm_tdp_mmu_clear_dirty_slot(kvm, memslot);
		read_unlock(&amp;kvm-&gt;mmu_lock);
	}

	/*
	 * The caller will flush the TLBs after this function returns.
	 *
	 * It&#x27;s also safe to flush TLBs out of mmu lock here as currently this
	 * function is only used for dirty logging, in which case flushing TLB
	 * out of mmu lock also guarantees no dirty pages will be lost in
	 * dirty_bitmap.
	 */
}

void kvm_mmu_zap_all(struct kvm *kvm)
{
	struct kvm_mmu_page *sp, *node;
<yellow>	LIST_HEAD(invalid_list);</yellow>
	int ign;

	write_lock(&amp;kvm-&gt;mmu_lock);
restart:
<yellow>	list_for_each_entry_safe(sp, node, &kvm->arch.active_mmu_pages, link) {</yellow>
<yellow>		if (WARN_ON(sp->role.invalid))</yellow>
			continue;
<yellow>		if (__kvm_mmu_prepare_zap_page(kvm, sp, &invalid_list, &ign))</yellow>
			goto restart;
<yellow>		if (cond_resched_rwlock_write(&kvm->mmu_lock))</yellow>
			goto restart;
	}

<yellow>	kvm_mmu_commit_zap_page(kvm, &invalid_list);</yellow>

<yellow>	if (is_tdp_mmu_enabled(kvm))</yellow>
<yellow>		kvm_tdp_mmu_zap_all(kvm);</yellow>

<yellow>	write_unlock(&kvm->mmu_lock);</yellow>
}

void kvm_mmu_invalidate_mmio_sptes(struct kvm *kvm, u64 gen)
{
<blue>	WARN_ON(gen & KVM_MEMSLOT_GEN_UPDATE_IN_PROGRESS);</blue>

	gen &amp;= MMIO_SPTE_GEN_MASK;

	/*
	 * Generation numbers are incremented in multiples of the number of
	 * address spaces in order to provide unique generations across all
	 * address spaces.  Strip what is effectively the address space
	 * modifier prior to checking for a wrap of the MMIO generation so
	 * that a wrap in any address space is detected.
	 */
<blue>	gen &= ~((u64)KVM_ADDRESS_SPACE_NUM - 1);</blue>

	/*
	 * The very rare case: if the MMIO generation number has wrapped,
	 * zap all shadow pages.
	 */
	if (unlikely(gen == 0)) {
<yellow>		kvm_debug_ratelimited("kvm: zapping shadow pages for mmio generation wraparound\n");</yellow>
<yellow>		kvm_mmu_zap_all_fast(kvm);</yellow>
	}
<blue>}</blue>

static unsigned long
mmu_shrink_scan(struct shrinker *shrink, struct shrink_control *sc)
{
	struct kvm *kvm;
<yellow>	int nr_to_scan = sc->nr_to_scan;</yellow>
	unsigned long freed = 0;

	mutex_lock(&amp;kvm_lock);

<yellow>	list_for_each_entry(kvm, &vm_list, vm_list) {</yellow>
		int idx;
<yellow>		LIST_HEAD(invalid_list);</yellow>

		/*
		 * Never scan more than sc-&gt;nr_to_scan VM instances.
		 * Will not hit this condition practically since we do not try
		 * to shrink more than one VM and it is very unlikely to see
		 * !n_used_mmu_pages so many times.
		 */
		if (!nr_to_scan--)
			break;
		/*
		 * n_used_mmu_pages is accessed without holding kvm-&gt;mmu_lock
		 * here. We may skip a VM instance errorneosly, but we do not
		 * want to shrink a VM that only started to populate its MMU
		 * anyway.
		 */
<yellow>		if (!kvm->arch.n_used_mmu_pages &&</yellow>
<yellow>		    !kvm_has_zapped_obsolete_pages(kvm))</yellow>
			continue;

<yellow>		idx = srcu_read_lock(&kvm->srcu);</yellow>
		write_lock(&amp;kvm-&gt;mmu_lock);

<yellow>		if (kvm_has_zapped_obsolete_pages(kvm)) {</yellow>
<yellow>			kvm_mmu_commit_zap_page(kvm,</yellow>
			      &amp;kvm-&gt;arch.zapped_obsolete_pages);
			goto unlock;
		}

<yellow>		freed = kvm_mmu_zap_oldest_mmu_pages(kvm, sc->nr_to_scan);</yellow>

unlock:
		write_unlock(&amp;kvm-&gt;mmu_lock);
<yellow>		srcu_read_unlock(&kvm->srcu, idx);</yellow>

		/*
		 * unfair on small ones
		 * per-vm shrinkers cry out
		 * sadness comes quickly
		 */
		list_move_tail(&amp;kvm-&gt;vm_list, &amp;vm_list);
		break;
	}

<yellow>	mutex_unlock(&kvm_lock);</yellow>
	return freed;
}

static unsigned long
mmu_shrink_count(struct shrinker *shrink, struct shrink_control *sc)
{
<blue>	return percpu_counter_read_positive(&kvm_total_used_mmu_pages);</blue>
}

static struct shrinker mmu_shrinker = {
	.count_objects = mmu_shrink_count,
	.scan_objects = mmu_shrink_scan,
	.seeks = DEFAULT_SEEKS * 10,
};

static void mmu_destroy_caches(void)
{
<yellow>	kmem_cache_destroy(pte_list_desc_cache);</yellow>
	kmem_cache_destroy(mmu_page_header_cache);
}

static bool get_nx_auto_mode(void)
{
	/* Return true when CPU has the bug, and mitigations are ON */
<yellow>	return boot_cpu_has_bug(X86_BUG_ITLB_MULTIHIT) && !cpu_mitigations_off();</yellow>
}

static void __set_nx_huge_pages(bool val)
{
<yellow>	nx_huge_pages = itlb_multihit_kvm_mitigation = val;</yellow>
}

static int set_nx_huge_pages(const char *val, const struct kernel_param *kp)
<yellow>{</yellow>
<yellow>	bool old_val = nx_huge_pages;</yellow>
	bool new_val;

	/* In &quot;auto&quot; mode deploy workaround only if CPU has the bug. */
	if (sysfs_streq(val, &quot;off&quot;))
<yellow>		new_val = 0;</yellow>
<yellow>	else if (sysfs_streq(val, "force"))</yellow>
<yellow>		new_val = 1;</yellow>
<yellow>	else if (sysfs_streq(val, "auto"))</yellow>
<yellow>		new_val = get_nx_auto_mode();</yellow>
<yellow>	else if (strtobool(val, &new_val) < 0)</yellow>
		return -EINVAL;

<yellow>	__set_nx_huge_pages(new_val);</yellow>

<yellow>	if (new_val != old_val) {</yellow>
		struct kvm *kvm;

<yellow>		mutex_lock(&kvm_lock);</yellow>

		list_for_each_entry(kvm, &amp;vm_list, vm_list) {
<yellow>			mutex_lock(&kvm->slots_lock);</yellow>
			kvm_mmu_zap_all_fast(kvm);
			mutex_unlock(&amp;kvm-&gt;slots_lock);

			wake_up_process(kvm-&gt;arch.nx_lpage_recovery_thread);
		}
<yellow>		mutex_unlock(&kvm_lock);</yellow>
	}

	return 0;
}

/*
 * nx_huge_pages needs to be resolved to true/false when kvm.ko is loaded, as
 * its default value of -1 is technically undefined behavior for a boolean.
 * Forward the module init call to SPTE code so that it too can handle module
 * params that need to be resolved/snapshot.
 */
void __init kvm_mmu_x86_module_init(void)
{
	if (nx_huge_pages == -1)
		__set_nx_huge_pages(get_nx_auto_mode());

	kvm_mmu_spte_module_init();
}

/*
 * The bulk of the MMU initialization is deferred until the vendor module is
 * loaded as many of the masks/values may be modified by VMX or SVM, i.e. need
 * to be reset when a potentially different vendor module is loaded.
 */
int kvm_mmu_vendor_module_init(void)
{
	int ret = -ENOMEM;

	/*
	 * MMU roles use union aliasing which is, generally speaking, an
	 * undefined behavior. However, we supposedly know how compilers behave
	 * and the current status quo is unlikely to change. Guardians below are
	 * supposed to let us know if the assumption becomes false.
	 */
	BUILD_BUG_ON(sizeof(union kvm_mmu_page_role) != sizeof(u32));
	BUILD_BUG_ON(sizeof(union kvm_mmu_extended_role) != sizeof(u32));
	BUILD_BUG_ON(sizeof(union kvm_cpu_role) != sizeof(u64));

<yellow>	kvm_mmu_reset_all_pte_masks();</yellow>

	pte_list_desc_cache = kmem_cache_create(&quot;pte_list_desc&quot;,
					    sizeof(struct pte_list_desc),
					    0, SLAB_ACCOUNT, NULL);
	if (!pte_list_desc_cache)
		goto out;

<yellow>	mmu_page_header_cache = kmem_cache_create("kvm_mmu_page_header",</yellow>
						  sizeof(struct kvm_mmu_page),
						  0, SLAB_ACCOUNT, NULL);
	if (!mmu_page_header_cache)
		goto out;

<yellow>	if (percpu_counter_init(&kvm_total_used_mmu_pages, 0, GFP_KERNEL))</yellow>
		goto out;

<yellow>	ret = register_shrinker(&mmu_shrinker, "x86-mmu");</yellow>
	if (ret)
		goto out_shrinker;

	return 0;

out_shrinker:
<yellow>	percpu_counter_destroy(&kvm_total_used_mmu_pages);</yellow>
out:
<yellow>	mmu_destroy_caches();</yellow>
	return ret;
<yellow>}</yellow>

void kvm_mmu_destroy(struct kvm_vcpu *vcpu)
{
<yellow>	kvm_mmu_unload(vcpu);</yellow>
	free_mmu_pages(&amp;vcpu-&gt;arch.root_mmu);
	free_mmu_pages(&amp;vcpu-&gt;arch.guest_mmu);
	mmu_free_memory_caches(vcpu);
}

void kvm_mmu_vendor_module_exit(void)
{
<yellow>	mmu_destroy_caches();</yellow>
	percpu_counter_destroy(&amp;kvm_total_used_mmu_pages);
	unregister_shrinker(&amp;mmu_shrinker);
}

/*
 * Calculate the effective recovery period, accounting for &#x27;0&#x27; meaning &quot;let KVM
 * select a halving time of 1 hour&quot;.  Returns true if recovery is enabled.
 */
static bool calc_nx_huge_pages_recovery_period(uint *period)
{
	/*
	 * Use READ_ONCE to get the params, this may be called outside of the
	 * param setters, e.g. by the kthread to compute its next timeout.
	 */
<yellow>	bool enabled = READ_ONCE(nx_huge_pages);</yellow>
	uint ratio = READ_ONCE(nx_huge_pages_recovery_ratio);

<yellow>	if (!enabled || !ratio)</yellow>
		return false;

<yellow>	*period = READ_ONCE(nx_huge_pages_recovery_period_ms);</yellow>
	if (!*period) {
		/* Make sure the period is not less than one second.  */
<yellow>		ratio = min(ratio, 3600u);</yellow>
		*period = 60 * 60 * 1000 / ratio;
	}
	return true;
}

<yellow>static int set_nx_huge_pages_recovery_param(const char *val, const struct kernel_param *kp)</yellow>
{
	bool was_recovery_enabled, is_recovery_enabled;
	uint old_period, new_period;
	int err;

<yellow>	was_recovery_enabled = calc_nx_huge_pages_recovery_period(&old_period);</yellow>

<yellow>	err = param_set_uint(val, kp);</yellow>
	if (err)
		return err;

<yellow>	is_recovery_enabled = calc_nx_huge_pages_recovery_period(&new_period);</yellow>

<yellow>	if (is_recovery_enabled &&</yellow>
<yellow>	    (!was_recovery_enabled || old_period > new_period)) {</yellow>
		struct kvm *kvm;

<yellow>		mutex_lock(&kvm_lock);</yellow>

		list_for_each_entry(kvm, &amp;vm_list, vm_list)
<yellow>			wake_up_process(kvm->arch.nx_lpage_recovery_thread);</yellow>

<yellow>		mutex_unlock(&kvm_lock);</yellow>
	}

	return err;
<yellow>}</yellow>

static void kvm_recover_nx_lpages(struct kvm *kvm)
{
<yellow>	unsigned long nx_lpage_splits = kvm->stat.nx_lpage_splits;</yellow>
	int rcu_idx;
	struct kvm_mmu_page *sp;
	unsigned int ratio;
	LIST_HEAD(invalid_list);
	bool flush = false;
	ulong to_zap;

	rcu_idx = srcu_read_lock(&amp;kvm-&gt;srcu);
	write_lock(&amp;kvm-&gt;mmu_lock);

	/*
	 * Zapping TDP MMU shadow pages, including the remote TLB flush, must
	 * be done under RCU protection, because the pages are freed via RCU
	 * callback.
	 */
	rcu_read_lock();

	ratio = READ_ONCE(nx_huge_pages_recovery_ratio);
<yellow>	to_zap = ratio ? DIV_ROUND_UP(nx_lpage_splits, ratio) : 0;</yellow>
<yellow>	for ( ; to_zap; --to_zap) {</yellow>
<yellow>		if (list_empty(&kvm->arch.lpage_disallowed_mmu_pages))</yellow>
			break;

		/*
		 * We use a separate list instead of just using active_mmu_pages
		 * because the number of lpage_disallowed pages is expected to
		 * be relatively small compared to the total.
		 */
<yellow>		sp = list_first_entry(&kvm->arch.lpage_disallowed_mmu_pages,</yellow>
				      struct kvm_mmu_page,
				      lpage_disallowed_link);
<yellow>		WARN_ON_ONCE(!sp->lpage_disallowed);</yellow>
<yellow>		if (is_tdp_mmu_page(sp)) {</yellow>
<yellow>			flush |= kvm_tdp_mmu_zap_sp(kvm, sp);</yellow>
		} else {
<yellow>			kvm_mmu_prepare_zap_page(kvm, sp, &invalid_list);</yellow>
<yellow>			WARN_ON_ONCE(sp->lpage_disallowed);</yellow>
		}

<yellow>		if (need_resched() || rwlock_needbreak(&kvm->mmu_lock)) {</yellow>
<yellow>			kvm_mmu_remote_flush_or_zap(kvm, &invalid_list, flush);</yellow>
<yellow>			rcu_read_unlock();</yellow>

			cond_resched_rwlock_write(&amp;kvm-&gt;mmu_lock);
			flush = false;

			rcu_read_lock();
		}
	}
<yellow>	kvm_mmu_remote_flush_or_zap(kvm, &invalid_list, flush);</yellow>

<yellow>	rcu_read_unlock();</yellow>

	write_unlock(&amp;kvm-&gt;mmu_lock);
<yellow>	srcu_read_unlock(&kvm->srcu, rcu_idx);</yellow>
}

static long get_nx_lpage_recovery_timeout(u64 start_time)
{
	bool enabled;
	uint period;

<yellow>	enabled = calc_nx_huge_pages_recovery_period(&period);</yellow>

<yellow>	return enabled ? start_time + msecs_to_jiffies(period) - get_jiffies_64()</yellow>
		       : MAX_SCHEDULE_TIMEOUT;
}

static int kvm_nx_lpage_recovery_worker(struct kvm *kvm, uintptr_t data)
<yellow>{</yellow>
	u64 start_time;
	long remaining_time;

	while (true) {
<yellow>		start_time = get_jiffies_64();</yellow>
<yellow>		remaining_time = get_nx_lpage_recovery_timeout(start_time);</yellow>

<yellow>		set_current_state(TASK_INTERRUPTIBLE);</yellow>
<yellow>		while (!kthread_should_stop() && remaining_time > 0) {</yellow>
<yellow>			schedule_timeout(remaining_time);</yellow>
<yellow>			remaining_time = get_nx_lpage_recovery_timeout(start_time);</yellow>
<yellow>			set_current_state(TASK_INTERRUPTIBLE);</yellow>
		}

<yellow>		set_current_state(TASK_RUNNING);</yellow>

		if (kthread_should_stop())
			return 0;

<yellow>		kvm_recover_nx_lpages(kvm);</yellow>
	}
}

int kvm_mmu_post_init_vm(struct kvm *kvm)
{
	int err;

<blue>	err = kvm_vm_create_worker_thread(kvm, kvm_nx_lpage_recovery_worker, 0,</blue>
					  &quot;kvm-nx-lpage-recovery&quot;,
					  &amp;kvm-&gt;arch.nx_lpage_recovery_thread);
	if (!err)
<blue>		kthread_unpark(kvm->arch.nx_lpage_recovery_thread);</blue>

	return err;
<blue>}</blue>

void kvm_mmu_pre_destroy_vm(struct kvm *kvm)
{
<yellow>	if (kvm->arch.nx_lpage_recovery_thread)</yellow>
<yellow>		kthread_stop(kvm->arch.nx_lpage_recovery_thread);</yellow>
<yellow>}</yellow>


</code></pre></td></tr></table>
</body>
</html>
